<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="å¤–æ¥ãƒ¯ãƒ³ãƒšãƒ¼ã‚¸">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<title>å¤–æ¥ãƒ¯ãƒ³ãƒšãƒ¼ã‚¸ iPhoneç‰ˆ v2.4</title>
<style>
:root {
  --ink: #111827;
  --muted: #6b7280;
  --bg: #f3f4f6;
  --card: #fff;
  --line: #e5e7eb;
  --brand: #2563eb;
  --brand-light: #dbeafe;
  --danger: #ef4444;
  --success: #22c55e;
  --tab-height: 56px;
  --header-height: 48px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-top: env(safe-area-inset-top, 0px);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { 
  height: 100%; 
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", sans-serif;
  background: var(--bg);
  color: var(--ink);
  font-size: 15px;
  -webkit-text-size-adjust: 100%;
}

header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: calc(var(--header-height) + var(--safe-top));
  padding-top: var(--safe-top);
  background: var(--brand);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-left: 16px;
  padding-right: 16px;
  z-index: 100;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
header h1 { font-size: 17px; font-weight: 600; }
header .version { font-size: 11px; opacity: 0.8; }

main {
  position: fixed;
  top: calc(var(--header-height) + var(--safe-top));
  bottom: calc(var(--tab-height) + var(--safe-bottom));
  left: 0;
  right: 0;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
}

.tab-content {
  display: none;
  padding: 12px;
  padding-bottom: 24px;
}
.tab-content.active { display: block; }

.card {
  background: var(--card);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.card h2 {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--ink);
  display: flex;
  align-items: center;
  gap: 6px;
}
.card h3 {
  font-size: 13px;
  font-weight: 600;
  margin: 16px 0 8px;
  color: #374151;
}

label {
  display: block;
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 4px;
  font-weight: 500;
}
input, textarea, select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--line);
  border-radius: 8px;
  font-size: 15px;
  background: #fff;
  -webkit-appearance: none;
  appearance: none;
}
input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 3px var(--brand-light);
}
textarea { resize: vertical; min-height: 80px; }
select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 32px;
}

.form-row { margin-bottom: 12px; }
.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.form-grid-3 {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}
.form-grid-4 {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}

.vital-grid {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 8px 12px;
  align-items: center;
}
.vital-grid b { font-size: 13px; color: #374151; }
.vital-grid select { padding: 8px; }
.vital-row {
  display: flex;
  align-items: center;
  gap: 4px;
}
.vital-row select { width: auto; min-width: 70px; }
.vital-row .unit { font-size: 12px; color: var(--muted); }

.chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.chip {
  display: inline-flex;
  align-items: center;
  padding: 6px 12px;
  border: 1px solid var(--line);
  border-radius: 20px;
  font-size: 13px;
  background: #f9fafb;
  cursor: pointer;
  user-select: none;
  transition: all 0.15s;
}
.chip[data-state="on"] { background: #eef2ff; border-color: #c7d2fe; }
.chip[data-state="+"] { background: #fee2e2; border-color: #fecaca; }
.chip[data-state="-"] { background: #dcfce7; border-color: #bbf7d0; }

.exam-tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 4px;
}
.exam-tab {
  flex-shrink: 0;
  padding: 8px 14px;
  border: 1px solid var(--line);
  border-radius: 20px;
  font-size: 13px;
  background: #f9fafb;
  cursor: pointer;
}
.exam-tab.active {
  background: var(--brand);
  color: #fff;
  border-color: var(--brand);
}
.exam-pane { display: none; }
.exam-pane.active { display: block; }

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
  min-height: 44px;
}
.btn-primary { background: var(--brand); color: #fff; }
.btn-primary:active { background: #1d4ed8; }
.btn-outline { background: #fff; color: var(--ink); border: 1px solid var(--line); }
.btn-outline:active { background: #f3f4f6; }
.btn-danger { background: #fff; color: var(--danger); border: 1px solid var(--danger); }
.btn-success { background: var(--success); color: #fff; }
.btn-sm { padding: 6px 10px; font-size: 12px; min-height: 32px; }
.btn-block { width: 100%; }

.btn-group {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.lab-pills {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 8px;
}
.lab-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  background: #fff;
  border: 1px solid var(--line);
  border-radius: 20px;
}
.lab-pill label { margin: 0; font-size: 12px; color: var(--ink); font-weight: 500; }
.lab-pill input {
  width: 70px;
  padding: 4px 8px;
  font-size: 13px;
  text-align: center;
}
.lab-pill .unit { font-size: 11px; color: var(--muted); }
.lab-pill .del {
  width: 20px;
  height: 20px;
  border: none;
  background: #f3f4f6;
  border-radius: 50%;
  font-size: 14px;
  color: var(--muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.problem-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 12px;
}
.problem-tag {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background: var(--brand-light);
  border: 1px solid #bfdbfe;
  border-radius: 8px;
  font-size: 13px;
}
.problem-tag .num { font-weight: 600; color: var(--brand); }
.problem-tag .del {
  width: 18px;
  height: 18px;
  border: none;
  background: transparent;
  color: var(--muted);
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.problem-item {
  margin-bottom: 16px;
  padding: 12px;
  background: #f9fafb;
  border-radius: 8px;
}
.problem-item .header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.problem-item .header .num {
  font-weight: 600;
  color: var(--brand);
  font-size: 14px;
}
.problem-item .header span { font-size: 11px; color: var(--muted); }
.problem-item input { margin-bottom: 8px; }
.problem-item textarea { min-height: 60px; }

.fold {
  border: 1px solid var(--line);
  border-radius: 8px;
  margin-top: 12px;
  overflow: hidden;
}
.fold summary {
  padding: 12px;
  background: #f9fafb;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.fold summary .badge {
  background: var(--brand-light);
  color: var(--brand);
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
}
.fold-body { padding: 12px; }
.nih-row {
  margin-bottom: 12px;
}
.nih-row b { font-size: 13px; display: block; margin-bottom: 4px; }
.nih-row .hint { font-size: 11px; color: var(--muted); margin-bottom: 6px; }
.nih-row select { width: 100%; }

.culture-entry {
  padding: 12px;
  background: #f9fafb;
  border-radius: 8px;
  margin-bottom: 8px;
}
.culture-entry .form-grid { margin-bottom: 8px; }

.check-line {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 8px;
}
.check-line label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  color: var(--ink);
}
.check-line input[type="checkbox"] {
  width: 20px;
  height: 20px;
}

.output-box {
  background: #fafafa;
  border: 1px dashed var(--line);
  border-radius: 8px;
  padding: 12px;
  white-space: pre-wrap;
  font-size: 13px;
  line-height: 1.6;
  min-height: 300px;
  max-height: 60vh;
  overflow-y: auto;
}

.ecg-detail {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 10px;
}

.toggle-group {
  display: flex;
  border: 1px solid var(--line);
  border-radius: 8px;
  overflow: hidden;
}
.toggle-group .toggle-btn {
  flex: 1;
  padding: 12px;
  text-align: center;
  background: #f9fafb;
  border: none;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
}
.toggle-group .toggle-btn.active {
  background: var(--brand);
  color: #fff;
}
.toggle-group .toggle-btn:not(:last-child) {
  border-right: 1px solid var(--line);
}

.plan-section {
  display: none;
  margin-top: 12px;
}
.plan-section.active {
  display: block;
}

.tab-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: calc(var(--tab-height) + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  background: #fff;
  border-top: 1px solid var(--line);
  display: flex;
  z-index: 100;
}
.tab-bar-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px;
  color: var(--muted);
  font-size: 10px;
  cursor: pointer;
  transition: color 0.15s;
  padding: 4px;
}
.tab-bar-item.active { color: var(--brand); }
.tab-bar-item svg {
  width: 24px;
  height: 24px;
}
.tab-bar-item span { font-weight: 500; }

.small { font-size: 12px; color: var(--muted); }
.mt-2 { margin-top: 8px; }
.mt-3 { margin-top: 12px; }
.mb-2 { margin-bottom: 8px; }
.text-center { text-align: center; }
.badge {
  display: inline-block;
  padding: 2px 8px;
  background: #f3f4f6;
  border-radius: 12px;
  font-size: 12px;
}

@media print {
  header, .tab-bar { display: none !important; }
  main {
    position: static;
    overflow: visible;
  }
  .tab-content { display: none !important; }
  .tab-content[data-tab="output"] { display: block !important; }
  .output-box { border: none; max-height: none; }
  .btn { display: none; }
}
</style>
</head>
<body>

<header>
  <div>
    <h1>å¤–æ¥ãƒ¯ãƒ³ãƒšãƒ¼ã‚¸</h1>
    <div class="version">iPhoneç‰ˆ v2.1.0</div>
  </div>
  <div style="display:flex;gap:8px">
    <button class="btn btn-sm" id="btnRecords" style="background:rgba(255,255,255,0.2);color:#fff;border:1px solid rgba(255,255,255,0.5)">ğŸ“‚ è¨˜éŒ²</button>
    <button class="btn btn-sm" id="btnReset" style="background:rgba(255,255,255,0.2);color:#fff;border:1px solid rgba(255,255,255,0.5)">ğŸ—‘ åˆæœŸåŒ–</button>
  </div>
</header>

<main>
  <div class="tab-content active" data-tab="history">
    <div class="card">
      <h2>ğŸ“‹ åŸºæœ¬æƒ…å ±ãƒ»ç—…æ­´</h2>
      <div class="form-row">
        <label>ä¸»è¨´</label>
        <input id="cc" placeholder="ä¾‹: èƒ¸ç—›ã€ç™ºç†±">
      </div>
      <div class="form-row">
        <label>å—è¨ºæ—¥</label>
        <input type="date" id="visitDate">
      </div>
      <div class="form-row">
        <label>ç¾ç—…æ­´</label>
        <textarea id="hpi" rows="4" placeholder="ç™ºç—‡ã‹ã‚‰ã®çµŒéã‚’è¨˜è¼‰"></textarea>
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>æ—¢å¾€æ­´</label>
          <textarea id="pmh" rows="3" placeholder="é«˜è¡€åœ§ã€DMç­‰"></textarea>
        </div>
        <div class="form-row">
          <label>å¸¸ç”¨è–¬</label>
          <textarea id="meds" rows="3" placeholder="ã‚¢ãƒ ãƒ­ã‚¸ãƒ”ãƒ³5mgç­‰"></textarea>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
          <input id="allergy" placeholder="è–¬å‰¤ãƒ»é£Ÿç‰©">
        </div>
        <div class="form-row">
          <label>å®¶æ—æ­´</label>
          <input id="familyHx" placeholder="çˆ¶:é«˜è¡€åœ§ã€æ¯:DMç­‰">
        </div>
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>å—œå¥½æ­´</label>
          <input id="habits" placeholder="å–«ç…™20æœ¬/æ—¥Ã—20å¹´ç­‰">
        </div>
        <div class="form-row">
          <label>ç”Ÿæ´»æ­´</label>
          <input id="social" placeholder="ç‹¬å±…ã€ADLè‡ªç«‹ç­‰">
        </div>
      </div>
      <div class="form-row">
        <label>ã‚­ãƒ¼ãƒ‘ãƒ¼ã‚½ãƒ³</label>
        <input id="keyPerson" placeholder="é•·ç”·ã€å¦»ç­‰ï¼ˆé€£çµ¡å…ˆãƒ»é–¢ä¿‚æ€§ï¼‰">
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content" data-tab="exam">
    <div class="card">
      <h2>ğŸ’“ ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</h2>
      
      <div style="border:1px solid #c4b5fd;border-radius:10px;padding:12px;margin-bottom:12px;background:#faf5ff">
        <button class="btn btn-sm btn-primary" id="vitalImageBtn" style="width:100%">
          ğŸ“· ãƒ¢ãƒ‹ã‚¿ãƒ¼ç”»é¢ã‚’èª­ã¿å–ã‚‹
        </button>
        <div class="small mt-1" style="color:#6b7280;font-size:11px;text-align:center;">
          HRãƒ»BPãƒ»SpO2ã®3é …ç›®ã‚’è‡ªå‹•èª­ã¿å–ã‚Š
        </div>
        <input type="file" id="vitalImageInput" accept="image/*" capture="environment" style="display:none">
        <div id="vitalReadStatus" class="small mt-2" style="display:none"></div>
      </div>
      
      <div id="vitalReadResult" style="display:none;margin-bottom:12px">
        <div style="background:#f0fdf4;border:1px solid #86efac;border-radius:10px;padding:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <h3 style="margin:0;color:#16a34a;font-size:14px;">ğŸ“Š èª­ã¿å–ã‚Šçµæœ</h3>
            <button class="btn btn-sm" id="vitalReadClear" style="background:#fee2e2;color:#dc2626;padding:4px 10px;min-height:28px;">ã‚¯ãƒªã‚¢</button>
          </div>
          <div style="margin-bottom:10px;display:flex;align-items:center;gap:8px;">
            <b style="font-size:13px;">æ™‚åˆ»</b>
            <input type="time" id="vitalReadTime" style="padding:6px 8px;border:1px solid var(--line);border-radius:6px;font-size:14px;">
            <span class="small" style="color:#16a34a;">ï¼ˆæ’®å½±æ™‚åˆ»ï¼‰</span>
          </div>
          <div id="vitalReadData" class="vital-grid" style="margin-bottom:10px"></div>
          <button class="btn btn-sm btn-success btn-block" id="vitalApplyBtn">ãƒã‚¤ã‚¿ãƒ«ã«è¿½åŠ </button>
        </div>
      </div>
      
      <div id="vitalsContainer"></div>
      <button class="btn btn-primary btn-block mt-2" id="addVitalBtn">ï¼‹ ãƒã‚¤ã‚¿ãƒ«è¿½åŠ </button>
    </div>

    <div class="card">
      <h2>ğŸ©º èº«ä½“æ‰€è¦‹</h2>
      <div class="exam-tabs" id="examTabs">
        <div class="exam-tab active" data-exam="general">æ±ç”¨</div>
        <div class="exam-tab" data-exam="trauma">å¤–å‚·</div>
        <div class="exam-tab" data-exam="stroke">è„³æ¢—å¡</div>
        <div class="exam-tab" data-exam="cpa">CPA</div>
      </div>

      <div class="exam-pane active" data-pane="general">
        <h3>é ­é šéƒ¨</h3>
        <div class="chips" id="gen-head"></div>
        <textarea class="mt-2" id="memo-gen-head" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <h3>å‘¼å¸å™¨</h3>
        <div class="chips" id="gen-resp"></div>
        <textarea class="mt-2" id="memo-gen-resp" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <h3>å¾ªç’°å™¨</h3>
        <div class="chips" id="gen-card"></div>
        <textarea class="mt-2" id="memo-gen-card" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="gen-abd"></div>
        <textarea class="mt-2" id="memo-gen-abd" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <h3>å››è‚¢</h3>
        <div class="chips" id="gen-limb"></div>
        <textarea class="mt-2" id="memo-gen-limb" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <h3>ç¥çµŒ</h3>
        <div class="chips" id="gen-neuro"></div>
        <textarea class="mt-2" id="memo-gen-neuro" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <div class="form-row mt-3">
          <label>è‡ªç”±è¨˜è¼‰</label>
          <textarea id="examFree" rows="3" placeholder="è¿½è¨˜ã‚„å¦å®šæ‰€è¦‹"></textarea>
        </div>
        <p class="small">ã‚¿ãƒƒãƒ—ã§åˆ‡æ›¿: æœªé¸æŠâ†’(+)â†’ãªã—â†’æœªé¸æŠ</p>
      </div>

      <div class="exam-pane" data-pane="trauma">
        <h3>é ­éƒ¨ãƒ»é¡”é¢</h3>
        <div class="chips" id="tra-head"></div>
        <textarea class="mt-2" id="memo-tra-head" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <h3>é ¸éƒ¨</h3>
        <div class="chips" id="tra-neck"></div>
        <textarea class="mt-2" id="memo-tra-neck" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <h3>èƒ¸éƒ¨</h3>
        <div class="chips" id="tra-chest"></div>
        <textarea class="mt-2" id="memo-tra-chest" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="tra-abd"></div>
        <textarea class="mt-2" id="memo-tra-abd" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <h3>éª¨ç›¤ãƒ»æ³Œå°¿ç”Ÿæ®–</h3>
        <div class="chips" id="tra-pelvis"></div>
        <textarea class="mt-2" id="memo-tra-pelvis" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <h3>å››è‚¢</h3>
        <div class="chips" id="tra-limb"></div>
        <textarea class="mt-2" id="memo-tra-limb" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <h3>å››è‚¢æ©Ÿèƒ½</h3>
        <div class="form-grid">
          <div><label>å³ä¸Šè‚¢</label><input id="tra-ru" placeholder="M5/5, Sæ­£å¸¸"></div>
          <div><label>å³ä¸‹è‚¢</label><input id="tra-rl" placeholder="M5/5, Sæ­£å¸¸"></div>
          <div><label>å·¦ä¸Šè‚¢</label><input id="tra-lu" placeholder="M5/5, Sæ­£å¸¸"></div>
          <div><label>å·¦ä¸‹è‚¢</label><input id="tra-ll" placeholder="M5/5, Sæ­£å¸¸"></div>
        </div>
      </div>

      <div class="exam-pane" data-pane="stroke">
        <h3>è„³ç¥çµŒ IIâ€“XII</h3>
        <div class="chips" id="str-cn"></div>
        <textarea class="mt-2" id="memo-str-cn" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <h3>ç³å­”ãƒ»çœ¼</h3>
        <div class="form-grid">
          <div><label>ç³å­”å¾„ å·¦(mm)</label><select id="pupilL"></select></div>
          <div><label>ç³å­”å¾„ å³(mm)</label><select id="pupilR"></select></div>
        </div>
        <div class="form-grid mt-2">
          <div><label>å¯¾å…‰åå°„ å·¦</label><select id="plrL"><option></option><option>è¿…é€Ÿ</option><option>é…å»¶</option><option>æ¶ˆå¤±</option></select></div>
          <div><label>å¯¾å…‰åå°„ å³</label><select id="plrR"><option></option><option>è¿…é€Ÿ</option><option>é…å»¶</option><option>æ¶ˆå¤±</option></select></div>
        </div>
        <div class="form-grid mt-2">
          <div><label>å…±åŒåè¦–</label><select id="gaze"><option></option><option>ãªã—</option><option>å³</option><option>å·¦</option></select></div>
          <div><label>çœ¼æŒ¯</label><select id="nyst"><option></option><option>ãªã—</option><option>æ°´å¹³</option><option>å›æ—‹</option><option>å‚ç›´</option></select></div>
        </div>
        <textarea class="mt-2" id="memo-str-eye" rows="2" placeholder="çœ¼æ‰€è¦‹ãƒ¡ãƒ¢"></textarea>
        
        <h3>é‹å‹•ï¼ˆMMT 0-5ï¼‰</h3>
        <div class="form-grid">
          <div><label>å³ä¸Šè‚¢</label><select id="mmtRU"></select></div>
          <div><label>å³ä¸‹è‚¢</label><select id="mmtRL"></select></div>
          <div><label>å·¦ä¸Šè‚¢</label><select id="mmtLU"></select></div>
          <div><label>å·¦ä¸‹è‚¢</label><select id="mmtLL"></select></div>
        </div>
        <textarea class="mt-2" id="memo-str-motor" rows="2" placeholder="é‹å‹•æ‰€è¦‹ãƒ¡ãƒ¢"></textarea>
        
        <h3>åå°„ãƒ»éŒä½“è·¯</h3>
        <div class="form-grid">
          <div><label>BTR</label><select id="btr"><option></option><option>æ­£å¸¸</option><option>äº¢é€²</option><option>ä½ä¸‹</option></select></div>
          <div><label>PTR</label><select id="ptr"><option></option><option>æ­£å¸¸</option><option>äº¢é€²</option><option>ä½ä¸‹</option></select></div>
        </div>
        <div class="check-line mt-2">
          <label><input type="checkbox" id="babinski"> Babinskié™½æ€§</label>
          <label><input type="checkbox" id="chaddock"> Chaddocké™½æ€§</label>
        </div>
        <textarea class="mt-2" id="memo-str-reflex" rows="2" placeholder="åå°„ãƒ¡ãƒ¢"></textarea>
        
        <h3>é«˜æ¬¡è„³æ©Ÿèƒ½ãƒ»å°è„³</h3>
        <div class="chips" id="str-higher"></div>
        <textarea class="mt-2" id="memo-str-higher" rows="2" placeholder="ãƒ¡ãƒ¢"></textarea>
        
        <details class="fold">
          <summary>NIHSS <span class="badge" id="nihSum">åˆè¨ˆ 0</span></summary>
          <div class="fold-body" id="nihssBody"></div>
        </details>
      </div>

      <div class="exam-pane" data-pane="cpa">
        <div style="background:#fee2e2;border:1px solid #f87171;border-radius:10px;padding:12px;margin-bottom:12px">
          <p style="margin:0;color:#b91c1c;font-size:13px;font-weight:500;">
            ğŸ’¡ CPAã‚¿ãƒ–ã‚’é–‹ãã¨ã€ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ãŒè‡ªå‹•çš„ã«CPAåˆæœŸå€¤ï¼ˆBP:-/-, HR:-, RR:-, SpO2:æ¸¬å®šä¸èƒ½, BT:å®Ÿæ¸¬å€¤, GCS:E1V1M1ï¼‰ã«è¨­å®šã•ã‚Œã€å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ1ãŒè¿½åŠ ã•ã‚Œã¾ã™
          </p>
        </div>
        
        <h3>å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
        <div id="cpaEventsContainer"></div>
        <button class="btn btn-primary btn-block mt-2" id="addCpaEventBtn">ï¼‹ å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ </button>
      </div>
    </div>
  </div>

  <div class="tab-content" data-tab="lab">
    <div class="card">
      <h2>ğŸ”¬ æ¤œæŸ»</h2>
      
      <div class="ocr-section mb-2" style="border:1px solid #c4b5fd;border-radius:10px;padding:12px;background:#faf5ff">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
          <button class="btn btn-sm btn-outline" id="labPasteBtn">
            ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆ
          </button>
          <button class="btn btn-sm btn-primary" id="geminiImageBtn">
            ğŸ“· ç”»åƒ
          </button>
        </div>
        <button class="btn btn-sm btn-outline" id="geminiSettingsBtn" style="width:100%;font-size:11px;padding:4px 10px;min-height:32px">
          âš™ï¸ Gemini APIè¨­å®š
        </button>
        <input type="file" id="geminiImageInput" accept="image/*" capture="environment" style="display:none">
        <div id="pasteArea" style="display:none;margin-top:8px">
          <textarea id="labPasteText" rows="6" placeholder="é›»å­ã‚«ãƒ«ãƒ†ã‹ã‚‰æ¤œæŸ»çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„&#10;&#10;ä¾‹ï¼š&#10;WBC 7500&#10;RBC 450&#10;Hb 13.5&#10;Na 140&#10;K 4.2" style="width:100%;padding:8px;border:1px solid var(--line);border-radius:8px;font-size:12px;"></textarea>
          <div class="btn-group mt-2">
            <button class="btn btn-sm btn-primary" id="labParseBtn">è§£æã—ã¦åæ˜ </button>
            <button class="btn btn-sm" id="labPasteCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
        <div id="pasteStatus" class="small mt-2" style="display:none"></div>
      </div>
      
      <div id="ocrResultArea" style="display:none;margin-bottom:12px">
        <div style="background:#f5f3ff;border:1px solid #c4b5fd;border-radius:8px;padding:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <h3 style="margin:0;font-size:14px;color:#6d28d9">ğŸ“‹ èª­ã¿å–ã‚Šçµæœ</h3>
            <button class="btn btn-sm" id="ocrClearBtn" style="padding:2px 8px;font-size:11px">ã‚¯ãƒªã‚¢</button>
          </div>
          <div id="ocrResultList" class="lab-pills"></div>
          <button class="btn btn-sm btn-success btn-block mt-2" id="ocrApplyBtn">æ¤œæŸ»å€¤ã«åæ˜ </button>
        </div>
      </div>
      
      <div id="savedLabImageArea" style="display:none;margin-bottom:12px">
        <div style="background:#ecfdf5;border:1px solid #6ee7b7;border-radius:8px;padding:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <h3 style="margin:0;font-size:14px;color:#047857">ğŸ“¸ ä¿å­˜ã•ã‚ŒãŸæ¤œæŸ»å†™çœŸ</h3>
            <div style="display:flex;gap:4px">
              <button class="btn btn-sm" id="rereadLabImageBtn" style="padding:2px 8px;font-size:11px;background:#10b981;color:#fff">å†èª­å–</button>
              <button class="btn btn-sm" id="deleteLabImageBtn" style="padding:2px 8px;font-size:11px">å‰Šé™¤</button>
            </div>
          </div>
          <img id="savedLabImagePreview" style="width:100%;border-radius:6px;cursor:pointer" onclick="this.requestFullscreen()">
          <p style="font-size:11px;color:#047857;margin-top:6px;margin-bottom:0">ã‚¿ãƒƒãƒ—ã§æ‹¡å¤§è¡¨ç¤º</p>
        </div>
      </div>
      
      <div class="form-grid mb-2">
        <div>
          <label>ã‚«ãƒ†ã‚´ãƒª</label>
          <select id="labCat">
            <option value="cbc">è¡€ç®—</option>
            <option value="chem">ç”ŸåŒ–å­¦</option>
            <option value="coag">å‡å›º</option>
            <option value="sugar">è¡€ç³–ãƒ»å¿ƒä¸å…¨</option>
            <option value="gas">è¡€æ¶²ã‚¬ã‚¹</option>
            <option value="urine">å°¿å®šæ€§</option>
            <option value="sediment">å°¿æ²ˆæ¸£</option>
            <option value="tumor">è…«ç˜ãƒãƒ¼ã‚«ãƒ¼</option>
            <option value="endo">å†…åˆ†æ³Œ</option>
            <option value="urineBio">å°¿ç”ŸåŒ–</option>
            <option value="csf">é«„æ¶²æ¤œæŸ»</option>
          </select>
        </div>
        <div>
          <label>é …ç›®</label>
          <select id="labItem"></select>
        </div>
      </div>
      <div class="btn-group mb-2">
        <button class="btn btn-sm btn-primary" id="labAdd">è¿½åŠ </button>
        <button class="btn btn-sm btn-success" id="labSetAll">ä¸€å¼</button>
      </div>
      
      <div class="btn-group mb-2">
        <button class="btn btn-sm btn-outline" id="labSetCBC">è¡€ç®—</button>
        <button class="btn btn-sm btn-outline" id="labSetChem">ç”ŸåŒ–</button>
        <button class="btn btn-sm btn-outline" id="labSetCoag">å‡å›º</button>
        <button class="btn btn-sm btn-outline" id="labSetGas">ABG</button>
        <button class="btn btn-sm btn-outline" id="labSetUrine">å°¿</button>
      </div>
      <div id="labEditArea"></div>
      
      <div class="form-row mt-3">
        <label>ãƒ•ãƒªãƒ¼å…¥åŠ›</label>
        <textarea id="labFree" rows="3" placeholder="ãã®ä»–æ¤œæŸ»å€¤"></textarea>
      </div>
    </div>
  </div>

  <div class="tab-content" data-tab="image">
    <div class="card">
      <h2>ğŸ¦  æ„ŸæŸ“ç—‡æ¤œæŸ»</h2>
      <div class="form-grid mb-2">
        <div>
          <label>COVID-19</label>
          <select id="covidType">
            <option value="">æœªå®Ÿæ–½</option>
            <option value="antigen">æŠ—åŸ</option>
            <option value="naat">NAAT</option>
          </select>
        </div>
        <div>
          <label>çµæœ</label>
          <select id="covidRes">
            <option value="">-</option>
            <option>é™½æ€§</option>
            <option>é™°æ€§</option>
          </select>
        </div>
      </div>
      <div class="form-grid mb-2">
        <div>
          <label>Influenza A</label>
          <select id="fluA"><option value="">-</option><option>é™½æ€§</option><option>é™°æ€§</option></select>
        </div>
        <div>
          <label>Influenza B</label>
          <select id="fluB"><option value="">-</option><option>é™½æ€§</option><option>é™°æ€§</option></select>
        </div>
      </div>
      
      <h3>åŸ¹é¤Š</h3>
      <div id="cultureArea"></div>
      <button class="btn btn-sm btn-outline mt-2" id="cultureAdd">ï¼‹åŸ¹é¤Šã‚’è¿½åŠ </button>
    </div>

    <div class="card">
      <h2>ğŸ–¼ï¸ ç”»åƒæ¤œæŸ»</h2>
      <div class="check-line">
        <label><input type="checkbox" id="cxrOn"> èƒ¸éƒ¨XP</label>
        <label><input type="checkbox" id="ctOn"> CT</label>
        <label><input type="checkbox" id="ctcOn"> é€ å½±CT</label>
        <label><input type="checkbox" id="mriOn"> MRI</label>
        <label><input type="checkbox" id="imgOtherOn"> ãã®ä»–</label>
      </div>
      <div id="imgTextArea"></div>
    </div>

    <div class="card">
      <h2>ğŸ“Š ç”Ÿç†æ©Ÿèƒ½æ¤œæŸ»</h2>
      <div class="check-line">
        <label><input type="checkbox" id="ecgOn"> å¿ƒé›»å›³</label>
        <label><input type="checkbox" id="eegOn"> è„³æ³¢</label>
        <label><input type="checkbox" id="usOn"> è¶…éŸ³æ³¢</label>
        <label><input type="checkbox" id="phyOtherOn"> ãã®ä»–</label>
      </div>
      <div id="phyTextArea"></div>
    </div>
  </div>

  <div class="tab-content" data-tab="assess">
    <div class="card">
      <h2>ğŸ“ ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ãƒªã‚¹ãƒˆ</h2>
      <div class="form-row">
        <label>æ–°è¦ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ï¼ˆEnterã§è¿½åŠ ï¼‰</label>
        <input id="probInput" placeholder="ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ åã‚’å…¥åŠ›">
      </div>
      <div class="problem-tags" id="probTags"></div>
      <div id="probDetails"></div>
    </div>

    <div class="card">
      <h2>ğŸ“Œ å…¥é™¢å¾ŒçµŒé / æ–¹é‡</h2>
      <div class="toggle-group mb-2">
        <button class="toggle-btn active" data-plan="course">å…¥é™¢å¾ŒçµŒé</button>
        <button class="toggle-btn" data-plan="plan">æ–¹é‡ï¼ˆPï¼‰</button>
      </div>
      
      <div class="plan-section active" id="courseSection">
        <label>å…¥é™¢å¾ŒçµŒé</label>
        <textarea id="courseText" rows="5" placeholder="å…¥é™¢å¾Œã®çµŒéã‚’è¨˜è¼‰&#10;ä¾‹ï¼šå…¥é™¢å¾Œã€â—â—ã®æ²»ç™‚ã‚’é–‹å§‹ã€‚ãƒã‚¤ã‚¿ãƒ«å®‰å®šã€‚"></textarea>
      </div>
      
      <div class="plan-section" id="planSection">
        <label>æ–¹é‡ï¼ˆPï¼‰ãƒ»ä»Šå¾Œã®äºˆå®š</label>
        <textarea id="planText" rows="5" placeholder="ä»Šå¾Œã®æ–¹é‡ãƒ»äºˆå®šã‚’è¨˜è¼‰&#10;ä¾‹ï¼šæœ¬æ—¥CTå†æ¤œäºˆå®šã€æ˜æ—¥å¿ƒã‚¨ã‚³ãƒ¼äºˆå®š"></textarea>
      </div>
    </div>
  </div>

  <div class="tab-content" data-tab="output">
    <div class="card">
      <h2>ğŸ“„ å…¥é™¢ã‚µãƒãƒª</h2>
      <div class="btn-group mb-2">
        <button class="btn btn-primary" id="copyOut">ã‚³ãƒ”ãƒ¼</button>
        <button class="btn btn-outline" id="printOut">å°åˆ·/PDF</button>
        <button class="btn btn-danger" id="btnResetMain">ğŸ—‘ åˆæœŸåŒ–</button>
      </div>
      <div class="output-box" id="outputText"></div>
    </div>
  </div>
</main>

<nav class="tab-bar">
  <div class="tab-bar-item active" data-tab="history">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
    <span>ç—…æ­´</span>
  </div>
  <div class="tab-bar-item" data-tab="exam">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
    <span>æ‰€è¦‹</span>
  </div>
  <div class="tab-bar-item" data-tab="lab">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
    <span>æ¤œæŸ»</span>
  </div>
  <div class="tab-bar-item" data-tab="image">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
    <span>ç”»åƒ</span>
  </div>
  <div class="tab-bar-item" data-tab="assess">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
    <span>è©•ä¾¡</span>
  </div>
  <div class="tab-bar-item" data-tab="output">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
    <span>å‡ºåŠ›</span>
  </div>
</nav>

<div id="geminiModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:200;overflow-y:auto;-webkit-overflow-scrolling:touch">
  <div style="min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px;padding-top:calc(20px + env(safe-area-inset-top));padding-bottom:calc(20px + env(safe-area-inset-bottom));padding-left:calc(20px + env(safe-area-inset-left));padding-right:calc(20px + env(safe-area-inset-right))">
    <div style="background:#fff;border-radius:16px;padding:24px;max-width:500px;width:100%;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2 style="margin:0;font-size:18px;font-weight:600">âš™ï¸ Gemini API è¨­å®š</h2>
        <button id="geminiModalClose" style="border:none;background:transparent;font-size:24px;cursor:pointer;color:#6b7280;padding:0;width:32px;height:32px;line-height:1">Ã—</button>
      </div>
      <div style="margin-bottom:16px">
        <label style="display:block;font-size:13px;font-weight:500;color:#374151;margin-bottom:8px">APIã‚­ãƒ¼</label>
        <input type="password" id="geminiApiKey" placeholder="AIzaSy..." style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;-webkit-appearance:none">
        <p style="font-size:12px;color:#6b7280;margin-top:6px;line-height:1.5">
          Gemini APIã‚­ãƒ¼ã¯ <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#2563eb">Google AI Studio</a> ã§å–å¾—ã§ãã¾ã™ã€‚<br>
          ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
        </p>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" id="geminiSaveBtn" style="flex:1">ä¿å­˜</button>
        <button class="btn btn-outline" id="geminiCancelBtn" style="flex:1">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
      <div id="geminiStatus" style="margin-top:12px;font-size:12px;display:none"></div>
    </div>
  </div>
</div>

<div id="recordsModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:200;overflow-y:auto;-webkit-overflow-scrolling:touch">
  <div style="min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px;padding-top:calc(20px + env(safe-area-inset-top));padding-bottom:calc(20px + env(safe-area-inset-bottom));padding-left:calc(20px + env(safe-area-inset-left));padding-right:calc(20px + env(safe-area-inset-right))">
    <div style="background:#fff;border-radius:16px;padding:24px;max-width:500px;width:100%;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2 style="margin:0;font-size:18px;font-weight:600">ğŸ“‚ è¨˜éŒ²ç®¡ç†</h2>
        <button id="recordsModalClose" style="border:none;background:transparent;font-size:24px;cursor:pointer;color:#6b7280;padding:0;width:32px;height:32px;line-height:1">Ã—</button>
      </div>
      
      <div style="margin-bottom:16px">
        <button class="btn btn-primary btn-block" id="newRecordBtn">ğŸ“ æ–°è¦è¨˜éŒ²ã‚’é–‹å§‹</button>
      </div>
      
      <div style="margin-bottom:12px">
        <h3 style="font-size:14px;font-weight:600;color:#374151;margin-bottom:8px">ä¿å­˜ã•ã‚ŒãŸè¨˜éŒ²</h3>
        <div id="recordsList" style="max-height:400px;overflow-y:auto"></div>
      </div>
      
      <div style="margin-top:16px;padding-top:16px;border-top:1px solid #e5e7eb">
        <p style="font-size:12px;color:#6b7280;margin:0">
          ğŸ’¡ è¨˜éŒ²ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>
          è¤‡æ•°ã®æ‚£è€…è¨˜éŒ²ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ä½¿ç”¨ã§ãã¾ã™ã€‚
        </p>
      </div>
    </div>
  </div>
</div>

<script>
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);
const today = () => new Date().toISOString().split('T')[0];

const state = {
  cc: '', visitDate: '', hpi: '', pmh: '', meds: '', allergy: '', familyHx: '', habits: '', social: '', keyPerson: '',
  vitals: [],
  chips: {},
  memos: {
    general: { head: '', resp: '', card: '', abd: '', limb: '', neuro: '' },
    trauma: { head: '', neck: '', chest: '', abd: '', pelvis: '', limb: '' },
    stroke: { cn: '', eye: '', motor: '', reflex: '', higher: '' }
  },
  examFree: '',
  examTab: 'general',
  cpaEvents: [],
  trauma: { ru: '', rl: '', lu: '', ll: '' },
  stroke: {
    pupilL: '', pupilR: '', plrL: '', plrR: '', gaze: '', nyst: '',
    mmt: { ru: '', rl: '', lu: '', ll: '' },
    btr: '', ptr: '', babinski: false, chaddock: false,
    nih: {}
  },
  labs: { cbc: [], chem: [], coag: [], sugar: [], gas: [], urine: [], sediment: [], tumor: [], endo: [], urineBio: [], csf: [], gasType: 'ABG' },
  labFree: '',
  lastLabImage: null, // æœ€å¾Œã«æ’®å½±ã—ãŸæ¤œæŸ»å†™çœŸã‚’ä¿å­˜
  infect: { covid: { type: '', res: '' }, flu: { a: '', b: '' }, cultures: [] },
  imaging: { 
    cxr: { on: false, txt: '' }, 
    ct: { on: false, txt: '' }, 
    ctc: { on: false, txt: '' }, 
    mri: { on: false, txt: '' },
    other: { on: false, name: '', txt: '' }
  },
  phys: { 
    ecg: { on: false, rhythm: '', rate: '', st: '', qtc: '', txt: '' }, 
    eeg: { on: false, txt: '' }, 
    us: { on: false, txt: '' },
    other: { on: false, name: '', txt: '' }
  },
  problems: [],
  activePlan: 'course',
  courseText: '',
  planText: ''
};

const NORMALS = {
  cbc: { WBC: '7000', RBC: '4.5', Hb: '14.0', Ht: '42', Plt: '200', MCV: '90', MCH: '30', MCHC: '33' },
  chem: { Na: '140', K: '4.0', Cl: '103', BUN: '15', Cr: '0.8', eGFR: '80', AST: '20', ALT: '20', ALP: '200', 'Î³-GTP': '30', 'T-bil': '0.8', 'D-bil': '0.2', TP: '7.0', Alb: '4.2', Glu: '100', CRP: '0.1', LDH: '200', CK: '100', Amy: '80', Lip: '30', UA: '5.0', Ca: '9.0', IP: '3.5', Mg: '2.0', Fe: '100', TIBC: '300', Ferritin: '100' },
  coag: { 'PT-INR': '1.0', 'PT%': '100', APTT: '30', 'D-dimer': '0.5', FDP: '5', Fib: '300', AT3: '100' },
  sugar: { HbA1c: '5.6', BNP: '20', 'NT-proBNP': '100' },
  gas: { pH: '7.40', pCO2: '40', pO2: '95', 'HCO3-': '24', BE: '0', Lac: '1.0', SaO2: '98' },
  urine: { pH: '6.0', 'æ¯”é‡': '1.015', 'è›‹ç™½': 'âˆ’', 'ç³–': 'âˆ’', 'æ½œè¡€': 'âˆ’', 'ã‚±ãƒˆãƒ³': 'âˆ’', 'ã‚¦ãƒ­ãƒ“ãƒª': 'Â±', 'ãƒ“ãƒªãƒ«ãƒ“ãƒ³': 'âˆ’', 'äºœç¡é…¸å¡©': 'âˆ’', 'ç™½è¡€çƒ': 'âˆ’' },
  sediment: { 'RBC': '0-1', 'WBC': '0-4', 'æ‰å¹³ä¸Šçš®': 'å°‘æ•°', 'å††æŸ±': 'âˆ’', 'ç´°èŒ': 'âˆ’', 'çµæ™¶': 'âˆ’' },
  tumor: { CEA: '', CA19_9: '', AFP: '', PSA: '', CA125: '', CA15_3: '', SCC: '', CYFRA: '', ProGRP: '', NSE: '' },
  endo: { TSH: '', FT3: '', FT4: '', Cortisol: '', ACTH: '', GH: '', IGF1: '', PRL: '', LH: '', FSH: '', E2: '', Testosterone: '', PTH: '', Insulin: '', 'C-peptide': '' },
  urineBio: { 'U-TP': '', 'U-Alb': '', 'U-Cr': '', 'U-Na': '', 'U-K': '', 'U-Cl': '', 'U-UN': '', 'U-UA': '', 'U-Amy': '' },
  csf: { 'é«„æ¶²ç´°èƒæ•°': '', 'é«„æ¶²è›‹ç™½': '', 'é«„æ¶²ç³–': '', 'é«„æ¶²Cl': '', 'é«„æ¶²åœ§': '', 'é«„æ¶²å¤–è¦³': '' }
};

const LABS = {
  cbc: { name: 'è¡€ç®—', items: [['WBC', '/Î¼L'], ['RBC', 'Ã—10^6/Î¼L'], ['Hb', 'g/dL'], ['Ht', '%'], ['Plt', 'Ã—10^3/Î¼L'], ['MCV', 'fL'], ['MCH', 'pg'], ['MCHC', '%']] },
  chem: { name: 'ç”ŸåŒ–å­¦', items: [['CRP', 'mg/dL'], ['TP', 'g/dL'], ['Alb', 'g/dL'], ['AST', 'U/L'], ['ALT', 'U/L'], ['ALP', 'U/L'], ['Î³-GTP', 'U/L'], ['T-bil', 'mg/dL'], ['D-bil', 'mg/dL'], ['LDH', 'U/L'], ['BUN', 'mg/dL'], ['Cr', 'mg/dL'], ['eGFR', 'mL/min'], ['Na', 'mEq/L'], ['K', 'mEq/L'], ['Cl', 'mEq/L'], ['Glu', 'mg/dL'], ['CK', 'U/L'], ['Amy', 'U/L'], ['Lip', 'U/L'], ['UA', 'mg/dL'], ['Ca', 'mg/dL'], ['IP', 'mg/dL'], ['Mg', 'mg/dL'], ['Fe', 'Î¼g/dL'], ['TIBC', 'Î¼g/dL'], ['Ferritin', 'ng/mL']] },
  coag: { name: 'å‡å›º', items: [['PT-INR', ''], ['PT%', '%'], ['APTT', 'sec'], ['D-dimer', 'Î¼g/mL'], ['FDP', 'Î¼g/mL'], ['Fib', 'mg/dL'], ['AT3', '%']] },
  sugar: { name: 'è¡€ç³–ãƒ»å¿ƒä¸å…¨', items: [['HbA1c', '%'], ['BNP', 'pg/mL'], ['NT-proBNP', 'pg/mL']] },
  gas: { name: 'è¡€æ¶²ã‚¬ã‚¹', items: [['pH', ''], ['pCO2', 'mmHg'], ['pO2', 'mmHg'], ['HCO3-', 'mmol/L'], ['BE', 'mEq/L'], ['Lac', 'mmol/L'], ['SaO2', '%']] },
  urine: { name: 'å°¿å®šæ€§', items: [['pH', ''], ['æ¯”é‡', ''], ['è›‹ç™½', ''], ['ç³–', ''], ['æ½œè¡€', ''], ['ã‚±ãƒˆãƒ³', ''], ['ã‚¦ãƒ­ãƒ“ãƒª', ''], ['ãƒ“ãƒªãƒ«ãƒ“ãƒ³', ''], ['äºœç¡é…¸å¡©', ''], ['ç™½è¡€çƒ', '']] },
  sediment: { name: 'å°¿æ²ˆæ¸£', items: [['RBC', '/HPF'], ['WBC', '/HPF'], ['æ‰å¹³ä¸Šçš®', '/HPF'], ['å††æŸ±', ''], ['ç´°èŒ', ''], ['çµæ™¶', '']] },
  tumor: { name: 'è…«ç˜ãƒãƒ¼ã‚«ãƒ¼', items: [['CEA', 'ng/mL'], ['CA19_9', 'U/mL'], ['AFP', 'ng/mL'], ['PSA', 'ng/mL'], ['CA125', 'U/mL'], ['CA15_3', 'U/mL'], ['SCC', 'ng/mL'], ['CYFRA', 'ng/mL'], ['ProGRP', 'pg/mL'], ['NSE', 'ng/mL']] },
  endo: { name: 'å†…åˆ†æ³Œ', items: [['TSH', 'Î¼IU/mL'], ['FT3', 'pg/mL'], ['FT4', 'ng/dL'], ['Cortisol', 'Î¼g/dL'], ['ACTH', 'pg/mL'], ['GH', 'ng/mL'], ['IGF1', 'ng/mL'], ['PRL', 'ng/mL'], ['LH', 'mIU/mL'], ['FSH', 'mIU/mL'], ['E2', 'pg/mL'], ['Testosterone', 'ng/dL'], ['PTH', 'pg/mL'], ['Insulin', 'Î¼U/mL'], ['C-peptide', 'ng/mL']] },
  urineBio: { name: 'å°¿ç”ŸåŒ–', items: [['U-TP', 'mg/dL'], ['U-Alb', 'mg/dL'], ['U-Cr', 'mg/dL'], ['U-Na', 'mEq/L'], ['U-K', 'mEq/L'], ['U-Cl', 'mEq/L'], ['U-UN', 'mg/dL'], ['U-UA', 'mg/dL'], ['U-Amy', 'U/L']] },
  csf: { name: 'é«„æ¶²æ¤œæŸ»', items: [['é«„æ¶²ç´°èƒæ•°', '/Î¼L'], ['é«„æ¶²è›‹ç™½', 'mg/dL'], ['é«„æ¶²ç³–', 'mg/dL'], ['é«„æ¶²Cl', 'mEq/L'], ['é«„æ¶²åœ§', 'cmH2O'], ['é«„æ¶²å¤–è¦³', '']] }
};

// ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼å‚è€ƒã®æ‰€è¦‹ã‚°ãƒ«ãƒ¼ãƒ—
const GEN_GROUPS = {
  head: { normal: ['æ„è­˜æ¸…æ˜', 'é¡”é¢è’¼ç™½ãªã—', 'ãƒã‚¢ãƒãƒ¼ã‚¼ãªã—'], abn: ['æ„è­˜éšœå®³', 'é¡”é¢è’¼ç™½', 'ãƒã‚¢ãƒãƒ¼ã‚¼', 'ç™ºç†±', 'é»„ç–¸', 'çœ¼ç¼çµè†œè’¼ç™½', 'çœ¼çƒçµè†œé»„æŸ“'] },
  resp: { normal: ['å‘¼å¸éŸ³æ¸…', 'å–˜é³´ãªã—'], abn: ['å‘¼å¸å›°é›£', 'å–˜é³´', 'æ¹¿æ€§ãƒ©éŸ³', 'coarse crackles', 'fine crackles', 'å‘¼å¸éŸ³æ¸›å¼±', 'å·¦å³å·®ã‚ã‚Š'] },
  card: { normal: ['å¿ƒéŸ³ç´”', 'ä¸æ•´ãªã—', 'ä¸‹è…¿æµ®è…«ãªã—'], abn: ['ã‚·ãƒ§ãƒƒã‚¯å…†å€™', 'å¿ƒé›‘éŸ³', 'ä¸æ•´è„ˆ', 'å†·æ±—', 'ä¸‹è…¿æµ®è…«', 'é ¸é™è„ˆæ€’å¼µ'] },
  abd: { normal: ['è…¹éƒ¨å¹³å¦è»Ÿ', 'åœ§ç—›ãªã—', 'åè·³ç—›ãªã—'], abn: ['è…¹ç—›', 'åœ§ç—›', 'åè·³ç—›', 'ç­‹æ€§é˜²å¾¡', 'æ¿çŠ¶ç¡¬', 'è…¹éƒ¨è†¨æº€', 'è…¸è •å‹•éŸ³æ¸›å¼±', 'è…¸è •å‹•éŸ³äº¢é€²'] },
  limb: { normal: ['å››è‚¢å†·æ„Ÿãªã—', 'æµ®è…«ãªã—'], abn: ['å››è‚¢å†·æ„Ÿ', 'æµ®è…«', 'å¤‰å½¢', 'æœ«æ¢¢å¾ªç’°ä¸å…¨', 'CRTå»¶é•·'] },
  neuro: { normal: ['éº»ç—ºãªã—', 'ç—™æ”£ãªã—'], abn: ['ç‰‡éº»ç—º', 'ç—™æ”£', 'ç³å­”ä¸åŒ', 'å¯¾å…‰åå°„ç•°å¸¸', 'é …éƒ¨ç¡¬ç›´', 'Kernigå¾´å€™'] }
};

const TRA_GROUPS = {
  head: ['å‰é¡éƒ¨æ‰“æ’²è¡€è…«', 'å´é ­éƒ¨æ‰“æ’²è¡€è…«', 'å¾Œé ­éƒ¨æŒ«å‰µ', 'é ­çš®è£‚å‚·', 'é¡”é¢æŒ«å‰µ', 'é¡”é¢è…«è„¹', 'ãƒ‘ãƒ³ãƒ€ã®ç›®å¾´å€™', 'ãƒãƒˆãƒ«ã‚µã‚¤ãƒ³', 'é¼»å‡ºè¡€', 'è€³å‡ºè¡€', 'é«„æ¶²æ¼', 'å£è…”å†…å‡ºè¡€'],
  neck: ['æ°—ç®¡æ­£ä¸­', 'æ°—ç®¡åä½', 'é ¸éƒ¨çš®ä¸‹æ°—è…«', 'é ¸é™è„ˆæ€’å¼µ', 'å¾Œé ¸éƒ¨åœ§ç—›', 'é ¸éƒ¨æ‰“æ’²', 'é ¸éƒ¨è¡€è…«'],
  chest: ['èƒ¸éƒ­å¯¾ç§°', 'èƒ¸éƒ­å¤‰å½¢', 'å‹•æºèƒ¸éƒ­', 'èƒ¸å£åœ§ç—›', 'èƒ¸å£çš®ä¸‹æ°—è…«', 'å³å‘¼å¸éŸ³æ¸›å¼±', 'å·¦å‘¼å¸éŸ³æ¸›å¼±', 'å¿ƒéŸ³æ¸›å¼±'],
  abd: ['è…¹å£æ‰“æ’²', 'ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆã‚µã‚¤ãƒ³', 'ãƒãƒ³ãƒ‰ãƒ«ç—•', 'è…¹éƒ¨åœ§ç—›', 'ç­‹æ€§é˜²å¾¡', 'åè·³ç—›', 'è…¹éƒ¨è†¨æº€'],
  pelvis: ['éª¨ç›¤å‹•æº', 'éª¨ç›¤åœ§ç—›', 'æ¥éª¨åœ§ç—›', 'ä¼šé™°éƒ¨å‡ºè¡€', 'å°¿é“å‡ºè¡€'],
  limb: ['å³ä¸Šè‚¢å¤‰å½¢', 'å·¦ä¸Šè‚¢å¤‰å½¢', 'å³ä¸‹è‚¢å¤‰å½¢', 'å·¦ä¸‹è‚¢å¤‰å½¢', 'é–‹æ”¾å‰µ', 'éª¨éœ²å‡º', 'æœ«æ¢¢å‹•è„ˆè§¦çŸ¥ä¸è‰¯', 'CRTå»¶é•·']
};

const STR_CNs = ['è¦–åŠ›ä½ä¸‹', 'è¦–é‡æ¬ æ', 'è¤‡è¦–', 'çœ¼ç¼ä¸‹å‚', 'é¡”é¢éº»ç—º', 'é¡”é¢æ„Ÿè¦šä½ä¸‹', 'è´åŠ›ä½ä¸‹', 'ã‚ã¾ã„', 'æ§‹éŸ³éšœå®³', 'åš¥ä¸‹éšœå®³', 'èˆŒåä½', 'ã‚«ãƒ¼ãƒ†ãƒ³å¾´å€™'];
const STR_HIGHER = ['å¤±èª', 'é‹å‹•æ€§å¤±èª', 'æ„Ÿè¦šæ€§å¤±èª', 'æ§‹éŸ³éšœå®³', 'å¤±è¡Œ', 'å¤±èª', 'åŠå´ç©ºé–“ç„¡è¦–', 'æ³¨æ„éšœå®³', 'è¦‹å½“è­˜éšœå®³', 'å°è„³å¤±èª¿', 'æŒ‡é¼»è©¦é¨“ç•°å¸¸', 'è¸µè†è©¦é¨“ç•°å¸¸'];

const NIHSS_ITEMS = [
  { key: '1a', label: '1a æ„è­˜æ°´æº–', hint: '0:è¦šé†’ 1:è»½åº¦éˆéº» 2:å¼·åˆºæ¿€ã§é–‹çœ¼ 3:åå¿œãªã—', max: 3 },
  { key: '1b', label: '1b è³ªå•ï¼ˆå¹´é½¢/æœˆï¼‰', hint: '0:ä¸¡æ–¹æ­£è§£ 1:1ã¤æ­£è§£ 2:ä¸¡æ–¹ä¸æ­£è§£', max: 2 },
  { key: '1c', label: '1c å¾“å‘½ï¼ˆé–‹é–‰çœ¼/æ¡æ‰‹ï¼‰', hint: '0:ä¸¡æ–¹æ­£è§£ 1:1ã¤æ­£è§£ 2:ä¸¡æ–¹ä¸æ­£è§£', max: 2 },
  { key: '2', label: '2 æ³¨è¦–', hint: '0:æ­£å¸¸ 1:éƒ¨åˆ†çš„æ³¨è¦–éº»ç—º 2:å®Œå…¨æ³¨è¦–éº»ç—º', max: 2 },
  { key: '3', label: '3 è¦–é‡', hint: '0:æ­£å¸¸ 1:éƒ¨åˆ†çš„åŠç›² 2:å®Œå…¨åŠç›² 3:ä¸¡å´æ€§', max: 3 },
  { key: '4', label: '4 é¡”é¢éº»ç—º', hint: '0:ãªã— 1:è»½åº¦ 2:éƒ¨åˆ†çš„ 3:å®Œå…¨', max: 3 },
  { key: '5a', label: '5a ä¸Šè‚¢é‹å‹• å³', hint: '0:ä¿æŒ 1-4:è½ä¸‹ç¨‹åº¦', max: 4 },
  { key: '5b', label: '5b ä¸Šè‚¢é‹å‹• å·¦', hint: '0:ä¿æŒ 1-4:è½ä¸‹ç¨‹åº¦', max: 4 },
  { key: '6a', label: '6a ä¸‹è‚¢é‹å‹• å³', hint: '0:ä¿æŒ 1-4:è½ä¸‹ç¨‹åº¦', max: 4 },
  { key: '6b', label: '6b ä¸‹è‚¢é‹å‹• å·¦', hint: '0:ä¿æŒ 1-4:è½ä¸‹ç¨‹åº¦', max: 4 },
  { key: '7', label: '7 é‹å‹•å¤±èª¿', hint: '0:ãªã— 1:1è‚¢ 2:2è‚¢', max: 2 },
  { key: '8', label: '8 æ„Ÿè¦š', hint: '0:æ­£å¸¸ 1:è»½åº¦ä½ä¸‹ 2:é‡åº¦ä½ä¸‹', max: 2 },
  { key: '9', label: '9 è¨€èª', hint: '0:æ­£å¸¸ 1:è»½åº¦ 2:é‡åº¦ 3:å…¨å¤±èª', max: 3 },
  { key: '10', label: '10 æ§‹éŸ³éšœå®³', hint: '0:æ­£å¸¸ 1:è»½åº¦ 2:é‡åº¦', max: 2 },
  { key: '11', label: '11 æ¶ˆå»/æ³¨æ„éšœå®³', hint: '0:ãªã— 1:è»½åº¦ 2:é‡åº¦', max: 2 }
];

// è¨˜éŒ²ç®¡ç†
const RECORDS_LIST_KEY = 'gairai_records_list';
let currentRecordId = null;

function getRecordsList() {
  const data = localStorage.getItem(RECORDS_LIST_KEY);
  return data ? JSON.parse(data) : [];
}

function saveRecordsList(list) {
  localStorage.setItem(RECORDS_LIST_KEY, JSON.stringify(list));
}

function generateRecordId() {
  const now = new Date();
  const date = now.toISOString().split('T')[0];
  const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  return `${date}_${time.replace(':', '-')}`;
}

function getRecordKey(id) {
  return `gairai_record_${id}`;
}

function save() {
  if (!currentRecordId) {
    // æ–°è¦è¨˜éŒ²ã®å ´åˆã¯IDã‚’ç”Ÿæˆ
    currentRecordId = generateRecordId();
    const records = getRecordsList();
    records.unshift({
      id: currentRecordId,
      date: new Date().toISOString().split('T')[0],
      time: new Date().toTimeString().split(' ')[0].substring(0, 5),
      title: state.cc || 'ï¼ˆä¸»è¨´æœªå…¥åŠ›ï¼‰',
      lastUpdated: new Date().toISOString()
    });
    saveRecordsList(records);
  } else {
    // æ—¢å­˜è¨˜éŒ²ã®æ›´æ–°
    const records = getRecordsList();
    const record = records.find(r => r.id === currentRecordId);
    if (record) {
      record.title = state.cc || 'ï¼ˆä¸»è¨´æœªå…¥åŠ›ï¼‰';
      record.lastUpdated = new Date().toISOString();
      saveRecordsList(records);
    }
  }
  
  localStorage.setItem(getRecordKey(currentRecordId), JSON.stringify(state));
}

function load(recordId) {
  if (recordId) {
    currentRecordId = recordId;
  }
  
  if (!currentRecordId) {
    // è¨˜éŒ²IDãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯æœ€æ–°ã®è¨˜éŒ²ã‚’èª­ã¿è¾¼ã‚€
    const records = getRecordsList();
    if (records.length > 0) {
      currentRecordId = records[0].id;
    }
  }
  
  if (currentRecordId) {
    const d = localStorage.getItem(getRecordKey(currentRecordId));
    if (d) { 
      try { 
        Object.assign(state, JSON.parse(d));
        // å¤ã„å½¢å¼ã®vitalsã‚’æ–°ã—ã„é…åˆ—å½¢å¼ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        if (state.vitals && !Array.isArray(state.vitals) && state.vitals.sbp !== undefined) {
          const oldVital = state.vitals;
          state.vitals = [{
            time: '',
            sbp: oldVital.sbp || 120,
            dbp: oldVital.dbp || 80,
            hr: oldVital.hr || 72,
            rr: oldVital.rr || 16,
            spo2: oldVital.spo2 || 98,
            bt: oldVital.bt || 36.6,
            gcs: oldVital.gcs || { e: 4, v: 5, m: 6 }
          }];
        }
        // cpaEventsãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºé…åˆ—ã§åˆæœŸåŒ–
        if (!state.cpaEvents) {
          state.cpaEvents = [];
        }
        // å¤ã„memos.cpaã‚’å‰Šé™¤ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        if (state.memos && state.memos.cpa) {
          delete state.memos.cpa;
        }
      } catch (e) {
        console.error('Failed to load record:', e);
      } 
    }
  }
}

function newRecord() {
  // ç¾åœ¨ã®stateã‚’ãƒªã‚»ãƒƒãƒˆ
  Object.keys(state).forEach(key => {
    if (key === 'vitals') {
      state[key] = [];
    } else if (key === 'chips') {
      state[key] = {};
    } else if (key === 'memos') {
      state[key] = {
        general: { head: '', resp: '', card: '', abd: '', limb: '', neuro: '' },
        trauma: { head: '', neck: '', chest: '', abd: '', pelvis: '', limb: '' },
        stroke: { cn: '', eye: '', motor: '', reflex: '', higher: '' }
      };
    } else if (key === 'trauma') {
      state[key] = { ru: '', rl: '', lu: '', ll: '' };
    } else if (key === 'stroke') {
      state[key] = {
        pupilL: '', pupilR: '', plrL: '', plrR: '', gaze: '', nyst: '',
        mmt: { ru: '', rl: '', lu: '', ll: '' },
        btr: '', ptr: '', babinski: false, chaddock: false,
        nih: {}
      };
    } else if (key === 'labs') {
      state[key] = { cbc: [], chem: [], coag: [], sugar: [], gas: [], urine: [], sediment: [], tumor: [], endo: [], urineBio: [], csf: [], gasType: 'ABG' };
    } else if (key === 'infect') {
      state[key] = { covid: { type: '', res: '' }, flu: { a: '', b: '' }, cultures: [] };
    } else if (key === 'imaging') {
      state[key] = { 
        cxr: { on: false, txt: '' }, 
        ct: { on: false, txt: '' }, 
        ctc: { on: false, txt: '' }, 
        mri: { on: false, txt: '' },
        other: { on: false, name: '', txt: '' }
      };
    } else if (key === 'phys') {
      state[key] = { 
        ecg: { on: false, rhythm: '', rate: '', st: '', qtc: '', txt: '' }, 
        eeg: { on: false, txt: '' }, 
        us: { on: false, txt: '' },
        other: { on: false, name: '', txt: '' }
      };
    } else if (key === 'problems') {
      state[key] = [];
    } else if (key === 'cpaEvents') {
      state[key] = [];
    } else if (key === 'lastLabImage') {
      state[key] = null;
    } else {
      state[key] = '';
    }
  });
  
  currentRecordId = null;
  location.reload();
}

function deleteRecord(recordId) {
  if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
    return;
  }
  
  // è¨˜éŒ²ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
  const records = getRecordsList();
  const newRecords = records.filter(r => r.id !== recordId);
  saveRecordsList(newRecords);
  
  // ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
  localStorage.removeItem(getRecordKey(recordId));
  
  // å‰Šé™¤ã—ãŸè¨˜éŒ²ãŒç¾åœ¨ã®è¨˜éŒ²ã®å ´åˆ
  if (currentRecordId === recordId) {
    if (newRecords.length > 0) {
      // æœ€æ–°ã®è¨˜éŒ²ã‚’èª­ã¿è¾¼ã‚€
      load(newRecords[0].id);
      location.reload();
    } else {
      // è¨˜éŒ²ãŒãªããªã£ãŸå ´åˆã¯æ–°è¦ä½œæˆ
      newRecord();
    }
  } else {
    // ä»–ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ãŸå ´åˆã¯ãƒªã‚¹ãƒˆã‚’å†æç”»
    renderRecordsList();
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
window.deleteRecord = deleteRecord;

const STORAGE_KEY = 'gairai_iphone_v21'; // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™

// æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã®ç§»è¡Œå‡¦ç†
function migrateFromOldVersion() {
  const oldData = localStorage.getItem(STORAGE_KEY);
  if (oldData && getRecordsList().length === 0) {
    try {
      const oldState = JSON.parse(oldData);
      // æ—§ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„è¨˜éŒ²ã¨ã—ã¦ä¿å­˜
      const recordId = generateRecordId();
      localStorage.setItem(getRecordKey(recordId), oldData);
      
      const records = [{
        id: recordId,
        date: new Date().toISOString().split('T')[0],
        time: new Date().toTimeString().split(' ')[0].substring(0, 5),
        title: oldState.cc || 'ï¼ˆç§»è¡Œãƒ‡ãƒ¼ã‚¿ï¼‰',
        lastUpdated: new Date().toISOString()
      }];
      saveRecordsList(records);
      currentRecordId = recordId;
      
      // æ—§ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
      localStorage.removeItem(STORAGE_KEY);
      console.log('Migrated from old version');
    } catch (e) {
      console.error('Migration failed:', e);
    }
  }
}

function switchTab(tab) {
  $$('.tab-content').forEach(el => el.classList.remove('active'));
  $$('.tab-bar-item').forEach(el => el.classList.remove('active'));
  $(`.tab-content[data-tab="${tab}"]`).classList.add('active');
  $(`.tab-bar-item[data-tab="${tab}"]`).classList.add('active');
  if (tab === 'output') renderOutput();
}
$$('.tab-bar-item').forEach(el => { el.addEventListener('click', () => switchTab(el.dataset.tab)); });

function switchExamTab(exam) {
  state.examTab = exam;
  $$('.exam-tab').forEach(el => el.classList.toggle('active', el.dataset.exam === exam));
  $$('.exam-pane').forEach(el => el.classList.toggle('active', el.dataset.pane === exam));
  
  // CPAã‚¿ãƒ–é¸æŠæ™‚ã®å‡¦ç†
  if (exam === 'cpa') {
    setCpaVitalDefaults();
    // å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆãŒç©ºã®å ´åˆã¯è‡ªå‹•çš„ã«è¿½åŠ 
    if (state.cpaEvents.length === 0) {
      addCpaEvent();
      // è¿½åŠ å¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      setTimeout(() => {
        const container = $('#cpaEventsContainer');
        if (container && container.children.length > 0) {
          container.children[container.children.length - 1].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }, 100);
    }
  }
  
  save();
}
$$('.exam-tab').forEach(el => { el.addEventListener('click', () => switchExamTab(el.dataset.exam)); });

// å…¥é™¢å¾ŒçµŒé/æ–¹é‡åˆ‡æ›¿
$$('.toggle-group .toggle-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    $$('.toggle-group .toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.activePlan = btn.dataset.plan;
    $$('.plan-section').forEach(s => s.classList.remove('active'));
    $(`#${btn.dataset.plan}Section`).classList.add('active');
    save();
  });
});

function initVitals() {
  // åˆæœŸãƒã‚¤ã‚¿ãƒ«ãŒãªã‘ã‚Œã°1ã¤è¿½åŠ 
  if (!state.vitals || state.vitals.length === 0) {
    addVital();
  } else {
    renderVitals();
  }
  
  $('#addVitalBtn').addEventListener('click', addVital);
}

function addVital() {
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  
  let newVital;
  if (state.vitals.length > 0) {
    // ç›´å‰ã®ãƒã‚¤ã‚¿ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
    const prev = state.vitals[state.vitals.length - 1];
    newVital = {
      time,
      sbp: prev.sbp,
      dbp: prev.dbp,
      hr: prev.hr,
      rr: prev.rr,
      spo2: prev.spo2,
      bt: prev.bt,
      gcs: { e: prev.gcs.e, v: prev.gcs.v, m: prev.gcs.m }
    };
  } else {
    newVital = { time, sbp: 120, dbp: 80, hr: 72, rr: 16, spo2: 98, bt: 36.6, gcs: { e: 4, v: 5, m: 6 } };
  }
  
  state.vitals.push(newVital);
  renderVitals();
  save();
}

function removeVital(idx) {
  if (state.vitals.length <= 1) {
    alert('æœ€ä½1ã¤ã®ãƒã‚¤ã‚¿ãƒ«ãŒå¿…è¦ã§ã™');
    return;
  }
  if (confirm('ã“ã®ãƒã‚¤ã‚¿ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    state.vitals.splice(idx, 1);
    renderVitals();
    save();
  }
}

function setVitalNow(idx) {
  const now = new Date();
  state.vitals[idx].time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  renderVitals();
  save();
}

function renderVitals() {
  const container = $('#vitalsContainer');
  container.innerHTML = '';
  
  state.vitals.forEach((v, idx) => {
    const card = document.createElement('div');
    card.className = 'vital-card';
    card.style.cssText = 'border:1px solid var(--line);border-radius:10px;margin-bottom:10px;overflow:hidden;';
    
    const gcsSum = v.gcs.v === 'T' ? `${v.gcs.e + v.gcs.m}T` : (v.gcs.e + (typeof v.gcs.v === 'string' ? Number(v.gcs.v) : v.gcs.v) + v.gcs.m);
    
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f9fafb;border-bottom:1px solid var(--line);">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-weight:600;font-size:14px;">#${idx + 1}</span>
          <input type="time" value="${v.time}" style="width:100px;padding:6px 8px;border:1px solid var(--line);border-radius:6px;font-size:14px;" data-idx="${idx}" data-field="time">
          <button class="btn btn-sm btn-outline" onclick="setVitalNow(${idx})" style="padding:6px 10px;min-height:32px;">Now</button>
        </div>
        <button class="btn btn-sm btn-danger" onclick="removeVital(${idx})" style="padding:6px 10px;min-height:32px;">å‰Šé™¤</button>
      </div>
      <div style="padding:12px;">
        <div class="vital-grid">
          <b>BP</b>
          <div class="vital-row">
            <select data-idx="${idx}" data-field="sbp" style="width:80px;"></select><span class="unit">/</span>
            <select data-idx="${idx}" data-field="dbp" style="width:70px;"></select><span class="unit">mmHg</span>
          </div>
          <b>HR</b>
          <div class="vital-row">
            <select data-idx="${idx}" data-field="hr" style="width:80px;"></select><span class="unit">bpm</span>
          </div>
          <b>RR</b>
          <div class="vital-row">
            <select data-idx="${idx}" data-field="rr" style="width:70px;"></select><span class="unit">/min</span>
          </div>
          <b>SpOâ‚‚</b>
          <div class="vital-row">
            <select data-idx="${idx}" data-field="spo2" style="width:70px;"></select><span class="unit">%</span>
          </div>
          <b>BT</b>
          <div class="vital-row">
            <select data-idx="${idx}" data-field="bt" style="width:80px;"></select><span class="unit">â„ƒ</span>
          </div>
          <b>GCS</b>
          <div class="vital-row">
            <span class="unit">E</span><select data-idx="${idx}" data-field="gcsE" style="width:50px;"></select>
            <span class="unit">V</span><select data-idx="${idx}" data-field="gcsV" style="width:50px;"></select>
            <span class="unit">M</span><select data-idx="${idx}" data-field="gcsM" style="width:50px;"></select>
            <span class="badge">${gcsSum}</span>
          </div>
        </div>
      </div>
    `;
    
    container.appendChild(card);
    
    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
    const fillSelect = (field, from, to, step = 1) => {
      const sel = card.querySelector(`select[data-field="${field}"]`);
      if (!sel) return;
      for (let i = from; i <= to; i += step) {
        const val = step < 1 ? i.toFixed(1) : String(i);
        sel.appendChild(new Option(val, val));
      }
    };
    
    fillSelect('sbp', 0, 300);
    fillSelect('dbp', 0, 200);
    fillSelect('hr', 0, 250);
    fillSelect('rr', 0, 60);
    fillSelect('spo2', 0, 100);
    fillSelect('bt', 30, 42, 0.1);
    
    const gcsE = card.querySelector('select[data-field="gcsE"]');
    if (gcsE) [4, 3, 2, 1].forEach(n => gcsE.appendChild(new Option(n, n)));
    
    const gcsV = card.querySelector('select[data-field="gcsV"]');
    if (gcsV) ['5', '4', '3', '2', '1', 'T'].forEach(n => gcsV.appendChild(new Option(n, n)));
    
    const gcsM = card.querySelector('select[data-field="gcsM"]');
    if (gcsM) [6, 5, 4, 3, 2, 1].forEach(n => gcsM.appendChild(new Option(n, n)));
    
    // å€¤ã‚’è¨­å®š
    if (card.querySelector('select[data-field="sbp"]')) card.querySelector('select[data-field="sbp"]').value = v.sbp;
    if (card.querySelector('select[data-field="dbp"]')) card.querySelector('select[data-field="dbp"]').value = v.dbp;
    if (card.querySelector('select[data-field="hr"]')) card.querySelector('select[data-field="hr"]').value = v.hr;
    if (card.querySelector('select[data-field="rr"]')) card.querySelector('select[data-field="rr"]').value = v.rr;
    if (card.querySelector('select[data-field="spo2"]')) card.querySelector('select[data-field="spo2"]').value = v.spo2;
    if (card.querySelector('select[data-field="bt"]')) card.querySelector('select[data-field="bt"]').value = v.bt.toFixed ? v.bt.toFixed(1) : v.bt;
    if (card.querySelector('select[data-field="gcsE"]')) card.querySelector('select[data-field="gcsE"]').value = v.gcs.e;
    if (card.querySelector('select[data-field="gcsV"]')) card.querySelector('select[data-field="gcsV"]').value = v.gcs.v === 'T' ? 'T' : v.gcs.v;
    if (card.querySelector('select[data-field="gcsM"]')) card.querySelector('select[data-field="gcsM"]').value = v.gcs.m;
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const timeInput = card.querySelector('input[data-field="time"]');
    if (timeInput) {
      timeInput.addEventListener('change', (e) => {
        state.vitals[idx].time = e.target.value;
        save();
      });
    }
    
    ['sbp', 'dbp', 'hr', 'rr', 'spo2'].forEach(field => {
      const sel = card.querySelector(`select[data-field="${field}"]`);
      if (sel) {
        sel.addEventListener('change', (e) => {
          state.vitals[idx][field] = Number(e.target.value);
          save();
        });
      }
    });
    
    const btSel = card.querySelector('select[data-field="bt"]');
    if (btSel) {
      btSel.addEventListener('change', (e) => {
        state.vitals[idx].bt = Number(e.target.value);
        save();
      });
    }
    
    ['gcsE', 'gcsV', 'gcsM'].forEach(field => {
      const sel = card.querySelector(`select[data-field="${field}"]`);
      if (sel) {
        sel.addEventListener('change', (e) => {
          const gE = Number(card.querySelector('select[data-field="gcsE"]').value);
          const gV = card.querySelector('select[data-field="gcsV"]').value;
          const gM = Number(card.querySelector('select[data-field="gcsM"]').value);
          state.vitals[idx].gcs = { e: gE, v: gV === 'T' ? 'T' : Number(gV), m: gM };
          renderVitals();
          save();
        });
      }
    });
  });
}

// ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ç”»åƒèª­ã¿å–ã‚Šæ©Ÿèƒ½
let vitalReadData = null; // èª­ã¿å–ã£ãŸãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜

function initVitalImageReader() {
  const imageBtn = $('#vitalImageBtn');
  const imageInput = $('#vitalImageInput');
  const statusDiv = $('#vitalReadStatus');
  const resultArea = $('#vitalReadResult');
  const clearBtn = $('#vitalReadClear');
  const applyBtn = $('#vitalApplyBtn');
  
  if (!imageBtn || !imageInput) {
    console.error('Vital image reader elements not found');
    return;
  }
  
  // ç”»åƒèª­ã¿å–ã‚Šãƒœã‚¿ãƒ³
  imageBtn.addEventListener('click', () => {
    const apiKey = localStorage.getItem('gemini_api_key') || '';
    if (!apiKey) {
      statusDiv.style.display = 'block';
      statusDiv.textContent = 'âš ï¸ Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ¤œæŸ»ã‚¿ãƒ–ã®ã€Œâš™ï¸ APIè¨­å®šã€ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚';
      statusDiv.style.color = '#f59e0b';
      return;
    }
    imageInput.click();
  });
  
  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚
  imageInput.addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    
    const apiKey = localStorage.getItem('gemini_api_key') || '';
    if (!apiKey) {
      alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    statusDiv.style.display = 'block';
    statusDiv.textContent = 'ğŸ“· ãƒ¢ãƒ‹ã‚¿ãƒ¼ç”»é¢ã‚’è§£æä¸­...';
    statusDiv.style.color = '#2563eb';
    
    try {
      // æ’®å½±æ™‚åˆ»ã‚’å–å¾—
      const captureTime = new Date();
      const captureTimeStr = `${String(captureTime.getHours()).padStart(2, '0')}:${String(captureTime.getMinutes()).padStart(2, '0')}`;
      
      // ç”»åƒã‚’Base64ã«å¤‰æ›
      const base64 = await fileToBase64(file);
      const base64Data = base64.split(',')[1];
      
      console.log('Reading vital signs from monitor image...');
      
      // Gemini APIå‘¼ã³å‡ºã—
      const result = await callVitalGeminiAPI(apiKey, base64Data);
      console.log('Vital read result:', result);
      
      if (result && result.vitals) {
        vitalReadData = {
          time: captureTimeStr,
          ...result.vitals
        };
        
        // èª­ã¿å–ã£ãŸé …ç›®ã‚’è¡¨ç¤º
        const readItems = [];
        if (vitalReadData.hr) readItems.push('HR');
        if (vitalReadData.sbp && vitalReadData.dbp) readItems.push('BP');
        if (vitalReadData.spo2) readItems.push('SpO2');
        
        renderVitalReadResult();
        statusDiv.style.display = 'block';
        statusDiv.textContent = `âœ… ${readItems.join('ãƒ»')}ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸï¼ˆ${captureTimeStr}ï¼‰`;
        statusDiv.style.color = '#22c55e';
      } else {
        statusDiv.style.display = 'block';
        statusDiv.textContent = 'âš ï¸ ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
        statusDiv.style.color = '#f59e0b';
      }
    } catch (err) {
      console.error('Error reading vital signs:', err);
      statusDiv.style.display = 'block';
      statusDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + (err.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
      statusDiv.style.color = '#ef4444';
    } finally {
      imageInput.value = '';
    }
  });
  
  // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
  clearBtn.addEventListener('click', () => {
    vitalReadData = null;
    resultArea.style.display = 'none';
    statusDiv.style.display = 'none';
  });
  
  // ãƒã‚¤ã‚¿ãƒ«ã«è¿½åŠ ãƒœã‚¿ãƒ³
  applyBtn.addEventListener('click', () => {
    if (!vitalReadData) return;
    
    // ç·¨é›†ã•ã‚ŒãŸå€¤ã‚’å–å¾—
    const editHr = $('#editHr')?.value;
    const editSbp = $('#editSbp')?.value;
    const editDbp = $('#editDbp')?.value;
    const editSpo2 = $('#editSpo2')?.value;

    // æ–°ã—ã„ãƒã‚¤ã‚¿ãƒ«ã¨ã—ã¦è¿½åŠ 
    const newVital = {
      time: vitalReadData.time,
      sbp: editSbp ? Number(editSbp) : 120,
      dbp: editDbp ? Number(editDbp) : 80,
      hr: editHr ? Number(editHr) : 72,
      rr: 16, // ãƒ¢ãƒ‹ã‚¿ãƒ¼èª­ã¿å–ã‚Šã§ã¯å–å¾—ã—ãªã„ã®ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      spo2: editSpo2 ? Number(editSpo2) : 98,
      bt: 36.6, // ãƒ¢ãƒ‹ã‚¿ãƒ¼èª­ã¿å–ã‚Šã§ã¯å–å¾—ã—ãªã„ã®ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      gcs: { e: 4, v: 5, m: 6 }
    };
    
    state.vitals.push(newVital);
    renderVitals();
    save();
    
    // çµæœã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
    vitalReadData = null;
    resultArea.style.display = 'none';
    statusDiv.style.display = 'block';
    statusDiv.textContent = 'âœ… ãƒã‚¤ã‚¿ãƒ«ã«è¿½åŠ ã—ã¾ã—ãŸï¼ˆRRãƒ»BTãƒ»GCSã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰';
    statusDiv.style.color = '#22c55e';
    
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 2000);
  });
  
  console.log('Vital image reader initialized');
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Gemini APIã§ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã‚’èª­ã¿å–ã‚Š
async function callVitalGeminiAPI(apiKey, imageBase64) {
  const prompt = `åŒ»ç™‚ç”¨ãƒ¢ãƒ‹ã‚¿ãƒ¼ç”»é¢ã‹ã‚‰ã€ä»¥ä¸‹ã®3ã¤ã®ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã®ã¿ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚

ã€èª­ã¿å–ã‚Šå¯¾è±¡ã€‘

1. **å¿ƒæ‹æ•°ï¼ˆHRï¼‰**
   - ç·‘è‰²ã®æ³¢å½¢ã«å¯¾å¿œã™ã‚‹æ•°å€¤
   - ç”»é¢ä¸Šã§ç·‘è‰²ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å¤§ããªæ•°å­—
   - é€šå¸¸30-250ã®ç¯„å›²

2. **è¡€åœ§ï¼ˆBPï¼‰**
   - èµ¤è‰²ã®æ³¢å½¢ã«å¯¾å¿œã™ã‚‹æ•°å€¤
   - ã€Œ120/80ã€ã®ã‚ˆã†ã«ã€Œ/ï¼ˆã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼‰ã€ã§åŒºåˆ‡ã‚‰ã‚ŒãŸæ•°å­—
   - åç¸®æœŸè¡€åœ§/æ‹¡å¼µæœŸè¡€åœ§ã®å½¢å¼
   - æ‹¬å¼§å†…ã®æ•°å­—ï¼ˆä¾‹ï¼š(91)ï¼‰ã¯å¹³å‡è¡€åœ§ãªã®ã§ç„¡è¦–

3. **é…¸ç´ é£½å’Œåº¦ï¼ˆSpO2ï¼‰**
   - é’è‰²ã¾ãŸã¯æ°´è‰²ã®æ³¢å½¢ã«å¯¾å¿œã™ã‚‹æ•°å€¤
   - é€šå¸¸70-100ã®ç¯„å›²
   - ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤º

ã€é‡è¦ãªãƒ«ãƒ¼ãƒ«ã€‘
- æ³¢å½¢ã®è‰²ã¨å¯¾å¿œã™ã‚‹å¤§ããªæ•°å­—ã‚’è¦‹ã¤ã‘ã‚‹
- æœ€ã‚‚å¤§ããè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ•°å€¤ã‚’é¸æŠ
- æ‹¬å¼§å†…ã®æ•°å­—ã¯ç„¡è¦–
- å°ã•ã„è£œåŠ©çš„ãªæ•°å­—ã¯ç„¡è¦–
- ã“ã‚Œã‚‰3é …ç›®ä»¥å¤–ï¼ˆä½“æ¸©ã€å‘¼å¸æ•°ãªã©ï¼‰ã¯èª­ã¿å–ã‚‰ãªã„

ã€å‡ºåŠ›JSONå½¢å¼ã€‘
{
  "vitals": {
    "hr": 120,
    "sbp": 120,
    "dbp": 80,
    "spo2": 95
  }
}

â€»å¿…ãšJSONã®ã¿ã‚’å‡ºåŠ›ï¼ˆèª¬æ˜æ–‡ã¯ä¸è¦ï¼‰
â€»èª­ã¿å–ã‚Œãªã„é …ç›®ãŒã‚ã‚Œã°ã€ãã®é …ç›®ã¯çœç•¥`;

  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=${apiKey}`;
  
  const response = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{
        parts: [
          {
            inline_data: {
              mime_type: 'image/jpeg',
              data: imageBase64
            }
          },
          { text: prompt }
        ]
      }]
    })
  });
  
  if (!response.ok) {
    const errorData = await response.json().catch(() => ({}));
    throw new Error(errorData.error?.message || `API error: ${response.status}`);
  }
  
  const data = await response.json();
  console.log('Gemini API response:', data);
  const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
  console.log('Extracted text:', text);
  
  // JSONã‚’æŠ½å‡º
  let jsonText = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
  
  try {
    const parsed = JSON.parse(jsonText);
    console.log('Parsed vital data:', parsed);
    return parsed;
  } catch (e) {
    console.error('JSON parse error:', e, 'Text:', jsonText);
    throw new Error('APIã‹ã‚‰ã®å¿œç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ');
  }
}

// èª­ã¿å–ã‚Šçµæœã‚’è¡¨ç¤º
function renderVitalReadResult() {
  const resultArea = $('#vitalReadResult');
  const dataDiv = $('#vitalReadData');
  const timeInput = $('#vitalReadTime');
  
  if (!vitalReadData) {
    resultArea.style.display = 'none';
    return;
  }
  
  resultArea.style.display = 'block';
  
  // æ™‚åˆ»ã‚’è¨­å®š
  if (timeInput) {
    timeInput.value = vitalReadData.time;
    // æ™‚åˆ»å¤‰æ›´æ™‚ã«vitalReadDataã‚‚æ›´æ–°
    timeInput.oninput = (e) => {
      vitalReadData.time = e.target.value;
    };
  }
  
  const items = [];
  
  // HRï¼ˆå¿ƒæ‹æ•°ï¼‰
  if (vitalReadData.hr) {
    items.push(`
      <b>HR</b>
      <div style="display:flex;gap:4px;align-items:center;">
        <input type="number" id="editHr" value="${vitalReadData.hr}" style="width:80px;padding:4px 8px;border:1px solid var(--line);border-radius:6px;font-size:14px;" min="30" max="250">
        <span class="unit">/min</span>
      </div>
    `);
  }
  
  // BPï¼ˆè¡€åœ§ï¼‰
  if (vitalReadData.sbp && vitalReadData.dbp) {
    items.push(`
      <b>BP</b>
      <div style="display:flex;gap:4px;align-items:center;">
        <input type="number" id="editSbp" value="${vitalReadData.sbp}" style="width:70px;padding:4px 8px;border:1px solid var(--line);border-radius:6px;font-size:14px;" min="60" max="250">
        <span>/</span>
        <input type="number" id="editDbp" value="${vitalReadData.dbp}" style="width:70px;padding:4px 8px;border:1px solid var(--line);border-radius:6px;font-size:14px;" min="30" max="150">
        <span class="unit">mmHg</span>
      </div>
    `);
  }
  
  // SpO2ï¼ˆé…¸ç´ é£½å’Œåº¦ï¼‰
  if (vitalReadData.spo2) {
    items.push(`
      <b>SpOâ‚‚</b>
      <div style="display:flex;gap:4px;align-items:center;">
        <input type="number" id="editSpo2" value="${vitalReadData.spo2}" style="width:70px;padding:4px 8px;border:1px solid var(--line);border-radius:6px;font-size:14px;" min="70" max="100">
        <span class="unit">%</span>
      </div>
    `);
  }
  
  dataDiv.innerHTML = items.join('');
  
  // ç·¨é›†ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
  const updateValue = (id, field) => {
    const input = document.getElementById(id);
    if (input) {
      input.oninput = (e) => {
        const value = parseFloat(e.target.value);
        if (!isNaN(value)) {
          vitalReadData[field] = value;
          console.log(`Updated ${field}:`, value);
        }
      };
    }
  };
  
  updateValue('editHr', 'hr');
  updateValue('editSbp', 'sbp');
  updateValue('editDbp', 'dbp');
  updateValue('editSpo2', 'spo2');
}

function vitalText() {
  if (!state.vitals || state.vitals.length === 0) return 'ï¼ˆæœªå…¥åŠ›ï¼‰';
  
  return state.vitals.map((v, idx) => {
    const isCpaMode = state.examTab === 'cpa' || (v.sbp === 0 && v.hr === 0 && v.rr === 0);
    const g = v.gcs;
    const gcsVVal = typeof g.v === 'string' ? g.v : (g.v || 1);
    const gcsSum = g.v === 'T' ? `${g.e + g.m}T` : (g.e + (typeof g.v === 'string' ? Number(g.v) : g.v) + g.m);
    const gTxt = gcsVVal === 'T' ? `E${g.e}VTM${g.m}` : `E${g.e}V${gcsVVal}M${g.m}(${gcsSum})`;
    const timeStr = v.time ? `${v.time} ` : '';
    
    if (isCpaMode) {
      // CPAãƒ¢ãƒ¼ãƒ‰ï¼š0å€¤ã¯ã€Œ-ã€ã€SpO2ã¯ã€Œæ¸¬å®šä¸èƒ½ã€ã€BTã¯å®Ÿæ¸¬å€¤
      const bpTxt = (v.sbp === 0 && v.dbp === 0) ? '-/-' : `${v.sbp}/${v.dbp}`;
      const hrTxt = v.hr === 0 ? '-' : v.hr;
      const rrTxt = v.rr === 0 ? '-' : v.rr;
      const spo2Txt = v.spo2 === 0 ? 'æ¸¬å®šä¸èƒ½' : `${v.spo2}%`;
      const btTxt = v.bt === 0 ? '-' : (typeof v.bt === 'number' ? v.bt.toFixed(1) : v.bt);
      
      return `${timeStr}BP ${bpTxt}, HR ${hrTxt}, RR ${rrTxt}, SpOâ‚‚ ${spo2Txt}, BT ${btTxt}â„ƒ, GCS ${gTxt}`;
    } else {
      // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
      return `${timeStr}BP ${v.sbp}/${v.dbp}, HR ${v.hr}, RR ${v.rr}, SpOâ‚‚ ${v.spo2}%, BT ${typeof v.bt === 'number' ? v.bt.toFixed(1) : v.bt}â„ƒ, GCS ${gTxt}`;
    }
  }).join('\n');
}

function mkChip(label, mode) {
  const el = document.createElement('span');
  el.className = 'chip';
  el.textContent = label;
  el.dataset.state = state.chips[label] || '';
  el.addEventListener('click', () => {
    const cur = el.dataset.state || '';
    let next = '';
    if (mode === 'normal') { next = cur === 'on' ? '' : 'on'; }
    else { next = cur === '' ? '+' : (cur === '+' ? '-' : ''); }
    el.dataset.state = next;
    if (next) state.chips[label] = next;
    else delete state.chips[label];
    save();
  });
  return el;
}

function mountChips() {
  Object.entries(GEN_GROUPS).forEach(([key, def]) => {
    const box = $(`#gen-${key}`);
    box.innerHTML = '';
    (def.normal || []).forEach(lbl => box.appendChild(mkChip(lbl, 'normal')));
    (def.abn || []).forEach(lbl => box.appendChild(mkChip(lbl, 'abn')));
  });
  Object.entries(TRA_GROUPS).forEach(([key, arr]) => {
    const box = $(`#tra-${key}`);
    box.innerHTML = '';
    arr.forEach(lbl => box.appendChild(mkChip(lbl, 'abn')));
  });
  const cnBox = $('#str-cn');
  cnBox.innerHTML = '';
  STR_CNs.forEach(lbl => cnBox.appendChild(mkChip(lbl, 'abn')));
  const higherBox = $('#str-higher');
  higherBox.innerHTML = '';
  STR_HIGHER.forEach(lbl => higherBox.appendChild(mkChip(lbl, 'abn')));
}

function initStroke() {
  const pupilOpts = [''];
  for (let i = 10; i <= 90; i += 5) pupilOpts.push((i / 10).toFixed(1));
  ['#pupilL', '#pupilR'].forEach(id => {
    const sel = $(id);
    sel.innerHTML = '';
    pupilOpts.forEach(v => sel.appendChild(new Option(v, v)));
    sel.value = state.stroke[id.slice(1).toLowerCase()] || '';
    sel.addEventListener('change', () => { state.stroke[id.slice(1).toLowerCase()] = sel.value; save(); });
  });
  
  const mmtOpts = ['', '0', '1', '2', '3', '4', '5'];
  ['#mmtRU', '#mmtRL', '#mmtLU', '#mmtLL'].forEach(id => {
    const sel = $(id);
    sel.innerHTML = '';
    mmtOpts.forEach(v => sel.appendChild(new Option(v, v)));
    const key = id.slice(4).toLowerCase();
    sel.value = state.stroke.mmt[key] || '';
    sel.addEventListener('change', () => { state.stroke.mmt[key] = sel.value; save(); });
  });
  
  ['#plrL', '#plrR', '#gaze', '#nyst', '#btr', '#ptr'].forEach(id => {
    const sel = $(id);
    const key = id.slice(1);
    sel.value = state.stroke[key] || '';
    sel.addEventListener('change', () => { state.stroke[key] = sel.value; save(); });
  });
  
  $('#babinski').checked = state.stroke.babinski;
  $('#chaddock').checked = state.stroke.chaddock;
  $('#babinski').addEventListener('change', () => { state.stroke.babinski = $('#babinski').checked; save(); });
  $('#chaddock').addEventListener('change', () => { state.stroke.chaddock = $('#chaddock').checked; save(); });
  
  initNIHSS();
}

function initNIHSS() {
  const body = $('#nihssBody');
  body.innerHTML = '';
  NIHSS_ITEMS.forEach(item => {
    const row = document.createElement('div');
    row.className = 'nih-row';
    row.innerHTML = `
      <b>${item.label}</b>
      <div class="hint">${item.hint}</div>
      <select data-nih="${item.key}">
        ${Array.from({ length: item.max + 1 }, (_, i) => `<option value="${i}">${i}</option>`).join('')}
      </select>
    `;
    body.appendChild(row);
  });
  
  $$('[data-nih]').forEach(sel => {
    const key = sel.dataset.nih;
    sel.value = state.stroke.nih[key] || 0;
    sel.addEventListener('change', () => { state.stroke.nih[key] = Number(sel.value); updateNIHSS(); save(); });
  });
  
  const memo = document.createElement('div');
  memo.className = 'form-row mt-2';
  memo.innerHTML = `<label>NIHSSãƒ¡ãƒ¢</label><textarea id="nihMemo" rows="2" placeholder="è©•ä¾¡ãƒ¡ãƒ¢"></textarea>`;
  body.appendChild(memo);
  $('#nihMemo').value = state.stroke.nihMemo || '';
  $('#nihMemo').addEventListener('input', () => { state.stroke.nihMemo = $('#nihMemo').value; save(); });
  
  updateNIHSS();
}

function updateNIHSS() {
  let sum = 0;
  NIHSS_ITEMS.forEach(item => { sum += Number(state.stroke.nih[item.key] || 0); });
  $('#nihSum').textContent = `åˆè¨ˆ ${sum}`;
}

function bindMemos() {
  ['head', 'resp', 'card', 'abd', 'limb', 'neuro'].forEach(key => {
    const el = $(`#memo-gen-${key}`);
    el.value = state.memos.general[key] || '';
    el.addEventListener('input', () => { state.memos.general[key] = el.value; save(); });
  });
  ['head', 'neck', 'chest', 'abd', 'pelvis', 'limb'].forEach(key => {
    const el = $(`#memo-tra-${key}`);
    el.value = state.memos.trauma[key] || '';
    el.addEventListener('input', () => { state.memos.trauma[key] = el.value; save(); });
  });
  ['ru', 'rl', 'lu', 'll'].forEach(key => {
    const el = $(`#tra-${key}`);
    el.value = state.trauma[key] || '';
    el.addEventListener('input', () => { state.trauma[key] = el.value; save(); });
  });
  ['cn', 'eye', 'motor', 'reflex', 'higher'].forEach(key => {
    const el = $(`#memo-str-${key}`);
    el.value = state.memos.stroke[key] || '';
    el.addEventListener('input', () => { state.memos.stroke[key] = el.value; save(); });
  });
  $('#examFree').value = state.examFree || '';
  $('#examFree').addEventListener('input', () => { state.examFree = $('#examFree').value; save(); });
}

function initLabs() {
  const catSel = $('#labCat');
  const itemSel = $('#labItem');
  
  function fillItems() {
    const cat = catSel.value;
    itemSel.innerHTML = '';
    LABS[cat].items.forEach(([k]) => itemSel.appendChild(new Option(k, k)));
  }
  
  catSel.addEventListener('change', () => { fillItems(); renderLabEdit(); });
  
  $('#labAdd').addEventListener('click', () => {
    const cat = catSel.value;
    const item = itemSel.value;
    if (!item) return;
    const unit = (LABS[cat].items.find(x => x[0] === item) || ['', ''])[1];
    if (!state.labs[cat].some(x => x.item === item)) {
      const def = (NORMALS[cat] || {})[item] || '';
      state.labs[cat].push({ item, unit, val: def });
      
      // LABSã®å®šç¾©é †åºã«ä¸¦ã¹æ›¿ãˆ
      const definedOrder = LABS[cat].items.map(([item]) => item);
      state.labs[cat].sort((a, b) => {
        const indexA = definedOrder.indexOf(a.item);
        const indexB = definedOrder.indexOf(b.item);
        if (indexA !== -1 && indexB !== -1) return indexA - indexB;
        if (indexA === -1) return 1;
        if (indexB === -1) return -1;
        return 0;
      });
    }
    renderLabEdit();
    save();
  });
  
  const addSet = (cat) => {
    LABS[cat].items.forEach(([k, u]) => {
      const existing = state.labs[cat].find(x => x.item === k);
      if (!existing) {
        // é …ç›®ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿åŸºæº–å€¤ã§è¿½åŠ 
        state.labs[cat].push({ item: k, unit: u, val: (NORMALS[cat] || {})[k] || '' });
      }
      // æ—¢ã«é …ç›®ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆæ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆä¿è­·ï¼‰
    });
    
    // LABSã®å®šç¾©é †åºã«ä¸¦ã¹æ›¿ãˆ
    const definedOrder = LABS[cat].items.map(([item]) => item);
    state.labs[cat].sort((a, b) => {
      const indexA = definedOrder.indexOf(a.item);
      const indexB = definedOrder.indexOf(b.item);
      if (indexA !== -1 && indexB !== -1) return indexA - indexB;
      if (indexA === -1) return 1;
      if (indexB === -1) return -1;
      return 0;
    });
    
    catSel.value = cat;
    fillItems();
    renderLabEdit();
    save();
  };
  
  // ä¸€å¼ã‚»ãƒƒãƒˆï¼ˆè¡€ç®—+ç”ŸåŒ–+å‡å›º+è¡€ã‚¬ã‚¹+BNP+HbA1c+å°¿å®šæ€§+æ²ˆæ¸£ï¼‰
  $('#labSetAll').addEventListener('click', () => {
    ['cbc', 'chem', 'coag', 'gas', 'urine', 'sediment'].forEach(cat => {
      LABS[cat].items.forEach(([k, u]) => {
        const existing = state.labs[cat].find(x => x.item === k);
        if (!existing) {
          // é …ç›®ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿åŸºæº–å€¤ã§è¿½åŠ 
          state.labs[cat].push({ item: k, unit: u, val: (NORMALS[cat] || {})[k] || '' });
        }
        // æ—¢ã«é …ç›®ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆæ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆä¿è­·ï¼‰
      });
      
      // LABSã®å®šç¾©é †åºã«ä¸¦ã¹æ›¿ãˆ
      const definedOrder = LABS[cat].items.map(([item]) => item);
      state.labs[cat].sort((a, b) => {
        const indexA = definedOrder.indexOf(a.item);
        const indexB = definedOrder.indexOf(b.item);
        if (indexA !== -1 && indexB !== -1) return indexA - indexB;
        if (indexA === -1) return 1;
        if (indexB === -1) return -1;
        return 0;
      });
    });
    // BNP, HbA1cè¿½åŠ 
    if (!state.labs.sugar.some(x => x.item === 'BNP')) {
      state.labs.sugar.push({ item: 'BNP', unit: 'pg/mL', val: '' });
    }
    if (!state.labs.sugar.some(x => x.item === 'HbA1c')) {
      state.labs.sugar.push({ item: 'HbA1c', unit: '%', val: '' });
    }
    renderLabEdit();
    save();
  });
  
  $('#labSetCBC').addEventListener('click', () => addSet('cbc'));
  $('#labSetChem').addEventListener('click', () => addSet('chem'));
  $('#labSetCoag').addEventListener('click', () => addSet('coag'));
  $('#labSetGas').addEventListener('click', () => addSet('gas'));
  $('#labSetUrine').addEventListener('click', () => { addSet('urine'); addSet('sediment'); });
  
  fillItems();
  renderLabEdit();
  
  $('#labFree').value = state.labFree || '';
  $('#labFree').addEventListener('input', () => { state.labFree = $('#labFree').value; save(); });
}

function renderLabEdit() {
  const cat = $('#labCat').value;
  const area = $('#labEditArea');
  area.innerHTML = '';
  
  if (!state.labs[cat].length) {
    area.innerHTML = '<p class="small">ã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã¾ãŸã¯è¿½åŠ ã§é …ç›®ã‚’è¿½åŠ </p>';
    return;
  }
  
  const pills = document.createElement('div');
  pills.className = 'lab-pills';
  
  state.labs[cat].forEach((rec, idx) => {
    const pill = document.createElement('div');
    pill.className = 'lab-pill';
    pill.innerHTML = `
      <label>${rec.item}</label>
      <input type="text" inputmode="decimal" value="${rec.val || ''}" placeholder="å€¤">
      <span class="unit">${rec.unit}</span>
      <button class="del">Ã—</button>
    `;
    const inp = pill.querySelector('input');
    inp.addEventListener('input', () => { rec.val = inp.value; save(); });
    inp.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const allInputs = [...area.querySelectorAll('.lab-pill input')];
        const i = allInputs.indexOf(inp);
        if (allInputs[i + 1]) { allInputs[i + 1].focus(); allInputs[i + 1].select(); }
      }
    });
    pill.querySelector('.del').addEventListener('click', () => { state.labs[cat].splice(idx, 1); renderLabEdit(); save(); });
    pills.appendChild(pill);
  });
  
  area.appendChild(pills);
}

// ãƒ†ã‚­ã‚¹ãƒˆè²¼ã‚Šä»˜ã‘ã‹ã‚‰æ¤œæŸ»å€¤ã‚’èª­ã¿å–ã‚‹æ©Ÿèƒ½
let ocrResults = {}; // èª­ã¿å–ã‚Šçµæœã‚’ä¸€æ™‚ä¿å­˜

function initLabOCR() {
  const pasteBtn = $('#labPasteBtn');
  const pasteArea = $('#pasteArea');
  const pasteText = $('#labPasteText');
  const parseBtn = $('#labParseBtn');
  const cancelBtn = $('#labPasteCancelBtn');
  const status = $('#pasteStatus');
  
  // è²¼ã‚Šä»˜ã‘ãƒœã‚¿ãƒ³
  pasteBtn.addEventListener('click', () => {
    pasteArea.style.display = pasteArea.style.display === 'none' ? 'block' : 'none';
    if (pasteArea.style.display === 'block') {
      pasteText.focus();
    }
  });
  
  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
  cancelBtn.addEventListener('click', () => {
    pasteArea.style.display = 'none';
    pasteText.value = '';
    status.style.display = 'none';
  });
  
  // è§£æãƒœã‚¿ãƒ³
  parseBtn.addEventListener('click', () => {
    const text = pasteText.value.trim();
    if (!text) {
      status.style.display = 'block';
      status.innerHTML = 'âš ï¸ ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      status.style.color = '#f59e0b';
      return;
    }
    
    const labData = parseLabText(text);
    
    if (labData && Object.keys(labData).length > 0) {
      ocrResults = labData;
      renderOcrResults();
      status.style.display = 'block';
      status.innerHTML = `âœ… ${Object.keys(labData).length}é …ç›®ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ã€Œæ¤œæŸ»å€¤ã«åæ˜ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`;
      status.style.color = '#22c55e';
      pasteArea.style.display = 'none';
    } else {
      status.style.display = 'block';
      status.innerHTML = 'âš ï¸ æ¤œæŸ»å€¤ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      status.style.color = '#f59e0b';
    }
  });
  
  // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
  const ocrClearBtn = $('#ocrClearBtn');
  if (ocrClearBtn) {
    ocrClearBtn.addEventListener('click', () => {
      console.log('ocrClearBtn clicked');
      ocrResults = {};
      $('#ocrResultArea').style.display = 'none';
      status.style.display = 'none';
    });
  }
  
  // æ¤œæŸ»å€¤ã«åæ˜ ãƒœã‚¿ãƒ³
  const ocrApplyBtn = $('#ocrApplyBtn');
  if (ocrApplyBtn) {
    ocrApplyBtn.addEventListener('click', () => {
      console.log('ocrApplyBtn clicked');
      console.log('ocrResults:', ocrResults);
      
      if (Object.keys(ocrResults).length === 0) {
        status.style.display = 'block';
        status.innerHTML = 'âš ï¸ åæ˜ ã™ã‚‹æ¤œæŸ»å€¤ãŒã‚ã‚Šã¾ã›ã‚“';
        status.style.color = '#f59e0b';
        return;
      }
      
      const addedCount = applyLabData(ocrResults);
      console.log('Added count:', addedCount);
      
      if (addedCount > 0) {
        status.style.display = 'block';
        status.innerHTML = `âœ… ${addedCount}é …ç›®ã‚’æ¤œæŸ»å€¤ã«åæ˜ ã—ã¾ã—ãŸ`;
        status.style.color = '#22c55e';
        
        // åæ˜ ã—ãŸã‚‰OCRçµæœã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
        setTimeout(() => {
          ocrResults = {};
          $('#ocrResultArea').style.display = 'none';
        }, 2000);
      } else {
        status.style.display = 'block';
        status.innerHTML = 'âš ï¸ åæ˜ ã§ãã‚‹æ¤œæŸ»å€¤ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆé …ç›®åã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰';
        status.style.color = '#f59e0b';
      }
    });
  } else {
    console.error('ocrApplyBtn not found!');
  }
}

// Gemini API è¨­å®šã¨APIå‘¼ã³å‡ºã—
function initGeminiAPI() {
  const GEMINI_API_KEY_STORAGE = 'gemini_api_key';
  
  // APIã‚­ãƒ¼å–å¾—
  function getApiKey() {
    return localStorage.getItem(GEMINI_API_KEY_STORAGE) || '';
  }
  
  // APIã‚­ãƒ¼ä¿å­˜
  function saveApiKey(key) {
    localStorage.setItem(GEMINI_API_KEY_STORAGE, key);
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
  const modal = $('#geminiModal');
  const settingsBtn = $('#geminiSettingsBtn');
  const closeBtn = $('#geminiModalClose');
  const cancelBtn = $('#geminiCancelBtn');
  const saveBtn = $('#geminiSaveBtn');
  const apiKeyInput = $('#geminiApiKey');
  const statusDiv = $('#geminiStatus');
  
  if (!modal || !settingsBtn || !closeBtn || !cancelBtn || !saveBtn || !apiKeyInput || !statusDiv) {
    console.error('Gemini modal elements not found');
    return;
  }
  
  settingsBtn.addEventListener('click', () => {
    console.log('Settings button clicked');
    apiKeyInput.value = getApiKey();
    modal.style.display = 'block';
    statusDiv.style.display = 'none';
  });
  
  closeBtn.addEventListener('click', () => {
    modal.style.display = 'none';
  });
  
  cancelBtn.addEventListener('click', () => {
    modal.style.display = 'none';
  });
  
  saveBtn.addEventListener('click', () => {
    const key = apiKeyInput.value.trim();
    if (!key) {
      statusDiv.style.display = 'block';
      statusDiv.style.color = '#ef4444';
      statusDiv.textContent = 'âš ï¸ APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      return;
    }
    saveApiKey(key);
    statusDiv.style.display = 'block';
    statusDiv.style.color = '#22c55e';
    statusDiv.textContent = 'âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ';
    setTimeout(() => {
      modal.style.display = 'none';
    }, 1500);
  });
  
  // ç”»åƒèª­ã¿å–ã‚Š
  const imageBtn = $('#geminiImageBtn');
  const imageInput = $('#geminiImageInput');
  const pasteStatus = $('#pasteStatus');
  
  if (!imageBtn || !imageInput || !pasteStatus) {
    console.error('Gemini image elements not found:', {
      imageBtn: !!imageBtn,
      imageInput: !!imageInput,
      pasteStatus: !!pasteStatus
    });
    return;
  }
  
  console.log('Gemini API initialized successfully');
  
  imageBtn.addEventListener('click', () => {
    console.log('Image button clicked');
    const apiKey = getApiKey();
    if (!apiKey) {
      pasteStatus.style.display = 'block';
      pasteStatus.textContent = 'âš ï¸ Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€Œâš™ï¸ APIè¨­å®šã€ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚';
      pasteStatus.style.color = '#f59e0b';
      return;
    }
    console.log('API key found, opening file picker');
    imageInput.click();
  });
  
  imageInput.addEventListener('change', async (e) => {
    console.log('File input changed');
    const file = e.target.files && e.target.files[0];
    if (!file) {
      console.log('No file selected');
      return;
    }
    
    console.log('File selected:', file.name, file.type, file.size);
    
    const apiKey = getApiKey();
    if (!apiKey) {
      alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    pasteStatus.style.display = 'block';
    pasteStatus.textContent = 'ğŸ“· ç”»åƒã‚’è§£æä¸­...';
    pasteStatus.style.color = '#2563eb';
    
    try {
      console.log('Converting file to base64...');
      // ç”»åƒã‚’Base64ã«å¤‰æ›
      const base64 = await fileToBase64(file);
      const base64Data = base64.split(',')[1]; // data:image/jpeg;base64, ã‚’é™¤å»
      console.log('Base64 conversion complete, length:', base64Data.length);
      
      console.log('Calling Gemini API...');
      // Gemini API å‘¼ã³å‡ºã—
      const result = await callGeminiAPI(apiKey, base64Data);
      console.log('API result:', result);
      
      if (result && result.items && result.items.length > 0) {
        ocrResults = {};
        result.items.forEach(item => {
          if (item.key && item.value !== undefined) {
            ocrResults[item.key] = {
              value: item.value,
              unit: item.unit || ''
            };
          }
        });
        
        console.log('OCR results:', ocrResults);
        
        // å†™çœŸã‚’ä¿å­˜
        state.lastLabImage = base64; // ãƒ•ãƒ«ã®Base64ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆdata:image/jpeg;base64,ã‚’å«ã‚€ï¼‰
        save();
        renderSavedLabImage();
        
        renderOcrResults();
        pasteStatus.style.display = 'block';
        pasteStatus.textContent = `âœ… ${result.items.length}é …ç›®ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ`;
        pasteStatus.style.color = '#22c55e';
      } else {
        console.log('No items found in result');
        pasteStatus.style.display = 'block';
        pasteStatus.textContent = 'âš ï¸ æ¤œæŸ»å€¤ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
        pasteStatus.style.color = '#f59e0b';
      }
    } catch (err) {
      console.error('Error during image processing:', err);
      pasteStatus.style.display = 'block';
      pasteStatus.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + (err.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
      pasteStatus.style.color = '#ef4444';
    } finally {
      imageInput.value = '';
    }
  });
  
  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
  
  // Gemini API å‘¼ã³å‡ºã—
  async function callGeminiAPI(apiKey, imageBase64) {
    const LABEL_MAP = {
      // è¡€ç®—
      'ç™½è¡€çƒ': 'WBC', 'ç™½è¡€çƒæ•°': 'WBC', 'WBC': 'WBC',
      'èµ¤è¡€çƒ': 'RBC', 'èµ¤è¡€çƒæ•°': 'RBC', 'RBC': 'RBC',
      'è¡€è‰²ç´ ': 'Hb', 'ãƒ˜ãƒ¢ã‚°ãƒ­ãƒ“ãƒ³': 'Hb', 'Hb': 'Hb', 'HB': 'Hb',
      'ãƒ˜ãƒãƒˆã‚¯ãƒªãƒƒãƒˆ': 'Ht', 'Ht': 'Ht', 'HT': 'Ht', 'Hct': 'Ht',
      'è¡€å°æ¿': 'Plt', 'è¡€å°æ¿æ•°': 'Plt', 'Plt': 'Plt', 'PLT': 'Plt',
      
      // ç”ŸåŒ–å­¦
      'ãƒŠãƒˆãƒªã‚¦ãƒ ': 'Na', 'Na': 'Na', 'NA': 'Na',
      'ã‚«ãƒªã‚¦ãƒ ': 'K', 'K': 'K',
      'ã‚¯ãƒ­ãƒ¼ãƒ«': 'Cl', 'Cl': 'Cl', 'CL': 'Cl',
      'å°¿ç´ çª’ç´ ': 'BUN', 'BUN': 'BUN',
      'ã‚¯ãƒ¬ã‚¢ãƒãƒ‹ãƒ³': 'Cr', 'Cr': 'Cr', 'CR': 'Cr', 'Crn': 'Cr', 'CRE': 'Cr',
      'ç·è›‹ç™½': 'TP', 'ç·ã‚¿ãƒ³ãƒ‘ã‚¯': 'TP', 'TP': 'TP',
      'ã‚¢ãƒ«ãƒ–ãƒŸãƒ³': 'Alb', 'Alb': 'Alb', 'ALB': 'Alb',
      'ç·ãƒ“ãƒªãƒ«ãƒ“ãƒ³': 'T-bil', 'T-bil': 'T-bil', 'Tbil': 'T-bil', 'T-Bil': 'T-bil', 'TB': 'T-bil',
      'ç›´æ¥ãƒ“ãƒªãƒ«ãƒ“ãƒ³': 'D-bil', 'D-bil': 'D-bil', 'Dbil': 'D-bil', 'D-Bil': 'D-bil', 'DB': 'D-bil',
      'AST': 'AST', 'GOT': 'AST', 'AST(GOT)': 'AST',
      'ALT': 'ALT', 'GPT': 'ALT', 'ALT(GPT)': 'ALT',
      'ALP': 'ALP',
      'Î³GTP': 'Î³-GTP', 'Î³-GTP': 'Î³-GTP', 'GGT': 'Î³-GTP', 'yGTP': 'Î³-GTP', 'Y-GTP': 'Î³-GTP',
      'LDH': 'LDH', 'LD': 'LDH',
      'CK': 'CK', 'CPK': 'CK',
      'ã‚¢ãƒŸãƒ©ãƒ¼ã‚¼': 'Amy', 'AMY': 'Amy', 'Amy': 'Amy',
      'ãƒªãƒ‘ãƒ¼ã‚¼': 'Lip', 'LIPA': 'Lip', 'Lip': 'Lip',
      'è¡€ç³–': 'Glu', 'ã‚°ãƒ«ã‚³ãƒ¼ã‚¹': 'Glu', 'Glu': 'Glu', 'GLU': 'Glu', 'BS': 'Glu',
      'HbA1c': 'HbA1c', 'ãƒ˜ãƒ¢ã‚°ãƒ­ãƒ“ãƒ³A1c': 'HbA1c',
      
      // å‡å›º
      'PT': 'PT', 'PT-INR': 'PT-INR', 'INR': 'PT-INR',
      'APTT': 'APTT', 'aPTT': 'APTT',
      'ãƒ•ã‚£ãƒ–ãƒªãƒã‚²ãƒ³': 'Fib', 'Fib': 'Fib',
      'Dãƒ€ã‚¤ãƒãƒ¼': 'D-dimer', 'D-dimer': 'D-dimer', 'DD': 'D-dimer',
      
      // è¡€æ¶²ã‚¬ã‚¹
      'pH': 'pH',
      'PaCO2': 'PaCO2', 'pCO2': 'PaCO2',
      'PaO2': 'PaO2', 'pO2': 'pO2',
      'HCO3': 'HCO3-', 'HCO3-': 'HCO3-',
      'BE': 'BE',
      'Lac': 'Lac', 'ä¹³é…¸': 'Lac',
      
      // å°¿å®šæ€§ï¼ˆå°¿æ¤œæŸ»ã®é …ç›®ã¯æ˜ç¢ºã«åŒºåˆ¥ï¼‰
      'æ¯”é‡': 'æ¯”é‡',
      'æ½œè¡€': 'æ½œè¡€', 'å°¿æ½œè¡€': 'æ½œè¡€',
      'è›‹ç™½': 'è›‹ç™½', 'å°¿è›‹ç™½': 'è›‹ç™½',
      'ç³–': 'ç³–', 'å°¿ç³–': 'ç³–',
      'pH': 'pH',
      'ã‚±ãƒˆãƒ³ä½“': 'ã‚±ãƒˆãƒ³ä½“',
      'ã‚¦ãƒ­ãƒ“ãƒªãƒãƒ¼ã‚²ãƒ³': 'ã‚¦ãƒ­ãƒ“ãƒªãƒãƒ¼ã‚²ãƒ³',
      'ãƒ“ãƒªãƒ«ãƒ“ãƒ³': 'ãƒ“ãƒªãƒ«ãƒ“ãƒ³'
    };
    
    const normalizeLabel = (k) => LABEL_MAP[String(k || '').replace(/\s+/g, '').replace(/[ï¼ˆ(].*?[)ï¼‰]/g, '')] || String(k || '').trim();
    
    const prompt = `åŒ»ç™‚æ¤œæŸ»ç¥¨ã®ç”»åƒã‹ã‚‰æ¤œæŸ»å€¤ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦ã€‘ç”»åƒå…¨ä½“ã‚’è¦‹ã¦ã€å„æ¤œæŸ»é …ç›®ãŒã©ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè¡€æ¶²æ¤œæŸ»ã€å°¿æ¤œæŸ»ãªã©ï¼‰ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚

ã€æ¤œæŸ»ã®ç¨®é¡ã¨é …ç›®ã€‘

â–  è¡€æ¶²æ¤œæŸ»ï¼ˆè¡€ç®—ï¼‰â€»æœ€é‡è¦
- WBCï¼ˆç™½è¡€çƒæ•°ï¼‰ã€RBCï¼ˆèµ¤è¡€çƒæ•°ï¼‰ã€Hbï¼ˆãƒ˜ãƒ¢ã‚°ãƒ­ãƒ“ãƒ³ï¼‰ã€Htï¼ˆãƒ˜ãƒãƒˆã‚¯ãƒªãƒƒãƒˆï¼‰ã€Pltï¼ˆè¡€å°æ¿ï¼‰
- å˜ä½ï¼šWBCã¯/Î¼Lã€RBCã¯Ã—10â¶/Î¼Lã€Hbã¯g/dLã€Htã¯%ã€Pltã¯Ã—10Â³/Î¼L
- è¡€å°æ¿ã¯3æ¡ã®æ•°å€¤ã§è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆä¾‹ï¼š200ã§20ä¸‡å€‹/Î¼Lï¼‰

â–  è¡€æ¶²æ¤œæŸ»ï¼ˆç”ŸåŒ–å­¦ï¼‰
- é›»è§£è³ªï¼šNaã€Kã€Cl
- è…æ©Ÿèƒ½ï¼šBUNã€Crã€eGFR
- è‚æ©Ÿèƒ½ï¼šASTã€ALTã€ALPã€Î³-GTPã€T-bilã€D-bilã€TPã€Albã€LDH
- ãã®ä»–ï¼šCKã€Amyã€Lipã€Gluã€CRPã€UA ãªã©
- å˜ä½ï¼šmEq/Lã€mg/dLã€U/Lã€IU/L ãªã©

â–  è¡€æ¶²æ¤œæŸ»ï¼ˆå‡å›ºï¼‰
- PT-INRã€APTTã€D-dimerã€Fib ãªã©

â–  å°¿æ¤œæŸ»ï¼ˆå°¿å®šæ€§ï¼‰
- pHã€æ¯”é‡ã€è›‹ç™½ã€ç³–ã€æ½œè¡€ã€ã‚±ãƒˆãƒ³ä½“ ãªã©
- â€»é‡è¦ï¼šå°¿æ¤œæŸ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã€ŒWBCã€ã€ŒRBCã€ãŒæ›¸ã„ã¦ã‚ã‚‹å ´åˆã¯ã€ã€Œå°¿ä¸­ç™½è¡€çƒã€ã€Œå°¿ä¸­èµ¤è¡€çƒã€ã¨ã—ã¦åŒºåˆ¥ã—ã¦ãã ã•ã„

â–  å°¿æ¤œæŸ»ï¼ˆå°¿æ²ˆæ¸£ï¼‰
- ã€Œå°¿æ²ˆæ¸£ã€ã¾ãŸã¯ã€Œå°¿ä¸­ã€ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¨˜è¼‰
- RBCã€WBCã€ä¸Šçš®ã€å††æŸ±ã€ç´°èŒ ãªã©
- å˜ä½ï¼š/HPFï¼ˆé«˜å€ç‡è¦–é‡ã‚ãŸã‚Šï¼‰

â–  é«„æ¶²æ¤œæŸ»ï¼ˆç‰¹æ®Šæ¤œæŸ»ï¼‰
- é«„æ¶²æ¤œæŸ»ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã®ã¿
- é«„æ¶²Clã€é«„æ¶²ç³–ã€é«„æ¶²è›‹ç™½ã€é«„æ¶²ç´°èƒæ•° ãªã©
- â€»è¡€æ¸…Clã¨é«„æ¶²Clã¯ç•°ãªã‚Šã¾ã™

ã€æŠ½å‡ºãƒ«ãƒ¼ãƒ«ã€‘
1. é …ç›®åã¯è‹±èªç•¥å·ã‚’ä½¿ç”¨ï¼ˆWBCã€RBCã€Naã€Cr ãªã©ï¼‰
2. åŒã˜ç•¥å·ã§ã‚‚æ¤œæŸ»ç¨®åˆ¥ãŒç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼š
   - è¡€æ¶²æ¤œæŸ»ã®WBC/RBC â†’ ã€ŒWBCã€ã€ŒRBCã€
   - å°¿æ¤œæŸ»ã®WBC/RBC â†’ ã‚¹ã‚­ãƒƒãƒ—
   - è¡€æ¸…Cl â†’ ã€ŒClã€
   - é«„æ¶²Cl â†’ ã€Œé«„æ¶²Clã€ï¼ˆæ˜è¨˜ï¼‰
3. æ•°å€¤ã®ã¿æŠ½å‡ºï¼ˆè¨˜å·ã¯é™¤å»ï¼‰
4. å˜ä½ã‚’æ­£ç¢ºã«è¨˜è¼‰
5. åˆ¤èª­ä¸èƒ½ãªå€¤ã¯ã‚¹ã‚­ãƒƒãƒ—

ã€å‡ºåŠ›JSONå½¢å¼ã€‘
{
  "items": [
    {"key": "WBC", "value": 7500, "unit": "/Î¼L"},
    {"key": "RBC", "value": 450, "unit": "Ã—10â´/Î¼L"},
    {"key": "Hb", "value": 13.5, "unit": "g/dL"},
    {"key": "Na", "value": 140, "unit": "mEq/L"},
    {"key": "Cr", "value": 0.8, "unit": "mg/dL"}
  ]
}

â€»ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ï¼ˆè¡€åœ§ã€ä½“æ¸©ã€è„ˆæ‹ï¼‰ã€æ‚£è€…æƒ…å ±ã€æ¤œæŸ»æ—¥æ™‚ã¯é™¤å¤–ã—ã¦ãã ã•ã„ã€‚`;


    
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=${apiKey}`;
    console.log('API URL:', url.replace(apiKey, 'API_KEY_HIDDEN'));
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            {
              inline_data: {
                mime_type: 'image/jpeg',
                data: imageBase64
              }
            },
            { text: prompt }
          ]
        }]
      })
    });
    
    console.log('API response status:', response.status);
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      console.error('API error:', errorData);
      throw new Error(errorData.error?.message || `API error: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('API response data:', data);
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    console.log('Extracted text:', text);
    
    // JSONã‚’æŠ½å‡ºï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å»ï¼‰
    let jsonText = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    
    try {
      const parsed = JSON.parse(jsonText);
      
      // ãƒ©ãƒ™ãƒ«ã‚’æ­£è¦åŒ–
      if (parsed.items && Array.isArray(parsed.items)) {
        parsed.items = parsed.items.map(item => ({
          ...item,
          key: normalizeLabel(item.key)
        }));
      }
      
      return parsed;
    } catch (e) {
      console.error('JSON parse error:', e, 'Text:', jsonText);
      throw new Error('APIã‹ã‚‰ã®å¿œç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ');
    }
  }
  
  // ä¿å­˜ã•ã‚ŒãŸæ¤œæŸ»å†™çœŸã‚’è¡¨ç¤º
  function renderSavedLabImage() {
    const savedImageArea = $('#savedLabImageArea');
    const imagePreview = $('#savedLabImagePreview');
    
    if (state.lastLabImage) {
      savedImageArea.style.display = 'block';
      imagePreview.src = state.lastLabImage;
    } else {
      savedImageArea.style.display = 'none';
    }
  }
  
  // ä¿å­˜ã•ã‚ŒãŸå†™çœŸã‚’å‰Šé™¤
  const deleteLabImageBtn = $('#deleteLabImageBtn');
  if (deleteLabImageBtn) {
    deleteLabImageBtn.addEventListener('click', () => {
      if (confirm('ä¿å­˜ã•ã‚Œã¦ã„ã‚‹æ¤œæŸ»å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        state.lastLabImage = null;
        save();
        renderSavedLabImage();
        pasteStatus.style.display = 'block';
        pasteStatus.textContent = 'âœ… å†™çœŸã‚’å‰Šé™¤ã—ã¾ã—ãŸ';
        pasteStatus.style.color = '#22c55e';
        setTimeout(() => {
          pasteStatus.style.display = 'none';
        }, 2000);
      }
    });
  }
  
  // ä¿å­˜ã•ã‚ŒãŸå†™çœŸã‚’å†èª­ã¿å–ã‚Š
  const rereadLabImageBtn = $('#rereadLabImageBtn');
  if (rereadLabImageBtn) {
    rereadLabImageBtn.addEventListener('click', async () => {
      if (!state.lastLabImage) {
        pasteStatus.style.display = 'block';
        pasteStatus.textContent = 'âš ï¸ ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“';
        pasteStatus.style.color = '#f59e0b';
        return;
      }
      
      const apiKey = getApiKey();
      if (!apiKey) {
        pasteStatus.style.display = 'block';
        pasteStatus.textContent = 'âš ï¸ Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
        pasteStatus.style.color = '#f59e0b';
        return;
      }
      
      pasteStatus.style.display = 'block';
      pasteStatus.textContent = 'ğŸ“· ç”»åƒã‚’å†èª­ã¿å–ã‚Šä¸­...';
      pasteStatus.style.color = '#2563eb';
      
      try {
        const base64Data = state.lastLabImage.split(',')[1]; // data:image/jpeg;base64, ã‚’é™¤å»
        const result = await callGeminiAPI(apiKey, base64Data);
        
        if (result && result.items && result.items.length > 0) {
          ocrResults = {};
          result.items.forEach(item => {
            if (item.key && item.value !== undefined) {
              ocrResults[item.key] = {
                value: item.value,
                unit: item.unit || ''
              };
            }
          });
          
          renderOcrResults();
          pasteStatus.style.display = 'block';
          pasteStatus.textContent = `âœ… ${result.items.length}é …ç›®ã‚’å†èª­ã¿å–ã‚Šã—ã¾ã—ãŸ`;
          pasteStatus.style.color = '#22c55e';
        } else {
          pasteStatus.style.display = 'block';
          pasteStatus.textContent = 'âš ï¸ æ¤œæŸ»å€¤ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
          pasteStatus.style.color = '#f59e0b';
        }
      } catch (err) {
        console.error('Error during re-reading:', err);
        pasteStatus.style.display = 'block';
        pasteStatus.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + (err.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
        pasteStatus.style.color = '#ef4444';
      }
    });
  }
  
  // åˆæœŸè¡¨ç¤º
  renderSavedLabImage();
}

// ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æ¤œæŸ»å€¤ã‚’æŠ½å‡ºï¼ˆiPhoneãƒ©ã‚¤ãƒ–ãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œï¼‰
function parseLabText(text) {
  const results = {};
  
  // å…¨è§’æ•°å­—ã‚’åŠè§’ã«å¤‰æ›
  text = text.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
  text = text.replace(/ï¼/g, '.');
  text = text.replace(/ã€€/g, ' ');
  
  // æ¤œæŸ»é …ç›®å â†’ æ¨™æº–åã®ãƒãƒƒãƒ”ãƒ³ã‚°
  const itemMap = {
    // ç”ŸåŒ–å­¦
    'ç·ã‚¿ãƒ³ãƒ‘ã‚¯': 'TP', 'ç·è›‹ç™½': 'TP', 'TP': 'TP',
    'ã‚¢ãƒ«ãƒ–ãƒŸãƒ³': 'Alb', 'Alb': 'Alb', 'ALB': 'Alb',
    'ç·ãƒ“ãƒªãƒ«ãƒ“ãƒ³': 'T-bil', 'T-bil': 'T-bil', 'Tbil': 'T-bil', 'T-Bil': 'T-bil', 'TB': 'T-bil',
    'ç›´æ¥ãƒ“ãƒªãƒ«ãƒ“ãƒ³': 'D-bil', 'D-bil': 'D-bil', 'Dbil': 'D-bil', 'D-Bil': 'D-bil', 'DB': 'D-bil',
    'AST': 'AST', 'GOT': 'AST', 'AST(GOT)': 'AST', 'AST (GOT)': 'AST',
    'ALT': 'ALT', 'GPT': 'ALT', 'ALT(GPT)': 'ALT', 'ALT (GPT)': 'ALT',
    'ALP': 'ALP',
    'Î³GTP': 'Î³-GTP', 'Î³-GTP': 'Î³-GTP', 'yGTP': 'Î³-GTP', 'Y-GTP': 'Î³-GTP', 'GGT': 'Î³-GTP',
    'LDH': 'LDH', 'LD': 'LDH',
    'CK': 'CK', 'CPK': 'CK',
    'å°¿ç´ çª’ç´ ': 'BUN', 'BUN': 'BUN',
    'ã‚¯ãƒ¬ã‚¢ãƒãƒ‹ãƒ³': 'Cr', 'Cr': 'Cr', 'CRE': 'Cr',
    'æ¨ç®—ç³¸çƒä½“æ¿¾éé‡': 'eGFR', 'æ¨ç®—ç³¸çƒä½“æ¿¾éå€¤': 'eGFR', 'eGFR': 'eGFR',
    'ãƒŠãƒˆãƒªã‚¦ãƒ ': 'Na', 'Na': 'Na',
    'ã‚«ãƒªã‚¦ãƒ ': 'K', 'K': 'K',
    'ã‚¯ãƒ­ãƒ¼ãƒ«': 'Cl', 'Cl': 'Cl',
    'ã‚«ãƒ«ã‚·ã‚¦ãƒ ': 'Ca', 'Ca': 'Ca',
    'ç„¡æ©Ÿãƒªãƒ³': 'IP', 'ãƒªãƒ³': 'IP', 'IP': 'IP',
    'ãƒã‚°ãƒã‚·ã‚¦ãƒ ': 'Mg', 'Mg': 'Mg',
    'å°¿é…¸': 'UA', 'UA': 'UA',
    'è¡€ç³–': 'Glu', 'ã‚°ãƒ«ã‚³ãƒ¼ã‚¹': 'Glu', 'Glu': 'Glu', 'BS': 'Glu',
    'CRP': 'CRP',
    'ã‚¢ãƒŸãƒ©ãƒ¼ã‚¼': 'Amy', 'ã‚¢ãƒŸãƒ©ãƒ¼ã‚¼(è¡€ä¸­)': 'Amy', 'ã‚¢ãƒŸãƒ©ãƒ¼ã‚¼ï¼ˆè¡€ä¸­ï¼‰': 'Amy', 'Amy': 'Amy',
    'ãƒªãƒ‘ãƒ¼ã‚¼': 'Lip', 'Lip': 'Lip',
    'è¡€æ¸…é‰„': 'Fe', 'é‰„': 'Fe', 'Fe': 'Fe',
    'ãƒ•ã‚§ãƒªãƒãƒ³': 'Ferritin', 'Ferritin': 'Ferritin',
    
    // è„‚è³ªï¼ˆç¾åœ¨åˆ©ç”¨å¯èƒ½ãªã®ã¯ç”ŸåŒ–å­¦ã¾ã§ã ãŒã€å°†æ¥çš„ãªæ‹¡å¼µã®ãŸã‚æ®‹ã—ã¦ãŠãï¼‰
    'ä¸­æ€§è„‚è‚ª': 'TG', 'TG': 'TG',
    'ç·ã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«': 'T-CHO',
    'HDLã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«': 'HDL-C', 'HDL-C': 'HDL-C', 'HDL': 'HDL-C',
    'LDLã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«': 'LDL-C', 'LDL-C': 'LDL-C', 'LDL': 'LDL-C',
    
    // è¡€ç®—
    'ç™½è¡€çƒæ•°': 'WBC', 'ç™½è¡€çƒ': 'WBC', 'WBC': 'WBC',
    'èµ¤è¡€çƒæ•°': 'RBC', 'èµ¤è¡€çƒ': 'RBC', 'RBC': 'RBC',
    'ãƒ˜ãƒ¢ã‚°ãƒ­ãƒ“ãƒ³': 'Hb', 'è¡€è‰²ç´ ': 'Hb', 'Hb': 'Hb', 'HGB': 'Hb',
    'ãƒ˜ãƒãƒˆã‚¯ãƒªãƒƒãƒˆ': 'Ht', 'Ht': 'Ht', 'HCT': 'Ht',
    'è¡€å°æ¿æ•°': 'Plt', 'è¡€å°æ¿': 'Plt', 'Plt': 'Plt', 'PLT': 'Plt',
    'å¹³å‡èµ¤è¡€çƒå®¹ç©': 'MCV', 'MCV': 'MCV',
    'å¹³å‡èµ¤è¡€çƒHbé‡': 'MCH', 'å¹³å‡èµ¤è¡€çƒè¡€è‰²ç´ é‡': 'MCH', 'MCH': 'MCH',
    'å¹³å‡èµ¤è¡€çƒHbæ¿ƒåº¦': 'MCHC', 'å¹³å‡èµ¤è¡€çƒè¡€è‰²ç´ æ¿ƒåº¦': 'MCHC', 'MCHC': 'MCHC',
    
    // å‡å›º
    'PT-INR': 'PT-INR', 'INR': 'PT-INR',
    'PT%': 'PT%', 'PT': 'PT%',
    'APTT': 'APTT', 'aPTT': 'APTT',
    'Dãƒ€ã‚¤ãƒãƒ¼': 'D-dimer', 'D-dimer': 'D-dimer',
    'FDP': 'FDP',
    'ãƒ•ã‚£ãƒ–ãƒªãƒã‚²ãƒ³': 'Fib', 'Fib': 'Fib',
    'AT3': 'AT3',
    
    // ç³–å°¿ç—…
    'HbA1c': 'HbA1c', 'HbA1c(NGSP)': 'HbA1c', 'HbA1cï¼ˆNGSPï¼‰': 'HbA1c',
    'BNP': 'BNP',
    'NT-proBNP': 'NT-proBNP',
    
    // è¡€æ¶²ã‚¬ã‚¹
    'pH': 'pH',
    'pCO2': 'pCO2', 'PCO2': 'pCO2', 'PaCO2': 'pCO2',
    'pO2': 'pO2', 'PO2': 'pO2', 'PaO2': 'pO2',
    'HCO3-': 'HCO3-', 'HCO3': 'HCO3-',
    'BE': 'BE',
    'ä¹³é…¸': 'Lac', 'Lac': 'Lac',
    'SaO2': 'SaO2', 'SpO2': 'SaO2',
    
    // å°¿å®šæ€§/æ²ˆæ¸£ï¼ˆç«¶åˆã‚’é¿ã‘ã‚‹ãŸã‚ã«å…·ä½“çš„ãªé …ç›®åã§ã®ã¿æŠ½å‡ºï¼‰
    'å°¿pH': 'pH',
    'å°¿æ¯”é‡': 'æ¯”é‡',
    'å°¿è›‹ç™½': 'è›‹ç™½',
    'å°¿ç³–': 'ç³–',
    'å°¿æ½œè¡€': 'æ½œè¡€',
    'å°¿ã‚±ãƒˆãƒ³ä½“': 'ã‚±ãƒˆãƒ³',
    'å°¿ã‚¦ãƒ­ãƒ“ãƒªãƒãƒ¼ã‚²ãƒ³': 'ã‚¦ãƒ­ãƒ“ãƒª',
    'å°¿ãƒ“ãƒªãƒ«ãƒ“ãƒ³': 'ãƒ“ãƒªãƒ«ãƒ“ãƒ³',
    'å°¿äºœç¡é…¸å¡©': 'äºœç¡é…¸å¡©',
    'å°¿ç™½è¡€çƒ': 'ç™½è¡€çƒ',
    'å°¿RBC': 'RBC', // å°¿æ²ˆæ¸£
    'å°¿WBC': 'WBC', // å°¿æ²ˆæ¸£
    'é«„æ¶²ç´°èƒæ•°': 'é«„æ¶²ç´°èƒæ•°',
    'é«„æ¶²è›‹ç™½': 'é«„æ¶²è›‹ç™½',
    'é«„æ¶²ç³–': 'é«„æ¶²ç³–',
    'é«„æ¶²Cl': 'é«„æ¶²Cl',
  };
  
  const lines = text.split(/[\n\r]+/).map(l => l.trim()).filter(l => l);
  console.log('Lines:', lines);
  
  // ãƒãƒƒãƒ”ãƒ³ã‚°ã®ã‚­ãƒ¼ã‚’æ­£è¦è¡¨ç¾ã§ä½¿ã†ãŸã‚ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã€é•·ã„é †ã«ã‚½ãƒ¼ãƒˆ
  const sortedKeys = Object.keys(itemMap).sort((a, b) => b.length - a.length);
  const regex = new RegExp(`(${sortedKeys.map(escapeRegex).join('|')})`);
  
  // æ–¹æ³•1: åŒã˜è¡Œã«é …ç›®åã¨æ•°å€¤ãŒã‚ã‚‹å ´åˆ
  for (const line of lines) {
    // é …ç›®åã‚’æ¢ã™
    const itemMatch = line.match(regex);
    if (itemMatch) {
      const itemName = itemMatch[1];
      const standardName = itemMap[itemName];
      if (!results[standardName]) {
        // è¡Œæœ«ã®æ•°å€¤ã‚’å–å¾—
        const valueMatch = line.slice(itemMatch.index + itemName.length).match(/([0-9]+\.?[0-9]*)\s*[LHlh]?\s*$/);
        if (valueMatch) {
          const val = parseFloat(valueMatch[1]);
          // ç•°å¸¸ã«å¤§ããªæ•°å€¤ã‚„è² ã®æ•°ã¯ç„¡è¦–
          if (!isNaN(val) && val >= 0 && val < 100000) {
            results[standardName] = valueMatch[1];
            console.log(`Found (same line): ${standardName} = ${valueMatch[1]}`);
          }
        }
      }
    }
  }
  
  // æ–¹æ³•2: iPhoneãƒ©ã‚¤ãƒ–ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ï¼ˆé …ç›®åã¨æ•°å€¤ãŒåˆ¥ã®è¡Œï¼‰
  let pendingItem = null;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    
    // ã“ã®è¡ŒãŒé …ç›®åã‹ãƒã‚§ãƒƒã‚¯
    let foundItem = null;
    const itemMatch = line.match(regex);
    
    if (itemMatch) {
      const itemName = itemMatch[1];
      const standardName = itemMap[itemName];
      if (!results[standardName]) {
        // æ¬¡ã®è¡Œã«æ•°å€¤ãŒã‚ã‚‹ã‹ã‚‚
        pendingItem = standardName;
      }
    } else if (pendingItem) {
      // å‰ã®è¡ŒãŒé …ç›®åã§ã€ã“ã®è¡ŒãŒæ•°å€¤ã‹ãƒã‚§ãƒƒã‚¯
      const numMatch = line.match(/^([0-9]+\.?[0-9]*)\s*[LHlh]?\s*$/);
      if (numMatch) {
        const val = parseFloat(numMatch[1]);
        if (!isNaN(val) && val >= 0 && val < 100000 && !results[pendingItem]) {
          results[pendingItem] = numMatch[1];
          console.log(`Found (next line): ${pendingItem} = ${numMatch[1]}`);
        }
      }
      pendingItem = null;
    }
  }
  
  return results;
}

function escapeRegex(str) {
  // æ‹¬å¼§ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}


function renderOcrResults() {
  const area = $('#ocrResultArea');
  const list = $('#ocrResultList');
  
  if (Object.keys(ocrResults).length === 0) {
    area.style.display = 'none';
    return;
  }
  
  area.style.display = 'block';
  list.innerHTML = '';
  
  // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦è¡¨ç¤º
  const catNames = {
    cbc: 'è¡€ç®—',
    chem: 'ç”ŸåŒ–å­¦',
    coag: 'å‡å›º',
    sugar: 'è¡€ç³–ãƒ»å¿ƒä¸å…¨',
    gas: 'è¡€æ¶²ã‚¬ã‚¹',
    urine: 'å°¿å®šæ€§',
    sediment: 'å°¿æ²ˆæ¸£',
    tumor: 'è…«ç˜ãƒãƒ¼ã‚«ãƒ¼',
    endo: 'å†…åˆ†æ³Œ',
    urineBio: 'å°¿ç”ŸåŒ–',
    csf: 'é«„æ¶²',
    unknown: 'ãã®ä»–'
  };
  
  // é …ç›®åã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’åˆ¤å®šã™ã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°
  // å„ªå…ˆé †ä½: ä¸€èˆ¬çš„ãªæ¤œæŸ» â†’ ç‰¹æ®Šãªæ¤œæŸ»
  const categoryPriority = ['cbc', 'chem', 'coag', 'sugar', 'gas', 'urine', 'sediment', 'tumor', 'endo', 'urineBio', 'csf'];
  
  const itemToCat = {};
  categoryPriority.forEach(cat => {
    if (!LABS[cat]) return;
    LABS[cat].items.forEach(([item, unit]) => {
      // æ—¢ã«ãƒãƒƒãƒ”ãƒ³ã‚°ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å„ªå…ˆé †ä½ã®é«˜ã„æ–¹ã‚’ç¶­æŒï¼ˆä¸Šæ›¸ãã—ãªã„ï¼‰
      if (!itemToCat[item]) {
        itemToCat[item] = { cat, unit };
      }
      // åˆ¥åå¯¾å¿œ
      if (item === 'Î³-GTP' && !itemToCat['GGT']) itemToCat['GGT'] = { cat, unit };
      if (item === 'T-bil' && !itemToCat['TB']) itemToCat['TB'] = { cat, unit };
      if (item === 'D-bil' && !itemToCat['DB']) itemToCat['DB'] = { cat, unit };
      if (item === 'HCO3-' && !itemToCat['HCO3']) itemToCat['HCO3'] = { cat, unit };
    });
  });
  
  // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«åˆ†é¡
  const grouped = {};
  Object.entries(ocrResults).forEach(([key, valueObj]) => {
    // åˆ¥åãƒã‚§ãƒƒã‚¯
    let normalizedKey = key;
    if (key === 'GGT') normalizedKey = 'Î³-GTP';
    if (key === 'TB') normalizedKey = 'T-bil';
    if (key === 'DB') normalizedKey = 'D-bil';
    if (key === 'HCO3') normalizedKey = 'HCO3-';

    const mapping = itemToCat[normalizedKey] || itemToCat[key];
    const cat = mapping ? mapping.cat : 'unknown';
    if (!grouped[cat]) grouped[cat] = [];
    
    // valueObjã¯ { value: æ•°å€¤, unit: "å˜ä½" } ã®å½¢å¼ã€ã¾ãŸã¯æ•°å€¤æ–‡å­—åˆ—
    const actualValue = typeof valueObj === 'object' ? valueObj.value : valueObj;
    const actualUnit = typeof valueObj === 'object' && valueObj.unit ? valueObj.unit : (mapping ? mapping.unit : '');
    
    grouped[cat].push({ 
      key: normalizedKey, // è¡¨ç¤ºã¯æ­£è¦åŒ–ã•ã‚ŒãŸé …ç›®åã‚’ä½¿ã†
      originalKey: key, // å‰Šé™¤æ™‚ã«å¿…è¦
      value: actualValue, 
      unit: actualUnit 
    });
  });
  
  // ã‚«ãƒ†ã‚´ãƒªé †ã§è¡¨ç¤º
  const catOrder = ['cbc', 'chem', 'coag', 'sugar', 'gas', 'urine', 'sediment', 'tumor', 'endo', 'urineBio', 'csf', 'unknown'];
  
  catOrder.forEach(cat => {
    if (!grouped[cat] || grouped[cat].length === 0) return;
    
    // ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼
    const catHeader = document.createElement('div');
    catHeader.style.cssText = 'width:100%;font-size:12px;font-weight:600;color:#7c3aed;margin-top:8px;margin-bottom:4px;';
    catHeader.textContent = catNames[cat] || cat;
    list.appendChild(catHeader);
    
    // é …ç›®
    grouped[cat].forEach(({ key, originalKey, value, unit }) => {
      const pill = document.createElement('div');
      pill.className = 'lab-pill';
      pill.style.background = '#fff';
      pill.innerHTML = `
        <label style="min-width:60px;">${key}</label>
        <input type="text" inputmode="decimal" value="${value}" style="width:80px;" data-ocr-key="${originalKey}">
        <span class="unit">${unit}</span>
        <button class="del" data-ocr-del="${originalKey}">Ã—</button>
      `;
      
      // å€¤ã®ç·¨é›†
      pill.querySelector('input').addEventListener('input', (e) => {
        const newValue = e.target.value;
        // ocrResultsã¯å…ƒã®ã‚­ãƒ¼ã§ä¿æŒ
        if (typeof ocrResults[originalKey] === 'object') {
          ocrResults[originalKey].value = newValue;
        } else {
          // å…ƒãŒæ•°å€¤æ–‡å­—åˆ—ã§ã‚‚ã€ç·¨é›†ã•ã‚ŒãŸã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã§æŒã¤
          ocrResults[originalKey] = { value: newValue, unit: unit };
        }
      });
      
      // å‰Šé™¤
      pill.querySelector('.del').addEventListener('click', () => {
        delete ocrResults[originalKey];
        renderOcrResults();
      });
      
      list.appendChild(pill);
    });
  });
}

function applyLabData(labData) {
  console.log('=== applyLabData called ===');
  console.log('Input data:', labData);
  
  // é …ç›®åã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’åˆ¤å®šã™ã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°
  const categoryPriority = ['cbc', 'chem', 'coag', 'sugar', 'gas', 'urine', 'sediment', 'tumor', 'endo', 'urineBio', 'csf'];
  
  const itemToCat = {};
  categoryPriority.forEach(cat => {
    if (!LABS[cat]) return;
    LABS[cat].items.forEach(([item, unit]) => {
      if (!itemToCat[item]) { itemToCat[item] = { cat, unit }; }
      if (item === 'Î³-GTP' && !itemToCat['GGT']) itemToCat['GGT'] = { cat, unit };
      if (item === 'T-bil' && !itemToCat['TB']) itemToCat['TB'] = { cat, unit };
      if (item === 'D-bil' && !itemToCat['DB']) itemToCat['DB'] = { cat, unit };
      if (item === 'HCO3-' && !itemToCat['HCO3']) itemToCat['HCO3'] = { cat, unit };
    });
  });
  
  let addedCount = 0;
  const results = [];
  
  Object.entries(labData).forEach(([key, valueData]) => {
    // keyã¯OCRã‹ã‚‰è¿”ã•ã‚ŒãŸãã®ã¾ã¾ã®ã‚­ãƒ¼ï¼ˆæ­£è¦åŒ–ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰
    let normalizedKey = key.trim();
    
    // valueDataãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ value ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å–ã‚Šå‡ºã™
    let actualValue = valueData;
    let actualUnit = '';
    if (typeof valueData === 'object' && valueData !== null && 'value' in valueData) {
      actualValue = valueData.value;
      actualUnit = valueData.unit || '';
    }
    
    // ã‚­ãƒ¼ã®æ­£è¦åŒ–ã¨ãƒãƒƒãƒ”ãƒ³ã‚°ã®æ¤œç´¢
    let targetKey = normalizedKey;
    if (normalizedKey === 'GGT') targetKey = 'Î³-GTP';
    if (normalizedKey === 'TB') targetKey = 'T-bil';
    if (normalizedKey === 'DB') targetKey = 'D-bil';
    if (normalizedKey === 'HCO3') targetKey = 'HCO3-';
    
    const mapping = itemToCat[targetKey];
    
    if (mapping) {
      const { cat, unit } = mapping;
      
      console.log(`âœ“ ${targetKey} = ${actualValue} â†’ ã‚«ãƒ†ã‚´ãƒª: ${LABS[cat].name} (${cat})`);
      
      // æ—¢å­˜ã®é …ç›®ã‚’æ¢ã™ï¼ˆæ­£è¦åŒ–ã•ã‚ŒãŸé …ç›®åã§æ¢ã™ï¼‰
      let existing = state.labs[cat].find(x => x.item === targetKey);
      
      if (existing) {
        console.log(`  â†’ æ—¢å­˜é …ç›®ã‚’æ›´æ–°`);
        existing.val = String(actualValue);
      } else {
        console.log(`  â†’ æ–°è¦é …ç›®ã‚’è¿½åŠ `);
        state.labs[cat].push({ item: targetKey, unit, val: String(actualValue) });
      }
      
      results.push({ key: targetKey, category: LABS[cat].name, value: actualValue });
      addedCount++;
    } else {
      console.log(`âœ— ${normalizedKey} = ${actualValue} â†’ ãƒãƒƒãƒ”ãƒ³ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
    }
  });
  
  console.log('=== åæ˜ çµæœ ===');
  results.forEach(r => console.log(`  ${r.key} (${r.category}): ${r.value}`));
  console.log(`åˆè¨ˆ ${addedCount} é …ç›®ã‚’åæ˜ ã—ã¾ã—ãŸ`);
  
  if (addedCount > 0) {
    // ãƒ‡ãƒ¼ã‚¿åæ˜ å¾Œã€å„ã‚«ãƒ†ã‚´ãƒªã‚’LABSã®å®šç¾©é †åºã«ä¸¦ã¹æ›¿ãˆ
    categoryPriority.forEach(cat => {
      if (!LABS[cat] || !state.labs[cat]) return;
      
      // LABSã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹é …ç›®ã®é †åºã‚’å–å¾—
      const definedOrder = LABS[cat].items.map(([item]) => item);
      
      // ç¾åœ¨ã®é …ç›®ã‚’å®šç¾©é †åºã§ã‚½ãƒ¼ãƒˆ
      state.labs[cat].sort((a, b) => {
        const indexA = definedOrder.indexOf(a.item);
        const indexB = definedOrder.indexOf(b.item);
        
        // ä¸¡æ–¹ã¨ã‚‚å®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€å®šç¾©é †åºã«å¾“ã†
        if (indexA !== -1 && indexB !== -1) {
          return indexA - indexB;
        }
        // aãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å¾Œã‚ã«
        if (indexA === -1) return 1;
        // bãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å‰ã«
        if (indexB === -1) return -1;
        return 0;
      });
    });
    
    save();
    renderLabEdit();
  }
  
  return addedCount;
}

function initInfect() {
  $('#covidType').value = state.infect.covid.type || '';
  $('#covidRes').value = state.infect.covid.res || '';
  $('#fluA').value = state.infect.flu.a || '';
  $('#fluB').value = state.infect.flu.b || '';
  
  $('#covidType').addEventListener('change', () => { state.infect.covid.type = $('#covidType').value; save(); });
  $('#covidRes').addEventListener('change', () => { state.infect.covid.res = $('#covidRes').value; save(); });
  $('#fluA').addEventListener('change', () => { state.infect.flu.a = $('#fluA').value; save(); });
  $('#fluB').addEventListener('change', () => { state.infect.flu.b = $('#fluB').value; save(); });
  
  $('#cultureAdd').addEventListener('click', () => { state.infect.cultures.push({ src: '', res: '', note: '' }); renderCultures(); save(); });
  
  renderCultures();
}

function renderCultures() {
  const area = $('#cultureArea');
  area.innerHTML = '';
  
  if (!state.infect.cultures.length) {
    area.innerHTML = '<p class="small">åŸ¹é¤Šã‚’è¿½åŠ ãƒœã‚¿ãƒ³ã§è¿½åŠ </p>';
    return;
  }
  
  state.infect.cultures.forEach((c, i) => {
    const entry = document.createElement('div');
    entry.className = 'culture-entry';
    entry.innerHTML = `
      <div class="form-grid">
        <div><label>æ¤œä½“</label><select class="cult-src"><option value="">é¸æŠ</option><option>è¡€æ¶²</option><option>å°¿</option><option>å–€ç—°</option><option>ä¾¿</option><option>é«„æ¶²</option></select></div>
        <div><label>çµæœ</label><select class="cult-res"><option value="">-</option><option>é™°æ€§</option><option>é™½æ€§</option><option>çµæœæœªç€</option></select></div>
      </div>
      <div class="form-row"><label>èŒå/ã‚³ãƒ¡ãƒ³ãƒˆ</label><input class="cult-note" placeholder="èŒåç­‰"></div>
      <button class="btn btn-sm btn-danger cult-del">å‰Šé™¤</button>
    `;
    entry.querySelector('.cult-src').value = c.src || '';
    entry.querySelector('.cult-res').value = c.res || '';
    entry.querySelector('.cult-note').value = c.note || '';
    
    entry.querySelector('.cult-src').addEventListener('change', (e) => { c.src = e.target.value; save(); });
    entry.querySelector('.cult-res').addEventListener('change', (e) => { c.res = e.target.value; save(); });
    entry.querySelector('.cult-note').addEventListener('input', (e) => { c.note = e.target.value; save(); });
    entry.querySelector('.cult-del').addEventListener('click', () => { state.infect.cultures.splice(i, 1); renderCultures(); save(); });
    
    area.appendChild(entry);
  });
}

function initImaging() {
  const imgKeys = ['cxr', 'ct', 'ctc', 'mri'];
  const imgLabels = { cxr: 'èƒ¸éƒ¨XP', ct: 'CT', ctc: 'é€ å½±CT', mri: 'MRI' };
  
  imgKeys.forEach(key => {
    const cb = $(`#${key}On`);
    cb.checked = state.imaging[key].on;
    cb.addEventListener('change', () => { state.imaging[key].on = cb.checked; renderImgText(); save(); });
  });
  
  $('#imgOtherOn').checked = state.imaging.other.on;
  $('#imgOtherOn').addEventListener('change', () => { state.imaging.other.on = $('#imgOtherOn').checked; renderImgText(); save(); });
  
  renderImgText();
}

function renderImgText() {
  const area = $('#imgTextArea');
  area.innerHTML = '';
  const imgKeys = ['cxr', 'ct', 'ctc', 'mri'];
  const imgLabels = { cxr: 'èƒ¸éƒ¨XP', ct: 'CT', ctc: 'é€ å½±CT', mri: 'MRI' };
  
  imgKeys.forEach(key => {
    if (state.imaging[key].on) {
      const row = document.createElement('div');
      row.className = 'form-row mt-2';
      row.innerHTML = `<label>${imgLabels[key]}æ‰€è¦‹</label><textarea rows="3" placeholder="æ‰€è¦‹ã‚’è¨˜è¼‰"></textarea>`;
      const ta = row.querySelector('textarea');
      ta.value = state.imaging[key].txt || '';
      ta.addEventListener('input', () => { state.imaging[key].txt = ta.value; save(); });
      area.appendChild(row);
    }
  });
  
  // ãã®ä»–ç”»åƒ
  if (state.imaging.other.on) {
    const otherRow = document.createElement('div');
    otherRow.className = 'form-row mt-2';
    otherRow.innerHTML = `
      <label>ãã®ä»–ç”»åƒ - æ¤œæŸ»å</label>
      <input type="text" id="imgOtherName" placeholder="æ¤œæŸ»åï¼ˆä¾‹ï¼šä¸‹è‚¢MRAï¼‰" style="margin-bottom:8px">
      <label>æ‰€è¦‹</label>
      <textarea rows="3" id="imgOtherTxt" placeholder="æ‰€è¦‹ã‚’è¨˜è¼‰"></textarea>
    `;
    area.appendChild(otherRow);
    $('#imgOtherName').value = state.imaging.other.name || '';
    $('#imgOtherTxt').value = state.imaging.other.txt || '';
    $('#imgOtherName').addEventListener('input', () => { state.imaging.other.name = $('#imgOtherName').value; save(); });
    $('#imgOtherTxt').addEventListener('input', () => { state.imaging.other.txt = $('#imgOtherTxt').value; save(); });
  }
}

function initPhys() {
  $('#ecgOn').checked = state.phys.ecg.on;
  $('#eegOn').checked = state.phys.eeg.on;
  $('#usOn').checked = state.phys.us.on;
  $('#phyOtherOn').checked = state.phys.other.on;
  
  $('#ecgOn').addEventListener('change', () => { state.phys.ecg.on = $('#ecgOn').checked; renderPhyText(); save(); });
  $('#eegOn').addEventListener('change', () => { state.phys.eeg.on = $('#eegOn').checked; renderPhyText(); save(); });
  $('#usOn').addEventListener('change', () => { state.phys.us.on = $('#usOn').checked; renderPhyText(); save(); });
  $('#phyOtherOn').addEventListener('change', () => { state.phys.other.on = $('#phyOtherOn').checked; renderPhyText(); save(); });
  
  renderPhyText();
}

function renderPhyText() {
  const area = $('#phyTextArea');
  area.innerHTML = '';
  
  // å¿ƒé›»å›³ï¼ˆè©³ç´°ï¼‰
  if (state.phys.ecg.on) {
    const ecgRow = document.createElement('div');
    ecgRow.className = 'form-row mt-2';
    ecgRow.innerHTML = `
      <label>å¿ƒé›»å›³</label>
      <div class="ecg-detail">
        <div><label>èª¿å¾‹</label><input type="text" id="ecgRhythm" placeholder="æ´èª¿å¾‹ã€AFç­‰"></div>
        <div><label>å¿ƒæ‹æ•°</label><input type="text" id="ecgRate" placeholder="72 bpm"></div>
        <div><label>ST-Tå¤‰åŒ–</label><input type="text" id="ecgST" placeholder="V1-4 STä¸Šæ˜‡ç­‰"></div>
        <div><label>QTc</label><input type="text" id="ecgQTc" placeholder="420 ms"></div>
      </div>
      <textarea rows="2" id="ecgTxt" placeholder="ãã®ä»–æ‰€è¦‹"></textarea>
    `;
    area.appendChild(ecgRow);
    $('#ecgRhythm').value = state.phys.ecg.rhythm || '';
    $('#ecgRate').value = state.phys.ecg.rate || '';
    $('#ecgST').value = state.phys.ecg.st || '';
    $('#ecgQTc').value = state.phys.ecg.qtc || '';
    $('#ecgTxt').value = state.phys.ecg.txt || '';
    $('#ecgRhythm').addEventListener('input', () => { state.phys.ecg.rhythm = $('#ecgRhythm').value; save(); });
    $('#ecgRate').addEventListener('input', () => { state.phys.ecg.rate = $('#ecgRate').value; save(); });
    $('#ecgST').addEventListener('input', () => { state.phys.ecg.st = $('#ecgST').value; save(); });
    $('#ecgQTc').addEventListener('input', () => { state.phys.ecg.qtc = $('#ecgQTc').value; save(); });
    $('#ecgTxt').addEventListener('input', () => { state.phys.ecg.txt = $('#ecgTxt').value; save(); });
  }
  
  // è„³æ³¢
  if (state.phys.eeg.on) {
    const row = document.createElement('div');
    row.className = 'form-row mt-2';
    row.innerHTML = `<label>è„³æ³¢æ‰€è¦‹</label><textarea rows="3" placeholder="æ‰€è¦‹ã‚’è¨˜è¼‰"></textarea>`;
    const ta = row.querySelector('textarea');
    ta.value = state.phys.eeg.txt || '';
    ta.addEventListener('input', () => { state.phys.eeg.txt = ta.value; save(); });
    area.appendChild(row);
  }
  
  // è¶…éŸ³æ³¢
  if (state.phys.us.on) {
    const row = document.createElement('div');
    row.className = 'form-row mt-2';
    row.innerHTML = `<label>è¶…éŸ³æ³¢æ‰€è¦‹</label><textarea rows="3" placeholder="æ‰€è¦‹ã‚’è¨˜è¼‰"></textarea>`;
    const ta = row.querySelector('textarea');
    ta.value = state.phys.us.txt || '';
    ta.addEventListener('input', () => { state.phys.us.txt = ta.value; save(); });
    area.appendChild(row);
  }
  
  // ãã®ä»–ç”Ÿç†
  if (state.phys.other.on) {
    const otherRow = document.createElement('div');
    otherRow.className = 'form-row mt-2';
    otherRow.innerHTML = `
      <label>ãã®ä»–ç”Ÿç†æ©Ÿèƒ½ - æ¤œæŸ»å</label>
      <input type="text" id="phyOtherName" placeholder="æ¤œæŸ»åï¼ˆä¾‹ï¼šå‘¼å¸æ©Ÿèƒ½æ¤œæŸ»ï¼‰" style="margin-bottom:8px">
      <label>æ‰€è¦‹</label>
      <textarea rows="3" id="phyOtherTxt" placeholder="æ‰€è¦‹ã‚’è¨˜è¼‰"></textarea>
    `;
    area.appendChild(otherRow);
    $('#phyOtherName').value = state.phys.other.name || '';
    $('#phyOtherTxt').value = state.phys.other.txt || '';
    $('#phyOtherName').addEventListener('input', () => { state.phys.other.name = $('#phyOtherName').value; save(); });
    $('#phyOtherTxt').addEventListener('input', () => { state.phys.other.txt = $('#phyOtherTxt').value; save(); });
  }
}

function initProblems() {
  const input = $('#probInput');
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const v = input.value.trim();
      if (v) { state.problems.push({ name: v, note: '' }); input.value = ''; renderProblems(); save(); }
    }
  });
  renderProblems();
  
  // çµŒé/æ–¹é‡å¾©å…ƒ
  if (state.activePlan === 'plan') {
    $$('.toggle-group .toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.plan === 'plan'));
    $$('.plan-section').forEach(s => s.classList.remove('active'));
    $('#planSection').classList.add('active');
  }
  
  $('#courseText').value = state.courseText || '';
  $('#planText').value = state.planText || '';
  $('#courseText').addEventListener('input', () => { state.courseText = $('#courseText').value; save(); });
  $('#planText').addEventListener('input', () => { state.planText = $('#planText').value; save(); });
}

function renderProblems() {
  const tags = $('#probTags');
  const details = $('#probDetails');
  tags.innerHTML = '';
  details.innerHTML = '';
  
  state.problems.forEach((p, i) => {
    const tag = document.createElement('div');
    tag.className = 'problem-tag';
    tag.innerHTML = `<span class="num">#${i + 1}</span><span>${p.name}</span><button class="del">Ã—</button>`;
    tag.querySelector('.del').addEventListener('click', () => { state.problems.splice(i, 1); renderProblems(); save(); });
    tags.appendChild(tag);
    
    const item = document.createElement('div');
    item.className = 'problem-item';
    item.innerHTML = `<div class="header"><span class="num">#${i + 1}â†’</span><span>${p.name}</span></div><textarea rows="2" placeholder="è€ƒå¯Ÿã‚’è¨˜è¼‰"></textarea>`;
    const ta = item.querySelector('textarea');
    ta.value = p.note || '';
    ta.addEventListener('input', () => { p.note = ta.value; save(); });
    details.appendChild(item);
  });
  
  if (!state.problems.length) { details.innerHTML = '<p class="small text-center">Enterã‚­ãƒ¼ã§ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ã‚’è¿½åŠ </p>'; }
}

function bindInputs() {
  const fields = [
    ['#cc', 'cc'], ['#visitDate', 'visitDate'], ['#hpi', 'hpi'],
    ['#pmh', 'pmh'], ['#meds', 'meds'], ['#allergy', 'allergy'], 
    ['#familyHx', 'familyHx'], ['#habits', 'habits'], ['#social', 'social'], ['#keyPerson', 'keyPerson']
  ];
  
  fields.forEach(([sel, key]) => {
    const el = $(sel);
    el.value = state[key] || '';
    el.addEventListener('input', () => { state[key] = el.value; save(); });
  });
  
  if (!state.visitDate) { state.visitDate = today(); $('#visitDate').value = state.visitDate; }
}

function fmtFinding(lbl, st) {
  if (st === 'on') return lbl;
  if (st === '+') return `${lbl}ï¼ˆï¼‹ï¼‰`;
  if (st === '-') return `${lbl}ï¼ˆâˆ’ï¼‰`;
  return null;
}

function examText() {
  const vText = vitalText();
  const hasMultiVitals = state.vitals && state.vitals.length > 1;
  const lines = [hasMultiVitals ? `ã€ãƒã‚¤ã‚¿ãƒ«ã€‘\n${vText}` : `ã€ãƒã‚¤ã‚¿ãƒ«ã€‘${vText}`];
  
  if (state.examTab === 'general') {
    Object.entries(GEN_GROUPS).forEach(([key, def]) => {
      const labels = [...(def.normal || []), ...(def.abn || [])];
      const findings = labels.map(lbl => fmtFinding(lbl, state.chips[lbl])).filter(Boolean);
      const memo = state.memos.general[key];
      if (findings.length || memo) {
        const title = { head: 'é ­é šéƒ¨', resp: 'å‘¼å¸å™¨', card: 'å¾ªç’°å™¨', abd: 'è…¹éƒ¨', limb: 'å››è‚¢', neuro: 'ç¥çµŒ' }[key];
        lines.push(`ã€${title}ã€‘${[findings.join('ã€'), memo].filter(Boolean).join('ã€‚')}`);
      }
    });
    if (state.examFree) lines.push(`ã€è‡ªç”±è¨˜è¼‰ã€‘${state.examFree}`);
  } else if (state.examTab === 'trauma') {
    Object.entries(TRA_GROUPS).forEach(([key, arr]) => {
      const findings = arr.map(lbl => fmtFinding(lbl, state.chips[lbl])).filter(Boolean);
      const memo = state.memos.trauma[key];
      if (findings.length || memo) {
        const title = { head: 'é ­éƒ¨ãƒ»é¡”é¢', neck: 'é ¸éƒ¨', chest: 'èƒ¸éƒ¨', abd: 'è…¹éƒ¨', pelvis: 'éª¨ç›¤', limb: 'å››è‚¢' }[key];
        lines.push(`ã€${title}ã€‘${[findings.join('ã€'), memo].filter(Boolean).join('ã€‚')}`);
      }
    });
    const limbTxt = ['ru', 'rl', 'lu', 'll'].map(k => state.trauma[k] ? `${k.toUpperCase()}: ${state.trauma[k]}` : '').filter(Boolean).join(', ');
    if (limbTxt) lines.push(`ã€å››è‚¢æ©Ÿèƒ½ã€‘${limbTxt}`);
  } else if (state.examTab === 'stroke') {
    const cnFindings = STR_CNs.map(lbl => fmtFinding(lbl, state.chips[lbl])).filter(Boolean);
    if (cnFindings.length || state.memos.stroke.cn) { lines.push(`ã€è„³ç¥çµŒã€‘${[cnFindings.join('ã€'), state.memos.stroke.cn].filter(Boolean).join('ã€‚')}`); }
    const eyeParts = [];
    if (state.stroke.pupill || state.stroke.pupilr) eyeParts.push(`ç³å­” L${state.stroke.pupill || '-'}/R${state.stroke.pupilr || '-'}mm`);
    if (state.stroke.plrL || state.stroke.plrR) eyeParts.push(`å¯¾å…‰ L:${state.stroke.plrL || '-'}/R:${state.stroke.plrR || '-'}`);
    if (state.stroke.gaze && state.stroke.gaze !== 'ãªã—') eyeParts.push(`åè¦– ${state.stroke.gaze}`);
    if (eyeParts.length || state.memos.stroke.eye) { lines.push(`ã€ç³å­”ãƒ»çœ¼ã€‘${[eyeParts.join('ã€'), state.memos.stroke.eye].filter(Boolean).join('ã€‚')}`); }
    const m = state.stroke.mmt;
    if (m.ru || m.rl || m.lu || m.ll) {
      lines.push(`ã€é‹å‹•ã€‘MMT RU:${m.ru || '-'} RL:${m.rl || '-'} LU:${m.lu || '-'} LL:${m.ll || '-'}/5${state.memos.stroke.motor ? 'ã€‚' + state.memos.stroke.motor : ''}`);
    } else if (state.memos.stroke.motor) { lines.push(`ã€é‹å‹•ã€‘${state.memos.stroke.motor}`); }
    const refParts = [];
    if (state.stroke.btr) refParts.push(`BTR ${state.stroke.btr}`);
    if (state.stroke.ptr) refParts.push(`PTR ${state.stroke.ptr}`);
    if (state.stroke.babinski) refParts.push('Babinskié™½æ€§');
    if (state.stroke.chaddock) refParts.push('Chaddocké™½æ€§');
    if (refParts.length || state.memos.stroke.reflex) { lines.push(`ã€åå°„ã€‘${[refParts.join('ã€'), state.memos.stroke.reflex].filter(Boolean).join('ã€‚')}`); }
    const higherFindings = STR_HIGHER.map(lbl => fmtFinding(lbl, state.chips[lbl])).filter(Boolean);
    if (higherFindings.length || state.memos.stroke.higher) { lines.push(`ã€é«˜æ¬¡è„³/å°è„³ã€‘${[higherFindings.join('ã€'), state.memos.stroke.higher].filter(Boolean).join('ã€‚')}`); }
    let nihSum = 0;
    NIHSS_ITEMS.forEach(item => { nihSum += Number(state.stroke.nih[item.key] || 0); });
    lines.push(`ã€NIHSSã€‘åˆè¨ˆ ${nihSum}${state.stroke.nihMemo ? 'ã€‚' + state.stroke.nihMemo : ''}`);
  } else if (state.examTab === 'cpa') {
    // CPAã‚¤ãƒ™ãƒ³ãƒˆå‡ºåŠ›
    if (state.cpaEvents && state.cpaEvents.length > 0) {
      state.cpaEvents.forEach((event, idx) => {
        const eventTitle = idx === 0 ? 'å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ 1' : `å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ ${idx + 1}ï¼ˆå†å¿ƒåœæ­¢ï¼‰`;
        const eventLines = [`ã€${eventTitle}ã€‘`];
        
        if (idx === 0) {
          // åˆå›å¿ƒåœæ­¢ã®è©³ç´°æƒ…å ±
          eventLines.push(`å¿ƒåœæ­¢æ™‚åˆ»: ${event.arrestTime || '-'}`);
          eventLines.push(`åˆæœŸæ³¢å½¢: ${event.rhythm || 'Asystole'}`);
          eventLines.push(`ç›®æ’ƒ: ${event.witnessed ? 'ã‚ã‚Š' : 'ãªã—'}`);
          eventLines.push(`ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPR: ${event.bystander ? 'ã‚ã‚Š' : 'ãªã—'}`);
          
          if (event.cprStart) eventLines.push(`èƒ¸éª¨åœ§è¿«é–‹å§‹: ${event.cprStart}`);
          if (event.ivTime) eventLines.push(`æœ«æ¢¢ç¢ºä¿: ${event.ivTime}`);
          
          // æ°—é“ç¢ºä¿
          const airway = [];
          if (event.lt) airway.push('LTæŒ¿å…¥');
          if (event.intubation) airway.push(`æ°—ç®¡æŒ¿ç®¡ ${event.intubationTime || ''}`);
          if (airway.length) eventLines.push(`æ°—é“ç¢ºä¿: ${airway.join('ã€')}`);
        } else {
          // å†å¿ƒåœæ­¢
          eventLines.push(`å¿ƒåœæ­¢æ™‚åˆ»: ${event.arrestTime || '-'}`);
          eventLines.push(`æ³¢å½¢: ${event.rhythm || 'Asystole'}`);
        }
        
        // è–¬å‰¤æŠ•ä¸
        if (event.adrenalineTimes && event.adrenalineTimes.length > 0) {
          eventLines.push(`ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³: ${event.adrenalineTimes.join('ã€')}`);
        }
        if (event.amiodaroneTimes && event.amiodaroneTimes.length > 0) {
          eventLines.push(`ã‚¢ãƒŸã‚ªãƒ€ãƒ­ãƒ³: ${event.amiodaroneTimes.join('ã€')}`);
        }
        if (event.atropineTimes && event.atropineTimes.length > 0) {
          eventLines.push(`ã‚¢ãƒˆãƒ­ãƒ”ãƒ³: ${event.atropineTimes.join('ã€')}`);
        }
        if (event.pcpsTime) {
          eventLines.push(`PCPSå°å…¥: ${event.pcpsTime}`);
        }
        
        // è»¢å¸°
        if (event.roscTime) {
          eventLines.push(`ROSCæ™‚åˆ»: ${event.roscTime}`);
        }
        
        // Flow Timeï¼ˆåˆå›å¿ƒåœæ­¢ã®ã¿ï¼‰
        if (idx === 0 && event.arrestTime && event.cprStart) {
          const noFlow = calcTimeDiff(event.arrestTime, event.cprStart);
          if (noFlow !== null) eventLines.push(`No Flow Time: ${noFlow}åˆ†`);
        }
        if (event.cprStart && event.roscTime) {
          const lowFlow = calcTimeDiff(event.cprStart, event.roscTime);
          if (lowFlow !== null) eventLines.push(`Low Flow Time: ${lowFlow}åˆ†`);
        } else if (idx > 0 && event.arrestTime && event.roscTime) {
          const lowFlow = calcTimeDiff(event.arrestTime, event.roscTime);
          if (lowFlow !== null) eventLines.push(`Low Flow Time: ${lowFlow}åˆ†`);
        }
        
        if (event.memo) eventLines.push(`ãƒ¡ãƒ¢: ${event.memo}`);
        
        lines.push(eventLines.join('\n'));
      });
    }
  }
  
  return lines.join('\n');
}

// æ™‚åˆ»å·®åˆ†è¨ˆç®—ï¼ˆåˆ†ï¼‰
function calcTimeDiff(time1, time2) {
  if (!time1 || !time2) return null;
  const [h1, m1] = time1.split(':').map(Number);
  const [h2, m2] = time2.split(':').map(Number);
  let t1 = h1 * 60 + m1;
  let t2 = h2 * 60 + m2;

  // æ—¥ã‚’ã¾ãŸã„ã å ´åˆã‚’è€ƒæ…®ï¼ˆæœ€å¤§24æ™‚é–“ä»¥å†…ã¨ä»®å®šï¼‰
  if (t2 < t1) {
    t2 += 24 * 60;
  }
  
  const diff = t2 - t1;
  return diff >= 0 ? diff : null;
}

function labsText() {
  const lines = [];
  const labLabels = { cbc: 'è¡€ç®—', chem: 'ç”ŸåŒ–å­¦', coag: 'å‡å›º', sugar: 'è¡€ç³–ãƒ»å¿ƒä¸å…¨', gas: 'è¡€æ¶²ã‚¬ã‚¹', urine: 'å°¿å®šæ€§', sediment: 'å°¿æ²ˆæ¸£', tumor: 'è…«ç˜ãƒãƒ¼ã‚«ãƒ¼', endo: 'å†…åˆ†æ³Œ', urineBio: 'å°¿ç”ŸåŒ–', csf: 'é«„æ¶²' };
  
  Object.keys(LABS).forEach(cat => {
    const items = state.labs[cat].filter(x => x.val);
    if (items.length) { lines.push(`${labLabels[cat]}: ${items.map(x => `${x.item} ${x.val}${x.unit ? ' ' + x.unit : ''}`).join(', ')}`); }
  });
  
  if (state.infect.covid.type && state.infect.covid.res) { lines.push(`COVID-19(${state.infect.covid.type}): ${state.infect.covid.res}`); }
  if (state.infect.flu.a) lines.push(`Influenza A: ${state.infect.flu.a}`);
  if (state.infect.flu.b) lines.push(`Influenza B: ${state.infect.flu.b}`);
  state.infect.cultures.forEach(c => { if (c.src && c.res) { lines.push(`åŸ¹é¤Š(${c.src}): ${c.res}${c.note ? ' ' + c.note : ''}`); } });
  
  if (state.labFree) lines.push(state.labFree);
  
  return lines.join('\n');
}

function imagingText() {
  const lines = [];
  const imgLabels = { cxr: 'èƒ¸éƒ¨XP', ct: 'CT', ctc: 'é€ å½±CT', mri: 'MRI' };
  
  ['cxr', 'ct', 'ctc', 'mri'].forEach(key => {
    if (state.imaging[key].on) { lines.push(`${imgLabels[key]}: ${state.imaging[key].txt || 'ï¼ˆæ‰€è¦‹ãªã—ï¼‰'}`); }
  });
  
  if (state.imaging.other.on && state.imaging.other.name) {
    lines.push(`${state.imaging.other.name}: ${state.imaging.other.txt || 'ï¼ˆæ‰€è¦‹ãªã—ï¼‰'}`);
  }
  
  return lines.join('\n');
}

function physText() {
  const lines = [];
  
  if (state.phys.ecg.on) {
    const ecgParts = [];
    if (state.phys.ecg.rhythm) ecgParts.push(`èª¿å¾‹:${state.phys.ecg.rhythm}`);
    if (state.phys.ecg.rate) ecgParts.push(`HR:${state.phys.ecg.rate}`);
    if (state.phys.ecg.st) ecgParts.push(`ST-T:${state.phys.ecg.st}`);
    if (state.phys.ecg.qtc) ecgParts.push(`QTc:${state.phys.ecg.qtc}`);
    const ecgMain = ecgParts.join(', ');
    const ecgAll = [ecgMain, state.phys.ecg.txt].filter(Boolean).join('ã€‚');
    lines.push(`å¿ƒé›»å›³: ${ecgAll || 'ï¼ˆæ‰€è¦‹ãªã—ï¼‰'}`);
  }
  if (state.phys.eeg.on) { lines.push(`è„³æ³¢: ${state.phys.eeg.txt || 'ï¼ˆæ‰€è¦‹ãªã—ï¼‰'}`); }
  if (state.phys.us.on) { lines.push(`è¶…éŸ³æ³¢: ${state.phys.us.txt || 'ï¼ˆæ‰€è¦‹ãªã—ï¼‰'}`); }
  if (state.phys.other.on && state.phys.other.name) {
    lines.push(`${state.phys.other.name}: ${state.phys.other.txt || 'ï¼ˆæ‰€è¦‹ãªã—ï¼‰'}`);
  }
  
  return lines.join('\n');
}

function problemsText() {
  if (!state.problems.length) return 'ï¼ˆæœªè¨­å®šï¼‰';
  const tagLine = state.problems.map((p, i) => `#${i + 1} ${p.name}`).join(', ');
  const details = state.problems.map((p, i) => `#${i + 1}â†’${p.note || 'ï¼ˆè€ƒå¯Ÿãªã—ï¼‰'}`).join('\n');
  return `${tagLine}\n\n${details}`;
}

function renderOutput() {
  const output = `ã€å…¥é™¢ã‚µãƒãƒªã€‘

ï¼»ä¸»è¨´ï¼½${state.cc || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}

ï¼»å—è¨ºæ—¥ï¼½${state.visitDate || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}

ï¼»ç¾ç—…æ­´ï¼½
${state.hpi || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}

ï¼»æ—¢å¾€æ­´ï¼½${state.pmh || 'ãªã—'}
ï¼»å¸¸ç”¨è–¬ï¼½${state.meds || 'ãªã—'}
ï¼»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ï¼½${state.allergy || 'ãªã—'}
ï¼»å®¶æ—æ­´ï¼½${state.familyHx || 'ç‰¹è¨˜ãªã—'}
ï¼»å—œå¥½æ­´ï¼½${state.habits || 'ç‰¹è¨˜ãªã—'}
ï¼»ç”Ÿæ´»æ­´ï¼½${state.social || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}
ï¼»ã‚­ãƒ¼ãƒ‘ãƒ¼ã‚½ãƒ³ï¼½${state.keyPerson || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}

ï¼»èº«ä½“æ‰€è¦‹ï¼½
${examText()}

ï¼»æ¤œæŸ»æ‰€è¦‹ï¼½
${labsText() || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}

ï¼»ç”»åƒæ¤œæŸ»ï¼½
${imagingText() || 'ï¼ˆæœªå®Ÿæ–½ï¼‰'}

ï¼»ç”Ÿç†æ©Ÿèƒ½æ¤œæŸ»ï¼½
${physText() || 'ï¼ˆæœªå®Ÿæ–½ï¼‰'}

ï¼»ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ãƒªã‚¹ãƒˆï¼½
${problemsText()}

ï¼»å…¥é™¢å¾ŒçµŒéï¼½
${state.courseText || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}

ï¼»æ–¹é‡ï¼ˆPï¼‰ï¼½
${state.planText || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}
`;
  
  $('#outputText').textContent = output;
}

$('#copyOut').addEventListener('click', () => {
  navigator.clipboard.writeText($('#outputText').textContent).then(() => {
    const btn = $('#copyOut');
    btn.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†';
    setTimeout(() => { btn.textContent = 'ã‚³ãƒ”ãƒ¼'; }, 1500);
  });
});

$('#printOut').addEventListener('click', () => window.print());

$('#btnReset').addEventListener('click', () => {
  if (confirm('ç¾åœ¨ã®è¨˜éŒ²ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
    if (currentRecordId) {
      deleteRecord(currentRecordId);
    } else {
      newRecord();
    }
  }
});

$('#btnResetMain').addEventListener('click', () => {
  if (confirm('ç¾åœ¨ã®è¨˜éŒ²ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
    if (currentRecordId) {
      deleteRecord(currentRecordId);
    } else {
      newRecord();
    }
  }
});

// CPA ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†
function initCpaEvents() {
  const addBtn = $('#addCpaEventBtn');
  if (addBtn) {
    addBtn.addEventListener('click', addCpaEvent);
  }
  renderCpaEvents();
}

function addCpaEvent() {
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  
  const newEvent = {
    arrestTime: time,
    rhythm: 'Asystole',
    witnessed: false,
    bystander: false,
    cprStart: '',
    ivTime: '',
    adrenalineTimes: [],
    amiodaroneTimes: [],
    atropineTimes: [],
    pcpsTime: '',
    lt: false,
    intubation: false,
    intubationTime: '',
    roscTime: '',
    memo: ''
  };
  
  state.cpaEvents.push(newEvent);
  renderCpaEvents();
  save();
}

function deleteCpaEvent(idx) {
  if (confirm('ã“ã®å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    state.cpaEvents.splice(idx, 1);
    renderCpaEvents();
    save();
  }
}

function updateCpaEventField(idx, field, value) {
  if (state.cpaEvents[idx]) {
    state.cpaEvents[idx][field] = value;
    if (field === 'arrestTime' || field === 'cprStart' || field === 'roscTime') {
      // Flow Timeã‚’å†è¨ˆç®—ãƒ»è¡¨ç¤º
      const eventCard = document.querySelector(`#cpaEventsContainer > div:nth-child(${idx + 1})`);
      if (eventCard) {
        calcFlowTimes(idx);
      }
    }
    save();
  }
}

function setCpaEventNow(idx, field) {
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  updateCpaEventField(idx, field, time);
  renderCpaEvents();
}

function toggleCpaField(idx, field) {
  if (state.cpaEvents[idx]) {
    state.cpaEvents[idx][field] = !state.cpaEvents[idx][field];
    renderCpaEvents();
    save();
  }
}

function addAdrenalineTime(idx) {
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  if (!state.cpaEvents[idx].adrenalineTimes) state.cpaEvents[idx].adrenalineTimes = [];
  state.cpaEvents[idx].adrenalineTimes.push(time);
  renderCpaEvents();
  save();
}

function deleteAdrenalineTime(eventIdx, adrIdx) {
  state.cpaEvents[eventIdx].adrenalineTimes.splice(adrIdx, 1);
  renderCpaEvents();
  save();
}

function updateAdrenalineTime(eventIdx, adrIdx, value) {
  if (state.cpaEvents[eventIdx] && state.cpaEvents[eventIdx].adrenalineTimes) {
    state.cpaEvents[eventIdx].adrenalineTimes[adrIdx] = value;
    save();
  }
}

function addAmiodaroneTime(idx) {
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  if (!state.cpaEvents[idx].amiodaroneTimes) {
    state.cpaEvents[idx].amiodaroneTimes = [];
  }
  state.cpaEvents[idx].amiodaroneTimes.push(time);
  renderCpaEvents();
  save();
}

function deleteAmiodaroneTime(eventIdx, adrIdx) {
  state.cpaEvents[eventIdx].amiodaroneTimes.splice(adrIdx, 1);
  renderCpaEvents();
  save();
}

function updateAmiodaroneTime(eventIdx, adrIdx, value) {
  if (state.cpaEvents[eventIdx] && state.cpaEvents[eventIdx].amiodaroneTimes) {
    state.cpaEvents[eventIdx].amiodaroneTimes[adrIdx] = value;
    save();
  }
}

function addAtropineTime(idx) {
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  if (!state.cpaEvents[idx].atropineTimes) {
    state.cpaEvents[idx].atropineTimes = [];
  }
  state.cpaEvents[idx].atropineTimes.push(time);
  renderCpaEvents();
  save();
}

function deleteAtropineTime(eventIdx, adrIdx) {
  state.cpaEvents[eventIdx].atropineTimes.splice(adrIdx, 1);
  renderCpaEvents();
  save();
}

function updateAtropineTime(eventIdx, adrIdx, value) {
  if (state.cpaEvents[eventIdx] && state.cpaEvents[eventIdx].atropineTimes) {
    state.cpaEvents[eventIdx].atropineTimes[adrIdx] = value;
    save();
  }
}

function openCpaRhythmDialog(idx) {
  const rhythms = ['Vf', 'Pulseless VT', 'PEA', 'Asystole'];
  const current = state.cpaEvents[idx].rhythm;
  
  // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œã°é–‰ã˜ã‚‹
  if (window.currentCpaRhythmModal) {
    closeCpaRhythmDialog();
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½œæˆ
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;';
  
  const dialog = document.createElement('div');
  dialog.style.cssText = 'background:#fff;border-radius:12px;padding:20px;max-width:400px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.3);';
  
  const buttonStyle = (rhythm) => `
    padding:14px;
    border:2px solid ${rhythm === current ? 'var(--brand)' : 'var(--line)'};
    background:${rhythm === current ? '#e0f2fe' : '#fff'};
    border-radius:8px;
    font-size:15px;
    font-weight:500;
    cursor:pointer;
    text-align:left;
    color:${rhythm === current ? 'var(--brand)' : 'var(--ink)'};
    transition:all 0.15s;
    -webkit-tap-highlight-color:transparent;
  `;
  
  dialog.innerHTML = `
    <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:600;">æ³¢å½¢ã‚’é¸æŠ</h3>
    <div style="display:grid;gap:10px;">
      ${rhythms.map(rhythm => `
        <button class="rhythm-select-btn" data-rhythm="${rhythm}" 
                style="${buttonStyle(rhythm)}">
          ${rhythm === current ? 'âœ“ ' : ''}${rhythm}
        </button>
      `).join('')}
    </div>
    <button id="cancelRhythmBtn" 
            style="margin-top:16px;width:100%;padding:12px;border:none;background:#f3f4f6;
                   border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;
                   transition:all 0.15s;-webkit-tap-highlight-color:transparent;">
      ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    </button>
  `;
  
  modal.appendChild(dialog);
  document.body.appendChild(modal);
  
  // æ³¢å½¢é¸æŠãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  dialog.querySelectorAll('.rhythm-select-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const rhythm = btn.dataset.rhythm;
      state.cpaEvents[idx].rhythm = rhythm;
      renderCpaEvents();
      save();
      closeCpaRhythmDialog();
    });
    // ã‚¿ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    btn.addEventListener('touchstart', () => {
      btn.style.transform = 'scale(0.97)';
    });
    btn.addEventListener('touchend', () => {
      btn.style.transform = 'scale(1)';
    });
  });
  
  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
  dialog.querySelector('#cancelRhythmBtn').addEventListener('click', closeCpaRhythmDialog);
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeCpaRhythmDialog();
    }
  });
  
  // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä¿å­˜
  window.currentCpaRhythmModal = modal;
}

function closeCpaRhythmDialog() {
  if (window.currentCpaRhythmModal) {
    window.currentCpaRhythmModal.remove();
    window.currentCpaRhythmModal = null;
  }
}

function calcFlowTimes(idx) {
  const event = state.cpaEvents[idx];
  if (!event) return;
  
  const noFlowEl = document.getElementById(`no_flow_time_${idx}`);
  const lowFlowEl = document.getElementById(`low_flow_time_${idx}`);
  
  if (!noFlowEl && !lowFlowEl) return;
  
  // No Flow Time: å¿ƒåœæ­¢ã€œCPRé–‹å§‹ (åˆå›å¿ƒåœæ­¢ã®ã¿)
  if (noFlowEl && idx === 0) {
    if (event.arrestTime && event.cprStart) {
      const diff = calcTimeDiff(event.arrestTime, event.cprStart);
      noFlowEl.textContent = diff !== null ? `${diff} åˆ†` : '-- åˆ†';
    } else {
      noFlowEl.textContent = '-- åˆ†';
    }
  }
  
  // Low Flow Time: CPRé–‹å§‹ã€œROSC ã¾ãŸã¯ å†å¿ƒåœæ­¢ã€œROSC
  if (lowFlowEl) {
    let startTime = event.cprStart;
    if (!startTime && idx > 0) {
      // å†å¿ƒåœæ­¢ã®å ´åˆã¯ãã®å¿ƒåœæ­¢æ™‚åˆ»ã‚’Low Flowã®é–‹å§‹ã¨ã™ã‚‹
      startTime = event.arrestTime;
    }
    
    if (startTime && event.roscTime) {
      const diff = calcTimeDiff(startTime, event.roscTime);
      lowFlowEl.textContent = diff !== null ? `${diff} åˆ†` : '-- åˆ†';
    } else {
      lowFlowEl.textContent = '-- åˆ†';
    }
  }
}

function parseTime(timeStr) {
  if (!timeStr) return null;
  const [h, m] = timeStr.split(':').map(Number);
  const now = new Date();
  // å¹´æœˆæ—¥ã¯ã€Œä»Šæ—¥ã€ã‚’ä½¿ã„ã€æ™‚åˆ»æƒ…å ±ã‚’ãƒŸãƒªç§’ã§è¿”ã™
  return new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m).getTime();
}

function renderCpaEvents() {
  const container = $('#cpaEventsContainer');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (state.cpaEvents.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-size:13px">å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
    return;
  }
  
  state.cpaEvents.forEach((event, idx) => {
    const card = document.createElement('div');
    card.style.cssText = 'border:1px solid var(--line);border-radius:10px;margin-bottom:12px;overflow:hidden;background:#fff';
    
    const isFirst = idx === 0;
    
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f9fafb;border-bottom:1px solid var(--line);">
        <div style="font-weight:600;font-size:14px;">å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ ${idx + 1}${!isFirst ? 'ï¼ˆå†å¿ƒåœæ­¢ï¼‰' : ''}${event.roscTime ? ' (ROSC)' : ''}</div>
        <button onclick="deleteCpaEvent(${idx})" style="background:#fee2e2;color:#dc2626;border:none;border-radius:6px;padding:4px 10px;font-size:12px;font-weight:500;">å‰Šé™¤</button>
      </div>
      <div style="padding:12px;">
        ${isFirst ? `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
          <div>
            <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">å¿ƒåœæ­¢æ™‚åˆ»</label>
            <div style="display:flex;gap:6px;">
              <input type="time" value="${event.arrestTime}" onchange="updateCpaEventField(${idx}, 'arrestTime', this.value)" style="flex:1;padding:8px;border:1px solid var(--line);border-radius:6px;font-size:14px;">
              <button onclick="setCpaEventNow(${idx}, 'arrestTime')" style="background:var(--brand);color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:12px;white-space:nowrap;">Now</button>
            </div>
          </div>
          <div>
            <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">åˆæœŸæ³¢å½¢</label>
            <div onclick="openCpaRhythmDialog(${idx})" style="border:1px solid var(--line);border-radius:6px;padding:8px;text-align:center;cursor:pointer;background:#fafafa;">
              <div style="font-size:14px;font-weight:500;">${event.rhythm}</div>
            </div>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
          <div onclick="toggleCpaField(${idx}, 'witnessed')" style="border:1.5px solid ${event.witnessed ? '#4ade80' : 'var(--line)'};background:${event.witnessed ? '#dcfce7' : '#f9fafb'};border-radius:8px;padding:10px;text-align:center;cursor:pointer;font-size:13px;font-weight:500;color:${event.witnessed ? '#15803d' : 'var(--ink)'};">
            ${event.witnessed ? 'ç›®æ’ƒã‚ã‚Š' : 'ç›®æ’ƒãªã—'}
          </div>
          <div onclick="toggleCpaField(${idx}, 'bystander')" style="border:1.5px solid ${event.bystander ? '#4ade80' : 'var(--line)'};background:${event.bystander ? '#dcfce7' : '#f9fafb'};border-radius:8px;padding:10px;text-align:center;cursor:pointer;font-size:13px;font-weight:500;color:${event.bystander ? '#15803d' : 'var(--ink)'};">
            ${event.bystander ? 'ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRã‚ã‚Š' : 'ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRãªã—'}
          </div>
        </div>
        
        <h4 style="margin:12px 0 8px 0;font-size:13px;color:var(--muted);">è˜‡ç”Ÿå‡¦ç½®</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
          <div>
            <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">èƒ¸éª¨åœ§è¿«é–‹å§‹</label>
            <div style="display:flex;gap:6px;">
              <input type="time" value="${event.cprStart}" onchange="updateCpaEventField(${idx}, 'cprStart', this.value)" style="flex:1;padding:8px;border:1px solid var(--line);border-radius:6px;font-size:14px;">
              <button onclick="setCpaEventNow(${idx}, 'cprStart')" style="background:var(--brand);color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:12px;white-space:nowrap;">Now</button>
            </div>
          </div>
          <div>
            <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">æœ«æ¢¢ç¢ºä¿</label>
            <div style="display:flex;gap:6px;">
              <input type="time" value="${event.ivTime}" onchange="updateCpaEventField(${idx}, 'ivTime', this.value)" style="flex:1;padding:8px;border:1px solid var(--line);border-radius:6px;font-size:14px;">
              <button onclick="setCpaEventNow(${idx}, 'ivTime')" style="background:var(--brand);color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:12px;white-space:nowrap;">Now</button>
            </div>
          </div>
        </div>
        
        <h4 style="margin:12px 0 8px 0;font-size:13px;color:var(--muted);">æ°—é“ç¢ºä¿</h4>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--line);border-radius:6px;cursor:pointer;background:${event.lt ? '#dcfce7' : '#f9fafb'};flex:1;">
            <input type="checkbox" ${event.lt ? 'checked' : ''} onchange="updateCpaEventField(${idx}, 'lt', this.checked)" style="width:16px;height:16px;">
            <span style="font-size:13px;">LTæŒ¿å…¥</span>
          </label>
          <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--line);border-radius:6px;cursor:pointer;background:${event.intubation ? '#dcfce7' : '#f9fafb'};flex:1;">
            <input type="checkbox" ${event.intubation ? 'checked' : ''} onchange="updateCpaEventField(${idx}, 'intubation', this.checked); renderCpaEvents();" style="width:16px;height:16px;">
            <span style="font-size:13px;">æ°—ç®¡æŒ¿ç®¡</span>
          </label>
        </div>
        ${event.intubation ? `
        <div style="margin-bottom:12px;">
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">æŒ¿ç®¡æ™‚åˆ»</label>
          <div style="display:flex;gap:6px;">
            <input type="time" value="${event.intubationTime}" onchange="updateCpaEventField(${idx}, 'intubationTime', this.value)" style="flex:1;padding:8px;border:1px solid var(--line);border-radius:6px;font-size:14px;">
            <button onclick="setCpaEventNow(${idx}, 'intubationTime')" style="background:var(--brand);color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:12px;white-space:nowrap;">Now</button>
          </div>
        </div>` : ''}
        ` : `
        <div style="margin-bottom:12px;">
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">å¿ƒåœæ­¢æ™‚åˆ»</label>
          <div style="display:flex;gap:6px;">
            <input type="time" value="${event.arrestTime}" onchange="updateCpaEventField(${idx}, 'arrestTime', this.value)" style="flex:1;padding:8px;border:1px solid var(--line);border-radius:6px;font-size:14px;">
            <button onclick="setCpaEventNow(${idx}, 'arrestTime')" style="background:var(--brand);color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:12px;white-space:nowrap;">Now</button>
          </div>
        </div>
        <div style="margin-bottom:12px;">
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">æ³¢å½¢</label>
          <div onclick="openCpaRhythmDialog(${idx})" style="border:1px solid var(--line);border-radius:6px;padding:8px;text-align:center;cursor:pointer;background:#fafafa;">
            <div style="font-size:14px;font-weight:500;">${event.rhythm}</div>
          </div>
        </div>
        `}
        
        <h4 style="margin:12px 0 8px 0;font-size:13px;color:var(--muted);">ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³æŠ•ä¸</h4>
        <div id="adrenaline_times_${idx}" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;"></div>
        <button onclick="addAdrenalineTime(${idx})" style="background:#f3f4f6;border:1px solid var(--line);border-radius:6px;padding:8px 12px;font-size:12px;width:100%;">ï¼‹ ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³è¿½åŠ </button>
        
        <h4 style="margin:12px 0 8px 0;font-size:13px;color:var(--muted);">ã‚¢ãƒŸã‚ªãƒ€ãƒ­ãƒ³æŠ•ä¸</h4>
        <div id="amiodarone_times_${idx}" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;"></div>
        <button onclick="addAmiodaroneTime(${idx})" style="background:#f3f4f6;border:1px solid var(--line);border-radius:6px;padding:8px 12px;font-size:12px;width:100%;">ï¼‹ ã‚¢ãƒŸã‚ªãƒ€ãƒ­ãƒ³è¿½åŠ </button>
        
        <h4 style="margin:12px 0 8px 0;font-size:13px;color:var(--muted);">ã‚¢ãƒˆãƒ­ãƒ”ãƒ³æŠ•ä¸</h4>
        <div id="atropine_times_${idx}" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;"></div>
        <button onclick="addAtropineTime(${idx})" style="background:#f3f4f6;border:1px solid var(--line);border-radius:6px;padding:8px 12px;font-size:12px;width:100%;">ï¼‹ ã‚¢ãƒˆãƒ­ãƒ”ãƒ³è¿½åŠ </button>
        
        <h4 style="margin:12px 0 8px 0;font-size:13px;color:var(--muted);">PCPS</h4>
        <div style="margin-bottom:12px;">
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">PCPSå°å…¥æ™‚åˆ»</label>
          <div style="display:flex;gap:6px;">
            <input type="time" value="${event.pcpsTime || ''}" onchange="updateCpaEventField(${idx}, 'pcpsTime', this.value)" style="flex:1;padding:8px;border:1px solid var(--line);border-radius:6px;font-size:14px;">
            <button onclick="setCpaEventNow(${idx}, 'pcpsTime')" style="background:var(--brand);color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:12px;white-space:nowrap;">Now</button>
          </div>
        </div>
        
        <h4 style="margin:12px 0 8px 0;font-size:13px;color:var(--muted);">è»¢å¸°</h4>
        <div style="margin-bottom:12px;">
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">å¿ƒæ‹å†é–‹(ROSC)æ™‚åˆ»</label>
          <div style="display:flex;gap:6px;">
            <input type="time" value="${event.roscTime}" onchange="updateCpaEventField(${idx}, 'roscTime', this.value)" style="flex:1;padding:8px;border:1px solid var(--line);border-radius:6px;font-size:14px;">
            <button onclick="setCpaEventNow(${idx}, 'roscTime')" style="background:var(--brand);color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:12px;white-space:nowrap;">Now</button>
          </div>
        </div>
        
        ${isFirst ? `
        <div style="padding:12px;background:#f0f9ff;border:1px solid #0ea5e9;border-radius:8px;margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <span style="font-weight:600;color:#0369a1;font-size:12px;">No Flow Time</span>
            <span id="no_flow_time_${idx}" style="font-weight:600;color:#0369a1;font-size:12px;">-- åˆ†</span>
          </div>
          <div style="display:flex;justify-content:space-between;">
            <span style="font-weight:600;color:#0369a1;font-size:12px;">Low Flow Time</span>
            <span id="low_flow_time_${idx}" style="font-weight:600;color:#0369a1;font-size:12px;">-- åˆ†</span>
          </div>
        </div>
        ` : `
        <div style="padding:12px;background:#f0f9ff;border:1px solid #0ea5e9;border-radius:8px;margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;">
            <span style="font-weight:600;color:#0369a1;font-size:12px;">Low Flow Time</span>
            <span id="low_flow_time_${idx}" style="font-weight:600;color:#0369a1;font-size:12px;">-- åˆ†</span>
          </div>
        </div>
        `}
        
        <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">ãƒ¡ãƒ¢</label>
        <textarea rows="2" placeholder="ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã«é–¢ã™ã‚‹ãƒ¡ãƒ¢" onchange="updateCpaEventField(${idx}, 'memo', this.value)" style="width:100%;padding:8px;border:1px solid var(--line);border-radius:6px;font-size:13px;resize:none;">${event.memo}</textarea>
      </div>
    `;
    
    container.appendChild(card);
    
    // ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³æŠ•ä¸æ™‚åˆ»ã‚’æç”»
    const adrContainer = card.querySelector(`#adrenaline_times_${idx}`);
    if (adrContainer && event.adrenalineTimes) {
      event.adrenalineTimes.forEach((time, adrIdx) => {
        const adrDiv = document.createElement('div');
        adrDiv.style.cssText = 'display:flex;gap:4px;align-items:center;';
        adrDiv.innerHTML = `
          <span style="font-size:11px;color:var(--muted);">${adrIdx + 1}å›ç›®</span>
          <input type="time" value="${time}" onchange="updateAdrenalineTime(${idx}, ${adrIdx}, this.value)" style="padding:4px 6px;border:1px solid var(--line);border-radius:4px;font-size:12px;">
          <button onclick="deleteAdrenalineTime(${idx}, ${adrIdx})" style="background:#fee2e2;color:#dc2626;border:none;border-radius:4px;padding:4px 8px;font-size:11px;">Ã—</button>
        `;
        adrContainer.appendChild(adrDiv);
      });
    }
    
    // ã‚¢ãƒŸã‚ªãƒ€ãƒ­ãƒ³æŠ•ä¸æ™‚åˆ»ã‚’æç”»
    const amiodaroneContainer = card.querySelector(`#amiodarone_times_${idx}`);
    if (amiodaroneContainer && event.amiodaroneTimes) {
      event.amiodaroneTimes.forEach((time, adrIdx) => {
        const adrDiv = document.createElement('div');
        adrDiv.style.cssText = 'display:flex;gap:4px;align-items:center;';
        adrDiv.innerHTML = `
          <span style="font-size:11px;color:var(--muted);">${adrIdx + 1}å›ç›®</span>
          <input type="time" value="${time}" onchange="updateAmiodaroneTime(${idx}, ${adrIdx}, this.value)" style="padding:4px 6px;border:1px solid var(--line);border-radius:4px;font-size:12px;">
          <button onclick="deleteAmiodaroneTime(${idx}, ${adrIdx})" style="background:#fee2e2;color:#dc2626;border:none;border-radius:4px;padding:4px 8px;font-size:11px;">Ã—</button>
        `;
        amiodaroneContainer.appendChild(adrDiv);
      });
    }
    
    // ã‚¢ãƒˆãƒ­ãƒ”ãƒ³æŠ•ä¸æ™‚åˆ»ã‚’æç”»
    const atropineContainer = card.querySelector(`#atropine_times_${idx}`);
    if (atropineContainer && event.atropineTimes) {
      event.atropineTimes.forEach((time, adrIdx) => {
        const adrDiv = document.createElement('div');
        adrDiv.style.cssText = 'display:flex;gap:4px;align-items:center;';
        adrDiv.innerHTML = `
          <span style="font-size:11px;color:var(--muted);">${adrIdx + 1}å›ç›®</span>
          <input type="time" value="${time}" onchange="updateAtropineTime(${idx}, ${adrIdx}, this.value)" style="padding:4px 6px;border:1px solid var(--line);border-radius:4px;font-size:12px;">
          <button onclick="deleteAtropineTime(${idx}, ${adrIdx})" style="background:#fee2e2;color:#dc2626;border:none;border-radius:4px;padding:4px 8px;font-size:11px;">Ã—</button>
        `;
        atropineContainer.appendChild(adrDiv);
      });
    }
    
    // Flow Timeè¨ˆç®—
    calcFlowTimes(idx);
  });
}

// CPAã‚¿ãƒ–é¸æŠæ™‚ã«ãƒã‚¤ã‚¿ãƒ«ã‚’CPAåˆæœŸå€¤ã«è¨­å®š
function setCpaVitalDefaults() {
  if (!confirm('CPAãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚\nãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã‚’CPAåˆæœŸå€¤ï¼ˆBP:-/-, HR:-, RR:-, SpO2:æ¸¬å®šä¸èƒ½, BT:å®Ÿæ¸¬å€¤, GCS:E1V1M1ï¼‰ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ')) {
    return;
  }
  
  // ãƒã‚¤ã‚¿ãƒ«ãŒç©ºã®å ´åˆã¯1ã¤è¿½åŠ 
  if (state.vitals.length === 0) {
    state.vitals.push({ time: '', sbp: 120, dbp: 80, hr: 72, rr: 16, spo2: 98, bt: 36.6, gcs: { e: 4, v: 5, m: 6 } });
  }

  state.vitals.forEach(v => {
    v.sbp = 0;
    v.dbp = 0;
    v.hr = 0;
    v.rr = 0;
    v.spo2 = 0;
    // BTã¯å®Ÿæ¸¬å€¤ã‚’ä¿æŒï¼ˆv.btãŒundefinedã‚„nullã®å ´åˆã¯36.6ã«è¨­å®šï¼‰
    v.bt = v.bt === undefined || v.bt === null ? 36.6 : v.bt;
    v.gcs = { e: 1, v: 1, m: 1 };
  });
  
  renderVitals();
  save();
}

// è¨˜éŒ²ç®¡ç†ã®åˆæœŸåŒ–
function initRecordsManager() {
  const modal = $('#recordsModal');
  const openBtn = $('#btnRecords');
  const closeBtn = $('#recordsModalClose');
  const newRecordBtn = $('#newRecordBtn');
  
  if (!modal || !openBtn || !closeBtn || !newRecordBtn) {
    console.error('Records manager elements not found');
    return;
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  openBtn.addEventListener('click', () => {
    renderRecordsList();
    modal.style.display = 'block';
  });
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  closeBtn.addEventListener('click', () => {
    modal.style.display = 'none';
  });
  
  // æ–°è¦è¨˜éŒ²
  newRecordBtn.addEventListener('click', () => {
    if (!state.cc && !state.hpi && state.vitals.length === 0) {
      // ç©ºã®çŠ¶æ…‹ãªã‚‰ç¢ºèªãªã—ã§æ–°è¦ä½œæˆ
      newRecord();
    } else {
      if (confirm('ç¾åœ¨ã®è¨˜éŒ²ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚\næ–°ã—ã„è¨˜éŒ²ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ')) {
        newRecord();
      }
    }
    modal.style.display = 'none';
  });
}

function renderRecordsList() {
  const list = $('#recordsList');
  if (!list) return;
  
  const records = getRecordsList();
  
  if (records.length === 0) {
    list.innerHTML = '<p style="text-align:center;color:#9ca3af;font-size:13px;padding:20px">ä¿å­˜ã•ã‚ŒãŸè¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
    return;
  }
  
  list.innerHTML = '';
  
  records.forEach(record => {
    const recordDiv = document.createElement('div');
    const isCurrentRecord = record.id === currentRecordId;
    
    recordDiv.style.cssText = `
      background: ${isCurrentRecord ? '#dbeafe' : '#f9fafb'};
      border: 1px solid ${isCurrentRecord ? '#3b82f6' : '#e5e7eb'};
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.15s;
    `;
    
    const date = new Date(record.lastUpdated);
    const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    
    recordDiv.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:start">
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;font-size:14px;color:#111827;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
            ${isCurrentRecord ? 'ğŸ“ ' : ''}${record.title}
          </div>
          <div style="font-size:12px;color:#6b7280">
            ${dateStr}
          </div>
        </div>
        <button onclick="deleteRecord('${record.id}'); event.stopPropagation();" style="background:#fee2e2;color:#dc2626;border:none;border-radius:4px;padding:4px 8px;font-size:11px;margin-left:8px;flex-shrink:0">å‰Šé™¤</button>
      </div>
    `;
    
    if (!isCurrentRecord) {
      recordDiv.addEventListener('click', () => {
        if (confirm('ã“ã®è¨˜éŒ²ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®è¨˜éŒ²ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚')) {
          load(record.id);
          location.reload();
        }
      });
      
      recordDiv.addEventListener('mouseenter', () => {
        recordDiv.style.background = '#f3f4f6';
      });
      
      recordDiv.addEventListener('mouseleave', () => {
        recordDiv.style.background = '#f9fafb';
      });
    }
    
    list.appendChild(recordDiv);
  });
}

function init() {
  migrateFromOldVersion(); // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã®ç§»è¡Œ
  load();
  initRecordsManager(); // è¨˜éŒ²ç®¡ç†ã®åˆæœŸåŒ–
  bindInputs();
  initVitals();
  initVitalImageReader();
  mountChips();
  initStroke();
  initCpaEvents();
  bindMemos();
  initLabs();
  initLabOCR();
  initGeminiAPI();
  initInfect();
  initImaging();
  initPhys();
  initProblems();
  
  $$('.chip').forEach(el => { const st = state.chips[el.textContent]; if (st) el.dataset.state = st; });
  switchExamTab(state.examTab || 'general');
  
  // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚’åˆæœŸåŒ–
  initSwipeGesture();
}

// ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼æ¤œå‡º
function initSwipeGesture() {
  // ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ã®é †åº (data-tab å±æ€§ã¨ä¸€è‡´ã•ã›ã‚‹)
  const mainTabs = ['history', 'exam', 'lab', 'image', 'assess', 'output'];
  // æ¤œæŸ»ã‚¿ãƒ–ã®é †åº (data-exam å±æ€§ã¨ä¸€è‡´ã•ã›ã‚‹)
  const examTabs = ['general', 'trauma', 'stroke', 'cpa'];
  
  let touchStartX = 0;
  let touchStartY = 0;
  let touchEndX = 0;
  let touchEndY = 0;
  
  const minSwipeDistance = 50; // æœ€å°ã‚¹ãƒ¯ã‚¤ãƒ—è·é›¢ï¼ˆpxï¼‰
  const maxVerticalMovement = 50; // æœ€å¤§å‚ç›´ç§»å‹•é‡ï¼ˆpxï¼‰

  // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã§ã®ã‚¹ãƒ¯ã‚¤ãƒ—
  const mainContent = $('main');
  if (!mainContent) return;
  
  mainContent.addEventListener('touchstart', (e) => {
    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€ãƒœã‚¿ãƒ³ã€ãƒªãƒ³ã‚¯ã€ã‚»ãƒ¬ã‚¯ãƒˆè¦ç´ å†…ã§ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã¯ç„¡åŠ¹
    if (e.target.tagName === 'INPUT' || 
        e.target.tagName === 'TEXTAREA' || 
        e.target.tagName === 'BUTTON' ||
        e.target.tagName === 'A' ||
        e.target.tagName === 'SELECT' ||
        e.target.closest('button') ||
        e.target.closest('select') ||
        e.target.closest('.chip') ||
        e.target.closest('.exam-tab')) {
      return;
    }
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªè¦ç´ ã®å ´åˆã¯ç„¡åŠ¹
    if (mainContent.scrollHeight > mainContent.clientHeight) {
       // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªè¦ç´ å†…ã§ãªã‘ã‚Œã°OK
    }

    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
  }, { passive: true });
  
  mainContent.addEventListener('touchend', (e) => {
    // touchstartã§ãƒã‚§ãƒƒã‚¯ã—ãŸã®ã¨åŒã˜è¦ç´ ã‚’ç„¡è¦–
    if (e.target.tagName === 'INPUT' || 
        e.target.tagName === 'TEXTAREA' || 
        e.target.tagName === 'BUTTON' ||
        e.target.tagName === 'A' ||
        e.target.tagName === 'SELECT' ||
        e.target.closest('button') ||
        e.target.closest('select') ||
        e.target.closest('.chip') ||
        e.target.closest('.exam-tab')) {
      return;
    }
    
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    
    handleSwipe();
  }, { passive: true });
  
  function handleSwipe() {
    const deltaX = touchEndX - touchStartX;
    const deltaY = touchEndY - touchStartY;
    
    // å‚ç›´æ–¹å‘ã®å‹•ããŒå¤§ãã™ãã‚‹å ´åˆã¯ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨è¦‹ãªã—ã¦ç„¡è¦–
    if (Math.abs(deltaY) > maxVerticalMovement) {
      return;
    }

    // æ°´å¹³æ–¹å‘ã®ã‚¹ãƒ¯ã‚¤ãƒ—ãŒæœ€å°è·é›¢ã‚’æº€ãŸã—ã¦ã„ã‚‹å ´åˆã®ã¿å‡¦ç†
    if (Math.abs(deltaX) > minSwipeDistance) {
      const activeMainTabEl = $('.tab-bar-item.active');
      if (!activeMainTabEl) return;

      const currentTab = activeMainTabEl.dataset.tab;
      const currentIndex = mainTabs.indexOf(currentTab);
      
      let newTabIndex = -1;
      
      if (deltaX > 0) {
        // å³ã‚¹ãƒ¯ã‚¤ãƒ— â†’ å‰ã®ã‚¿ãƒ–
        if (currentIndex > 0) {
          newTabIndex = currentIndex - 1;
        }
      } else {
        // å·¦ã‚¹ãƒ¯ã‚¤ãƒ— â†’ æ¬¡ã®ã‚¿ãƒ–
        if (currentIndex < mainTabs.length - 1) {
          newTabIndex = currentIndex + 1;
        }
      }
      
      if (newTabIndex !== -1) {
        // ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
        switchTab(mainTabs[newTabIndex]);
        return; 
      }

      // ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆãŒè¡Œã‚ã‚Œãªã‹ã£ãŸå ´åˆã€æ¤œæŸ»ã‚¿ãƒ–å†…ã§ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ç¢ºèª
      if (currentTab === 'exam') {
        const activeExamTabEl = $('.exam-tab.active');
        if (activeExamTabEl) {
          const currentExamTab = activeExamTabEl.dataset.exam;
          const currentExamIndex = examTabs.indexOf(currentExamTab);
          
          let newExamIndex = -1;

          if (deltaX > 0) {
            // å³ã‚¹ãƒ¯ã‚¤ãƒ— â†’ å‰ã®æ¤œæŸ»ã‚¿ãƒ–
            if (currentExamIndex > 0) {
              newExamIndex = currentExamIndex - 1;
            }
          } else {
            // å·¦ã‚¹ãƒ¯ã‚¤ãƒ— â†’ æ¬¡ã®æ¤œæŸ»ã‚¿ãƒ–
            if (currentExamIndex < examTabs.length - 1) {
              newExamIndex = currentExamIndex + 1;
            }
          }
          
          if (newExamIndex !== -1) {
            switchExamTab(examTabs[newExamIndex]);
          }
        }
      }
    }
  }
}

init();
</script>
</body>
</html>
